9fe278f41ba5c98c1d7550d65ee84f7109b38b2d	9fe278f41ba	2025-10-10	Louis Wicket (wil)	[FIX] voip: fix phone field margin when there is no flag

In the voip.call list view, when no flag is displayed, the phone number
is slightly offset to the right.

This is because the margin that separates the flag from the phone number
is still present.

This commit moves the margin from the phone number (always displayed) to
the flag (sometimes absent).

How to reproduce:
1. Make a call to an invalid phone number
2. Go to voip.call list view
3. Look at the numbers without a flag

closes odoo/enterprise#97054

X-original-commit: 75ce52865d46d2a7372ffceeac34c373b585e538
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

d788c3455d34829602f24ba94824d2bf5eda0d4b	d788c3455d3	2025-10-06	Louis Wicket (wil)	[IMP] voip: add Telnyx to the list of suggested providers

Task-5144121

closes odoo/enterprise#96439

Signed-off-by: Bruno Boi (boi) <boi@odoo.com>

e36e8f85ca42be7146336d4c6d7e9f128cb591cc	e36e8f85ca4	2025-09-30	Basioni (basm)	[IMP] voip, voip_ai: add recording and transcription icons.

Task-4962728

closes odoo/enterprise#96108

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

535a7aef3e410d997baa093cc111527814c29253	535a7aef3e4	2025-09-29	Basioni (basm)	[IMP] voip: enhance "Demo Mode" title in VoIP.

This commit enhance the UX of the "Demo Mode" title in softphone by
making it clickable and descriptive. When clicked, it leads to the
providers' list. A tooltip was added to the button as well.

Task-5108061

closes odoo/enterprise#95742

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0041043aafdbc0de74511b989cae745d0b9623ea	0041043aafd	2025-10-03	Louis Wicket (wil)	[IMP] voip: downmix recordings to mono for better storage

Task-5082457

closes odoo/enterprise#96453

X-original-commit: 401ac46fcfc989daaf85f0ea1bff2fd07d863f6d
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a9fe70b779354b8b54cf136859e8011442449e0d	a9fe70b7793	2025-09-30	Basioni (basm)	[IMP] voip: add internal link for call form view.

Task-4962728

closes odoo/enterprise#96113

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

64b82ad3aea568ed36759851a5a59a9a62091e0e	64b82ad3aea	2025-09-23	Louis Wicket (wil)	[IMP] voip: move session-related methods from UserAgent to Session

The original VoIP code was written under the assumption that there would
only ever be one session at a time. Consequently, much of the session
state was stored in a global object called the UserAgent.

However, Odoo 19 implemented an attended transfer in VoIP, creating
situations in which two sessions occur simultaneously. For this reason,
the asynchronous code should no longer update session properties stored
on the global UserAgent, as the session may have changed in the
meantime, which could lead to race conditions.

This commit moves some logic from the UserAgent to the Session, and
ensures all callbacks are properly mapped to the relevant session.

closes odoo/enterprise#96259

X-original-commit: 82d4a37eaa2531df98ef2640797ccf7be76be566
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b0047db6038977676762833dd8c765b66a4715de	b0047db6038	2025-09-10	Louis Wicket (wil)	[IMP] voip{,_onsip}: improve user preferences

Task-5075195

closes odoo/enterprise#94690

X-original-commit: d0d29dcf866b70e7aec5e5b75d6fc3d0eb1cd278
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

f0cc155e1617a5b678d06422330cd4bbcced8e3e	f0cc155e161	2025-09-09	Louis Wicket (wil)	[IMP] voip: Add visual indicator that VoIP is in demo mode

Task-5055883

closes odoo/enterprise#94537

X-original-commit: 66ddba4cc4ade081ab5f0bd2d48b99803d5f9373
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

f3fcfeff92b7af5490408b209d35524239ab23b9	f3fcfeff92b	2025-09-09	Louis Wicket (wil)	[IMP] voip: lint

X-original-commit: 99649ccb6e6b9aa2f48b285c33886966924e56dd
Part-of: odoo/enterprise#94537
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a06c02e8e163ed052c1c4d25a56bea9b6409abde	a06c02e8e16	2025-07-23	aath-odoo	[FIX] voip: prevent mobile keypad popup

Purpose:
When using the softphone keypad on mobile, pressing any key would automatically
trigger the native keyboard, creating a frustrating user experience and making it
tedious to dial numbers.

Specification:
Adjusted the behavior so that:
-The keyboard drawer still appears the first time the VoIP widget is opened.
-However, subsequent key presses on the softphone keypad no longer trigger
  the native keyboard.
-If the user wants to bring up the native keyboard (e.g., to enter letters), they
  can explicitly tap the top input field.

Task-4964776

closes odoo/enterprise#91762

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b61148ca7cf86ab9237e39e6304c889e612311e0	b61148ca7cf	2025-09-08	Basioni (basm)	[FIX] voip: rename userAgent.session to userAgent.activeSession in VoIP.

This commit renames the missing values of `userAgent.session` to be
`userAgent.activeSession`. This change was introduced in https://github.com/odoo/enterprise/pull/92315

closes odoo/enterprise#94086

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

d150beab39605034fcc7a849e3295cbef38fd924	d150beab396	2025-08-25	akpu-odoo	[FIX] voip:  remove should_auto_reject_incoming_calls functionality

Removed the unnecessary auto-reject incoming calls functionality, as standard
DND is already available.

Task - 5003485

closes odoo/enterprise#93079

Related: odoo/upgrade#8286
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

19c2521f3d9e33059c47065bbc7deae5766490d2	19c2521f3d9	2025-09-08	Louis Wicket (wil)	[IMP] voip_ai: improve demo data

- Add explicit create_date to avoid having all the calls created at the
  same time
- Remove useless country_id
- Pick fictitious phone numbers that will allow the unambiguous
  computation of the related country

Task-5059990

closes odoo/enterprise#94054

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

bcf7918ad8abfeba151fe8b1312f8b2791b03725	bcf7918ad8a	2025-09-04	Soumya M	[FIX] voip_ai: demo data partner reference

This commit removes unnecessarily added new partner references in demo data,
and sets country_id to US in voip call demo data.

Task-5059990

closes odoo/enterprise#93991

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

32a5273dcd15709534ff35704fac224320081b42	32a5273dcd1	2025-09-05	Louis Wicket (wil)	[IMP] voip: set bitrate of audio recordings to 8 kbps

This commit changes the bitrate of call recordings to 8 kbps. This
change is intended to reduce the file size. A higher bitrate is not
useful anyways, since most VoIP proivders use a similarly low bitrate.

closes odoo/enterprise#94022

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

4b24943e1f84be0964bc84d4154401a1feba7a56	4b24943e1f8	2025-08-13	Basioni (basm)	[IMP] voip: enhance VoIP transfer options.

This commit introduces several new options to the transfer feature that
already exists in VoIP. Those options are:
1. The user can choose between transferring the current call diretly to
   a chosen poterntial transferee or to ask them first (point 2).
2. The user is able to make another call to the potential transferee
   before making the transfer.
3. The user can switch between the two active call (the customer and the
   potential transferee) freely.
4. The user is able to terminate any call of the two calls while having
   the other one active.

Techincal changes to achieve the above options include:
- Introduced another session `transferSession` along with
   `defaultSession`. Both session are handeled through the getter/setter
`session` and through the `activeSession` attribute in the softphone
model.
- Changed several functions in the userAgent service and the
  call_model.js to handle both sessions smoothly.
- Changing the ContactInfo component props to accept a contact and a
   phoneNumber instead of a call object.
- Introducing a TransferConfirmation component that gives the user the
   options listed above.
- Introducing a CallBanner component that shows the other call when
   having two calls.
- filtered the potential transferee contacts not to have the current
  call contact.

Task-4866867

closes odoo/enterprise#92315

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

cf346d6c3b43af3493ac3313234296f5c99cf22e	cf346d6c3b4	2025-09-02	akpu-odoo	[IMP] voip: add no-content help for call and provider views

This commit adds no-content guides to improve usability.

Previously, there was no help message shown in the VoIP Call and
VoIP Provider views.

Task - 5058364

closes odoo/enterprise#93778

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

2cd0c7252fe5a98bb010d46bb32e48e0a4a7397e	2cd0c7252fe	2025-08-20	Louis Wicket (wil)	[IMP] voip: add call recording

Task-4417073

closes odoo/enterprise#93690

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

b31de6317d497398476dc44efb9c777078bc00ff	b31de6317d4	2025-08-20	Louis Wicket (wil)	[IMP] voip: lint code

Part-of: odoo/enterprise#93690
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

37945ca05fa80984c94a301bbe792dfc24d60fa7	37945ca05fa	2025-09-03	Andrzej(pian)	[FIX] voip_ai: ensure call creation order in test

Before this commit
in `test_cron_transcribe_recent_voip_call_two_calls_at_same_time` test,
we were attempting to have two calls one created after another.
However since the creating of the second (earlier) call was based on the
absolute date, when the setUp took longer then anticipated the order was
the opposite of the desired.

With this commit we ensure that the 2nd call will have create_date before 1st
by pushing it back from the 1st call create date (not with creation of the 1st call)

closes odoo/enterprise#93807

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

e15de641415ec8f9a33ea885c6c4a84afd7ceaed	e15de641415	2025-09-03	Louis Wicket (wil)	[IMP] voip: /voip/get_country_code has no reason to be public

Change the authentication method of the /voip/get_country_code route
from public to user.

closes odoo/enterprise#93788

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

f4ce2f5b28d63c14f833f6539b6f4938045ff8c1	f4ce2f5b28d	2025-09-01	Basioni (basm)	[IMP] voip: add successfuly tested providers' data in VoIP.

This commit makes working providers more discoverable for users and ease
the providers' configurations by adding those providers' data in VoIP be
default.

Task-4987919

closes odoo/enterprise#93596

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

ec9bcb28825457de9a9e0eb20a64fb6a73ce8769	ec9bcb28825	2025-08-28	Louis Wicket (wil)	[IMP] voip{,_ai}: introduce Session class

Introduce a Session class to hold the ever-growing amount of
session-related logic.

closes odoo/enterprise#93539

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

7e01454c15f492a55230e150b84c87c7ffb90275	7e01454c15f	2025-07-24	akpu-odoo	[IMP] voip: automatically focus softphone when opening softphone.

This commit ensures the VoIP softphone is automatically focused when opened
with keyborad shortcut.

Previously, the softphone would lose focus when opened with keyboard.

Task-4936059

closes odoo/enterprise#90881

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

94d28d0580837626dbc78eb4f928b460a43fbd78	94d28d05808	2025-08-07	aath-odoo	[IMP] voip: identify internal calls by extension

Purpose:
Improve the user experience by identifying internal calls made using extension
numbers (voip usernames) by displaying the corresponding user's name.

Specification:
Enhance the get_contact_info method in the voip.call model to resolve internal
extensions by matching the call's phone_number with the voip_username field
on res.users.

Task-4997542

closes odoo/enterprise#91998

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

626bce64b5f0f3695238a81e1d8799ee2e65a61b	626bce64b5f	2025-08-28	Romain Estievenart	[FIX] voip_crm: add groups on session info

Since the VoIP app use some groups at startup[1], it's made sense to
adds it inside the session_info bundle to avoid RPCs at webclient
startup.

[1]: https://github.com/odoo/enterprise/commit/9d3a13e9adae3a6b1c44b70a52b2fd74ef9dcc1a#diff-e8144e1aa7d3b4933985de5693d78e8c392bce8f7150ad186a04b8c87c7cd32aR14-R16

closes odoo/enterprise#93493

X-original-commit: 4f867f4549d2a21d2819b4169677ba1612330f7a
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

ee8b9d831aeb10a5d05d0cd7f0c6460f0a4d2a01	ee8b9d831ae	2025-08-26	Soumya M	[IMP] voip: harmonize call status

Aim of this commit is to harmonize call status messages in voip.call
and softphone history.

Task-4915054

closes odoo/enterprise#93394

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

acb4d13cddf9705533c1797eba0812175fb10f24	acb4d13cddf	2025-08-21	Andrzej(pian)	[IMP] voip_ai: Introduce backend tests

This commit introduces tests of "Backend Controller" and "Cron" parts of the following flow.

  Frontend
 ┌───────────────────┐
 │                   │
 │ Call Established  │
 │                   │
 │ Recorder Started  │
 │                   │
 │ Call Finished     │  ──────┐Recording File
 │                   │        │  & call id
 │ Recording Uploaded│        │
 └───────────────────┘        │
                              │
  Backend Controller          ▼
 ┌──────────────────────────────────┐
 │                                  │
 │ Checks file and access rights    │
 │                                  │
 │ Updates call transcription status│  Recording attached
 │                                  │    to a call  with
 │ Schedules cron                   │  pending transcription
 │                                  │ ────┐
 │                                  │     │
 └──────────────────────────────────┘     │
                                          │
  Cron                                    ▼
 ┌─────────────────────────────────────────┐
 │ Finds recent call                       │
 │                                         │
 │ Identifies related most recent recording│
 │                                         │
 │ Updates call transcription status       │
 │                                         │
 │ Requests transcription                  │
 │                                         │
 │ Updates call transcription txt          │
 └─────────────┬───────────────────────────┘
               │          ▲
         Audio ▼          │ Transcription
              ┌───────────┴─┐
              │External api │
              └─────────────┘

Note: the cron’s early `cr.commit()` is now skipped in test mode
(`modules.module.current_test`), so tests run in a single cursor/env
without `enter_registry_test_mode()` gymnastics. Production behavior is
unchanged: we still early-commit outside tests to persist the queued
status

Related task
task-4532108

closes odoo/enterprise#92954

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c05e71b2a6dd559eadd4b91167ff84672a4a4acf	c05e71b2a6d	2025-08-25	Andrzej(pian)	[IMP] voip_ai: Call from view shows transcription_status as a banner

Before this commit transcription_status was presented as a selection field
on the voip.call form view.

With this commit we move this information out of there and put it in a
banner that only shows up when transcription is in progress or in error.

related tasks
task-5026049

Part-of: odoo/enterprise#92954
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c4e3fe61a51dd22b3bf791c46691dc1d5eedf086	c4e3fe61a51	2025-08-25	Andrzej(pian)	[IMP] voip_ai: Added demo data

With this commit we have a demo call in all of the transcription_status
variations.

Related task
task-4532108

Part-of: odoo/enterprise#92954
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

15a604c0109b3e56319c0cff580e423700fb6cc6	15a604c0109	2025-08-25	Andrzej(pian)	[IMP] voip_ai: Generate and display call's transcript summary

This commit introduces the functionality to generate a one-liner summary
for VoIP call transcripts.

We also skip adding datetime to the generated transcript as it is no
longer required.

Part of the followup to the commit introducing transcriptions:
f96d1f4cc52c009a4f55cfaabf7b683bdf9e170d
[ADD] ai_voip: end-to-end post-call recording & transcription

Related to
task-4532108

Part-of: odoo/enterprise#92954
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

3638ea0aa2db34935549195f363fb41ee3f7e77d	3638ea0aa2d	2025-08-25	Andrzej(pian)	[FIX] voip_ai: Ensure correct transcription status with error handling

Previously, if a call transcription request failed due to an oversized file, the `RequestEntityTooLarge`
exception would cause the entire transaction to roll back.
This meant that any attempt to set the `transcription_status` to an error state (e.g., "too_big_to_process")
would be reverted, leaving the call in a "pending" state and obscuring the actual reason for failure.

With this commit we don't raise error anymore.
Instead an appropriate status code is returned as an response, this way transcription status persists
yet client is notified.

related task
task-4532108

Part-of: odoo/enterprise#92954
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

72f1aaa050f2e86ad576d7c0fe920cbbaabb3aac	72f1aaa050f	2025-08-28	Basioni (basm)	[FIX] voip_hr: fix voip_hr record rules.

This commit fixes the record rules that specifies the users that can
read phone calls made through VoIP. Currently, managers can only access
call records of their direct subordinates. They should have access also
to calls made by employees that are managed by their direct
subordinates. This commit fixes that.

Task-5033984

closes odoo/enterprise#93379

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

24d69fcbfcfa2805548424c2a3426fd8bf8ec183	24d69fcbfcf	2025-08-27	Basioni (basm)	[IMP] voip: add simple calendar view for voip call.

Task-5043948

closes odoo/enterprise#93267

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

2657a5aea5dd9e39d9a79709d780d1aafe5583c8	2657a5aea5d	2025-08-22	Basioni (basm)	[IMP] voip: remove provider_id and company_id from voip.call

Task-5034202

closes odoo/enterprise#92996

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

97ec439bfe387a6ca32cf55b05a3175768ce196c	97ec439bfe3	2025-08-20	Brieuc-brd	[IMP] voip, voip_ai: finetune call statuses

This commit refines the design of the call statuses to ensure
consistency across them.

task-5026907

closes odoo/enterprise#92743

Related: odoo/odoo#223557
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

4af225403e4bb6e5618d528a286d4c453a5859cb	4af225403e4	2025-08-08	Louis Wicket (wil)	[IMP] voip{,_ai}: move the recording logic out of voip_ai

The recording feature should be available even without AI installed.
This commit moves the recording client code into a dedicated service,
and polish the server side logic a bit.

Part of task-4417073.

closes odoo/enterprise#92296

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0db63705e363fd1d746d2364670e10fcc1c4a47d	0db63705e36	2025-08-08	Louis Wicket (wil)	[REF] voip_ai: remove useless directories

Part-of: odoo/enterprise#92296
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a35b8af24b51dc3f20f465d8e5b73b45a4f5c1e6	a35b8af24b5	2025-08-08	Louis Wicket (wil)	[REF] voip_ai: lint

Part-of: odoo/enterprise#92296
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0ccbddaf4934fff09db010d9c0f253d3fa9a2c84	0ccbddaf493	2025-08-08	Louis Wicket (wil)	[MOV] move ai_voip to voip_ai

So that all modules extending VoIP follow the same naming convention.
It also makes sense for the base module being extended to come first.

Part-of: odoo/enterprise#92296
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

aac266d886a74987eb3bfef8454d0cd31a2f7bb1	aac266d886a	2025-08-19	Louis Wicket (wil)	[IMP] voip: rename VoIP to Phone

Task-4987530

closes odoo/enterprise#92827

Related: odoo/odoo#223691
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

da12b3c97a29e8b94a55c5bf7aa96ae981870434	da12b3c97a2	2025-08-20	Louis Wicket (wil)	[IMP] voip: show recent calls first in voip.call list view

closes odoo/enterprise#92767

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

d911dfd6992ddfb9ed5512c51b4f14e15f881767	d911dfd6992	2025-07-24	akpu-odoo	[IMP] voip_crm: improve display logic of VoIP lead button.

Previously, the lead button always displayed 'Lead' as its title,
regardless of context.

With this change, the button title now adapts based on opportunity count —
showing 'Create Lead' or 'View Leads' appropriately.

Task-4938144

closes odoo/enterprise#91713

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

353d630e188b200d5dcb9d6519dfad479ad704e9	353d630e188	2025-08-19	Louis Wicket (wil)	[IMP] voip_sms: change wording to use "text message" instead of "SMS"

According to feedback, "SMS" is not a really common word in English.
"Text message" is more frequent.

closes odoo/enterprise#92681

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8b7c3f4d64f7585b2e7acc9eb7ed5c474253903b	8b7c3f4d64f	2025-08-19	akpu-odoo	[FIX] voip:  fix incorrect error message on voip softphone

Previously, the error message shown to fix setting in general setting.

After this commit, the error message shows the correct location of the PBX
server.

task-5022401

closes odoo/enterprise#92630

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

7e5da9b54e02c9b5a0c73b32dcee68d449ecd0ba	7e5da9b54e0	2025-07-04	Louis Wicket (wil)	[FIX] voip: avoid autofocus when typing

Before switching the focus back to the softphone after a call, make sure
the user isn't typing somewhere else. Only autofocus if the focus is not
on an editable element.

Task-4997513

closes odoo/enterprise#92043

X-original-commit: 6834f3acac16a753a75ab6e6a791ee8957e9cb59
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

df402bcdd9023157ee3661e453002bacb421384c	df402bcdd90	2025-08-05	Andrzej(pian)	[IMP] ai_voip: introduce per-provider transcription setting

Until now (after ref.1) call transcription was globally enabled by default
once the `ai_voip` module was installed. The only way to prevent
transcriptions (and sending data to external entities) was to uninstall
the module entirely.

This commit introduces a new `transcription_policy` field on the
`voip.provider`, allowing transcription to be explicitly disabled per
provider. Since providers are typically tied to specific regions, this
enhancement improves compliance control across geographies.

Planned followup:
---
Transcription policy selection field should be expanded with a "user"
option, that will allow users to decide if they want their individual
calls transcribed.

References
---
(ref.1)
f96d1f4cc52c009a4f55cfaabf7b683bdf9e170d
[ADD] ai_voip: end-to-end post-call recording & transcription

Related ticket
task-4532108

closes odoo/enterprise#91763

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

ec808436595b0884ea4f098f44976ee3bcbaddae	ec808436595	2025-08-07	Claire Nguyen (clan)	[IMP] voip: change app icon

This commit updates the voip png icon to the new one.

task-4987745

closes odoo/enterprise#91894

Related: odoo/odoo#222175
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

42356217ce25228adb1bb319d7ca3f0c20ce486f	42356217ce2	2025-08-07	Soumya M	[IMP] voip: Removed create button from call list view

Purpose:
Creating a new voip.call record from the backend should not be allowed.
Since it is a log of the calls that are taking place via the widget.

Specification:
Removed the option to create records from call list view.

Task-4988885

closes odoo/enterprise#91991

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

7045b6e7732a19ff61bc6013476356a6db09d2bf	7045b6e7732	2025-08-05	Louis Wicket (wil)	[FIX] voip: don't mix server and client values when computing time

It was reported that the timer for the call would sometimes start as a
negative number. Examining the code that computes it suggests that the
timestamp sent by the server was a few seconds in the future compared to
luxon.DateTime.now() (client time). This discrepancy is most likely due
to the clock skew between the client and the server.

This commit adapts the code so that it only computes time based on
client-side values, effectively preventing clock skew issues.

Task-4930666

closes odoo/enterprise#91951

X-original-commit: 35d9d55a2f0bf76b0ab4cf4f62cb7b3d0a07248c
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

d3c13ae01ebd61bea82bcfe05584d072abd0c63d	d3c13ae01eb	2025-08-05	yhu-odoo	[IMP] voip: do not allow editing dtmf result

The already sended DTMF signal can't be changed.
In this commit, we ignore the useSelection effect when sending DTMF,
user can only append new value to sended vulues.
we also make the input readonly so that user can only send DTMF from
the softphone keypad, since normally DTMF only support "123456789*0#"

closes odoo/enterprise#91739

X-original-commit: 50a5aeb5bc8eff42b05f56bb764eaefc169e38cb
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

4f63bdf29289b2d712758546607b57a677079095	4f63bdf2928	2025-07-30	Louis Wicket (wil)	[IMP] voip: improve handling of invite failures

If the PBX is not configured to use SRTP-DTLS, trying to invite a user
in Odoo would result in rather obscure errors:
- Chrome: Called with SDP without DTLS fingerprint
- Firefox: Invalid description, no fingerprint attribute at level 0

This commit gets rid of the traceback and shows a meaningful message
instead.

Task-4972773

closes odoo/enterprise#91454

Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

f96d1f4cc52c009a4f55cfaabf7b683bdf9e170d	f96d1f4cc52	2025-05-07	Andrzej(pian)	[ADD] ai_voip: end-to-end post-call recording & transcription

This commit makes the following flow possible:

  Call has been established
    ││
    │└───────► Capture data (#1)
    │┌──────── during the call
    ││
    ▼▼
  Call finished
    │
    ├─► Upload call data (as attachment)
    │
    ├─► Request asynchronous transcription
    │   │
    │   └─► Process transcripts with cron (#2)
    ▼
  Inspect transcript in the VoIP call form

1. Capture call data (frontend)
---
Introduces implementation to record SIP call audio
directly in the browser using the MediaRecorder and Web Audio APIs.

- Hooks into the SIP session state transitions (Established / Terminated) to start and stop recording.
- Mixes mic and remote audio using AudioContext (work around MediaRecorder’s single-stream limitation.
- Uploads .ogg file to /web/binary/upload_attachment at the end of the call

2. Processing attachments asynchronously
---
Crons are used to process the call attachments, by requesting
transcripts from OpenAI.

During development it was observed that oRFT stayed at the level of 0.3
That would mean that we need ~2 min to transcribe ~6min audio. To keep
UI snappy we only request transcription job and forget about it.

Crons run in the dedicated scheduler thread, so 2-3 min Whisper jobs do not occupy HTTP workers.

UI additions
---
- Added green “Post-call transcription on” badge in the in call view (of softphone)
	- Grey notice in demo mode
- New `Transcript` tab on the VoIP call form.

Other Remarks
---
- Raised transcript call timeout to 550 s (~30 min at oRTF 0.3)
- Fixed duplicate `/v1` in Whisper URL. (it was causing InvalidChunkLength when processing the response)
- Failed transcription jobs render attachments remained in the pending state for retrying

related task
task-4532108

closes odoo/enterprise#87645

Signed-off-by: Panagiotis Kyriakou (paky) <paky@odoo.com>

ad1a8d36b51a656ad973a0fbee1dca95ee490e6a	ad1a8d36b51	2025-07-14	Basioni (basm)	[IMP] *: add voip.call form view.

*: voip, voip_{ crm, helpdesk, hr_recruitment, sale_subscription }

This commit adds the form view of the voip.call model in VoIP
+ several enhancements to the VoIP call management system. Key
changes include:

- Updated the `voip.call` model to inherit from both `mail.thread`,
allowing the form view to have a chatter.
- Added new computed/related fields such as `calls_count`,
`image_1920`, and `avatar_128` to improve the information available
for each call.
- Enhanced the `write` method to update the partner's phone number
when the `partner_id` is changed.
- Introduced a new `CallStatusBadgeField` component to visually
represent call statuses in the UI.
- Added buttons for viewing related calls, opportunities, applications,
tickets, and subscriptions directly from the call form.

Task-4909097

Part-of: odoo/enterprise#89781
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

66c9a360c69d634b598f0bc507831bf0dde63c78	66c9a360c69	2025-07-30	Louis Wicket (wil)	[IMP] voip: don't show VoIP as the first app on the homepage

Change the sequence id of the VoIP root menu so that it doesn't show up
as the first app on the homepage.

The sequence number is set to 261 in order to put VoIP right after
WhatsApp, which is 260 at the time.

closes odoo/enterprise#91353

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c995b7df3fc6ff541dc65d8b28661ab03f4a8c08	c995b7df3fc	2025-07-16	Soumya M	[IMP] voip: show recent calls tab incase of missed calls

Purpose:
To open recent calls tab in softphone interface when there are missed calls.

Specification:
This commit updates the VoIP systray item behavior to ensure that,
when a user has missed calls, the softphone interface will automatically
switch to the "recent" calls tab.

Incase of an ignored incoming call, the softphone will now
switch to the "recent" tab instead of the "dialer".

Task-4917354

closes odoo/enterprise#90431

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

97ef9e0a21c8ca083b2b3f8ff38421f048c7ed4d	97ef9e0a21c	2025-07-07	yhu-odoo	[IMP] room,voip: adapt code for SharedWorker master tab election

odoo/odoo#218332 introduced a new master tab election mechanism.
Adapt enterprise code for it.

closes odoo/enterprise#89941

Community: odoo/odoo#218332
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

338feaa92b4d7a4b132e4236eb1e7d99b004de3b	338feaa92b4	2025-07-30	Louis Wicket (wil)	[FIX] voip: remove unused kwarg

"state" is no longer accepted as a kwarg of create_and_format, resulting
in a crash when provided.

This commit removes a leftover occurrence of the "state" kwarg.

closes odoo/enterprise#91359

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8ea26c3823143fd54c223cc290ec1591941e95b9	8ea26c38231	2025-07-28	aath-odoo	[IMP] voip: improve input field visibility

Purpose
The main input field in the keypad widget was visually unclear, leading to
confusion. Users often clicked near the field without realizing it, as there
was no visible cursor or indication of focus. This change aims to make the
input area more obvious and user-friendly.

Specification
-Added a placeholder text ("Type a name or number") to the input field.
-Added a border-bottom to the .o-voip-Keypad-searchBar container to visibly
  frame the input area.
-Added border highlight to the input container when the user is typing or input
  is focused.

Task-4922706

closes odoo/enterprise#90390

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8f368d9a49df1dcf9530d0d7e73eae9437da94f6	8f368d9a49d	2025-07-28	yhu-odoo	[IMP] voip: clean session when call end

Instead of clean session in every function that can end a call, it's
better that we do it when call model state is changed.

closes odoo/enterprise#91280

X-original-commit: bd87444b2eb0925b9599fdecbb18bb272673c739
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

777ebe3918aacdfe3f09078f542e2a784f72a67f	777ebe3918a	2025-07-24	Basioni (basm)	[IMP] voip_{ crm, hr }: adapt security groups in voip_ bridge modules.

This commit improves the use of security groups in the bridge modules:
`voip_hr` and `voip_crm` to use specific groups from `crm` and `hr`
modules.

Instead of using `base.group_user`, I used `group_sale_salesman` for
`crm` and `group_hr_user` for `hr`. This way the rules are more tailored
to the real use of `crm` and `hr`.

see also: https://github.com/odoo/enterprise/pull/75445

closes odoo/enterprise#90897

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

12072238db47ec8fe6e3708193e5962107569337	12072238db4	2025-07-09	Basioni (basm)	[IMP] voip: integrate search bar component across softphone tabs

This commit adds an expand button to the recent calls tab in the voip
wizard so that the user can open the full list view of the recent calls.
Also, it adds some predefined filters to the `voip.call` views.

Also, it introduces a new `SearchBar` component to enhance the user
experience in the softphone interface. The search bar is now included in
the address book, agenda, history, and keypad tabs, allowing users to
filter entries more efficiently.

Additionally, the `onInputSearch` functionality has been debounced in the
agenda to improve performance during searches. The history tab now
features an expandable button for viewing recent calls, further
streamlining navigation.

Task-4642428
Task-4791182

closes odoo/enterprise#84981

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

382be1ef889cc6c16a1eb0bc8eab5ad0db82e9a1	382be1ef889	2025-05-08	Basioni (basm)	[IMP] voip: enhance call management/reporting and logs.

This commit introduces several improvements to the VoIP
module, including the addition of a new button for viewing
call history in user settings and the implementation of
a detailed call view with enhanced data fields such as
duration, day of the week, and time slot. The call model
now computes the duration and time slot based on the start
date, and the user interface has been updated to include new
menu items for better navigation. Additionally, tests have
been added to ensure the correct computation of time slots
during different seasons.

Task-3695951

Part-of: odoo/enterprise#84981
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c40032b1d2aeffc8b6c174984a0b2c10b62eb5ce	c40032b1d2a	2025-07-16	akpu-odoo	[IMP] voip: add hotkey and command palette entry for VoIP Softphone.

This commit adds a data hotkey and command palette entry for toggling the
VoIP Softphone.

Previously, there was no shortcut or command to toggle the VoIP Softphone.

Task-4936059

closes odoo/enterprise#90389

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

9343bae5615021eefe6b36ed329034d33303d0a4	9343bae5615	2025-07-18	Basioni (basm)	[FIX] voip: fix incmoing calls error in `create_and_format`

This commit fixes an error that arises on incoming call because the
front end tries to create data with the attribute `state` which is not
defined in the called method `create_and_format`. This commit adds this
attribute with "calling" state in `create_and_format`.

closes odoo/enterprise#90495

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

9ddd3c7586855ca5bdd22d073be276011018f5a8	9ddd3c75868	2025-06-03	Didier (did)	[IMP] whatsapp,voip,*: introduce res.partner and mail.guest model

* test_whatsapp, voip_hr_recruitment

This PR removes the `persona_model` and introduce {res_partner|mail_guest}_model
to be closer of the python part.

task-4675821

closes odoo/enterprise#88014

Related: odoo/odoo#214943
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

8a8845ef23bd6ef43e21f96bf4e1f1a184ef1433	8a8845ef23b	2025-07-11	Kevin Gerard (kege)	[IMP] mail,*: Make Store in mock server more generic

*: calendar, hr_holidays, im_livechat, rating, website,
website_livechat, website_slides, approvals, voip, whatsapp

The goal of this commit is to make the Store in the mock server more
like the actual store.

This allows to add generic models without _to_store methods to be added
to the store as well as allowing to follow more the same structure as
the actual server.

It adds support for:
- _to_store_defaults method on models
- _to_store now uses the current model
- add method was split and we can now use _add_records_field like in the
actual server
- Store.attr, Store.one, Store.many can now support lists, and other
Store.attr inherited object

task-4789853

closes odoo/enterprise#90046

Related: odoo/odoo#218376
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

5d7d89a064fb90033b11b76f9a96bd257fa843d1	5d7d89a064f	2024-03-06	Thibault Delavallée	[PERF] voip: avoid useless bus notifications when modifying activities

Try to avoid useless bus notifications, especially at write time.
Check we effectively have to send them depending on activities
modified.

Task-3777606

X-original-commit: e09fa3d7821bdc9559f307b369ba4a9250b75ef0
Part-of: odoo/enterprise#90235
Related: odoo/odoo#219005
Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>

70213090dfbb0b6177aedf79dd027bf9fcb3deee	70213090dfb	2025-07-14	Louis Wicket (wil)	[IMP] voip: handle error messages as plain text

To display line breaks in error messages, voip.triggerError replaced the
\n with a `<br>` tag. This required taking some precautions to avoid
making the error message an XSS vector.

Rather than using `<br>` tags—and therefore promoting the error message
to dangerous HTML—we now use the CSS property "white-space: pre-line",
which preserves line breaks in text nodes.

closes odoo/enterprise#90139

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

7ba74fe45c256c8bd6cd1d84632e810b3eedc512	7ba74fe45c2	2025-07-10	Louis Wicket (wil)	[FIX] voip: replace "minus" icon with "minimize" icon

Following feedback from the designers.

closes odoo/enterprise#90009

X-original-commit: 339aec8e9a22c897c340855551d1c78f3bb080f8
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a3aed8e81fc04abbfd6ddfcb7e444efdd2a4512d	a3aed8e81fc	2025-06-30	Brieuc-brd	[FIX] voip: adapt layouts on small screens

This commits fixes minor layout issues:
- It adapts some views that had no scroll bar when the viewport was
small. This prevented access to part of content.
- It revises some spacing and alignment on small screens.
- It defines small transfer buttons in "outline" style to maintain
consistency with the others tabs.

task-4908502

closes odoo/enterprise#90000

X-original-commit: b15b97c850e17affd2bff8dd7246ee992cdb2edd
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

91e983b7db22be94347a27c01b836a7ed9138535	91e983b7db2	2025-06-24	Louis Wicket (wil)	[FIX] voip: correctly parse HTML in error messages

`<br>` tags in VoIP error messages are rendered as text. This is because
the code uses t-esc instead of t-out, and t-esc never renders inner
HTML.

This commit just replace t-esc with the proper t-out directive.

closes odoo/enterprise#89978

X-original-commit: 26282aeaa1250eeab22fa6e95d0f4cbec2387811
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

da1bd473698c7ded0372681ec4405c20c68be55c	da1bd473698	2025-07-07	Louis Wicket (wil)	[FIX] voip: properly sanitize phone numbers

Add parentheses to the list of characters that are stripped from phone
numbers.

Part of task-4891947.

closes odoo/enterprise#89754

X-original-commit: 4c209abc03dc7103fb51f749817b1a0c8d353603
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0f4f82267ec8007cb799042eaf6a475a199e5171	0f4f82267ec	2025-07-04	Louis Wicket (wil)	[FIX] voip: replace cross icon with a minus icon

The "cross icon" (X) is believed to be too "scary"; people don't dare to
click it in the middle of a call out of fear of hanging up, even though the
softphone window might be in their way.

The "minus icon" (-) might deceive one's expectations by hiding the
window rather than minimizing it, but we decided that it was still
better this way.

Part of task-4891947.

closes odoo/enterprise#89691

X-original-commit: fa59bb332f73b0fab50c88cb0ed6701e6459f71b
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

35df1a695b42311cdcda4c425b4c22521abb1d21	35df1a695b4	2025-07-08	Sébastien Theys	[REF] voip: clean up markup usage

Use markup template and html functions to make the code cleaner and
safer while no longer triggering ci/security flag.

closes odoo/enterprise#88754

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

49568889c51d60b7c8f71968766fef2663822a31	49568889c51	2025-06-27	Sébastien Theys	[FIX] mail_enterprise, *: define Store bus_target

* = approvals, knowledge, l10n_mx_edi, voip, website_helpdesk_livechat,
  whatsapp

Enterprise counter-part.

closes odoo/enterprise#89650

X-original-commit: 5317987b8566e4ab7d375f617801255e5e02058d
Related: odoo/odoo#217745
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

88b8de95e1a28a8037a386fc8fb6a044a98217e7	88b8de95e1a	2025-05-08	Basioni (basm)	[IMP] voip: enhance access control/access rights.

- Introduced new user groups for VoIP officers and  administrators
with specific access rights to calls and providers.
- Updated access rules to restrict CRUD operations based on company
affiliation.
- Added demo data for testing user access rights.

This commit improves the overall security and usability of the VoIP
module, ensuring that users can only access relevant data based on their
roles and company associations.

Task-3695951

closes odoo/enterprise#75445

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

057a649d5ffee0e59fe6a6c2486eb17887c4529b	057a649d5ff	2025-07-01	Basioni (basm)	[FIX] voip: fix cursor displacement in keypad input on mobile.

This commit fixes a bug that caused the cursor in the keypad input to be
displaced when typing on mobile. So, the first entered number was always
to the end. This happens because the `on-touchend` event was calling
another event (click) which may involve some changes in the UI that
caused this.

Steps to produce the bug:
1. Open VoIP wizard from mobile.
2. try to add numbers to the keypad.
3. You will see that the first number is always at the end.

closes odoo/enterprise#89232

X-original-commit: 668467678312632b5b9ecf234280690151bf3078
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

5e5c108280940bada9fea1d8a5006ac2d936e699	5e5c1082809	2025-07-01	Basioni (basm)	[REF] voip: refactor keypad search tests.

This commit splits the "search for name" test into smaller tests for
clarity and readability. It also removes the use of `edit` in tests and
uses `insertText` instead in order for the tests to be deterministic.
This test was introduced in: https://github.com/odoo/enterprise/pull/87328

closes odoo/enterprise#89201

X-original-commit: 8491c9d3e66274d27cad58434c0de38a57d06161
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

d5244e597ba8bd038a522ae7eb22a81caadee735	d5244e597ba	2025-06-10	Basioni (basm)	[IMP] voip, voip_crm: add "Leads" button to VoIP.

This commit adds a button that connects the contacts to its leads via
the VoIP module. It uses the same logic as "Applicant" button introduced
before.

Task-4855484

closes odoo/enterprise#89173

X-original-commit: ea2d733df97033a20d69e5e89f694fc252d28702
Related: odoo/odoo#216947
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

1f6220bef6432a1ff0edd112306c22aa06906606	1f6220bef64	2025-06-25	Basioni (basm)	[IMP] voip, voip hr_recruitment: rename `applicant-xpathTarget`

This commit renames all xpath targets that has the suffix
`applicant-xpathTarget` to remove `applicant` from it. This is because
there are modules other than `voip_hr_recruitment` that use that xpath
target.

X-original-commit: 798db990396cc3a18f3749b3f58f7f5dea32375a
Part-of: odoo/enterprise#89173
Related: odoo/odoo#216947
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

1278d2157958c40c928bd5fa0f6dd7bbc327a60c	1278d215795	2025-06-24	yhu-odoo	[IMP] voip: show DND state text on voip header

Show the Do Not Disturb state text on the voip header

Task-4891947

closes odoo/enterprise#88877

X-original-commit: 130a0f422443b6a5516468d76a4ab7e6beb201c7
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

a8392223532e12871565c7d239ddc713c0110199	a8392223532	2025-06-18	assh-odoo	[FIX] voip: prevent error in voip config if no phonecall activity type exists

Currently, an error occurs when the system initializes the voip configuration
for the currently logged-in internal user.

Steps to Reproduce:

 - Install the voip module.
 - Delete the activity type where the Action is 'Phonecall', and then
   refresh the page.

IndexError: tuple index out of range.

This error occurs when the system initializes the voip configuration and no
phonecall activity type exists. The system attempts to search for activity
types with the 'phonecall' category, which returns an empty recordset.
Then it tries to access the first record of this empty recordset[1], which
raises an error.

[1] https://github.com/odoo/enterprise/blob/2896974e9eda61bfe5e1d67423dc56f6ab17b2af/voip/models/res_users.py#L128

This commit ensures that if activity type with the 'phonecall' category
is present, it store the activity type id, otherwise, it stores False
as the activity type id.

sentry-6689050392

closes odoo/enterprise#88876

X-original-commit: 4c4253c0ec3d1e8f11677fe18d73f0d015f5569e
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Ashutosh Sharma (assh) <assh@odoo.com>

ac47e46160c4f9603926a0dd02c2530a03b783f8	ac47e46160c	2025-06-26	Louis Wicket (wil)	[IMP] voip: improve handling of markups

Make the most of the newly introduced HTML helpers in the VoIP code.

closes odoo/enterprise#88676

Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

8666dc7206f4d25ab2dca2abc8d4db5ee47aa182	8666dc7206f	2025-06-24	Louis Wicket (wil)	[FIX] voip: resolve non-blocking errors on click

UI-wise, there are two types of VoIP errors: blocking and non-blocking.
Blocking errors are unrecoverable, they're displayed at the top of the
UI and prevent further use of the softphone. Non-blocking errors, on the
other hand, can be dismissed by a simple click on the error screen.

Problem: the handler that hides the error screen in case of non-blocking
errors wasn't attached to anything, and even if it was, its
implementation was wrong! This commit makes it work as intended.

Part of task-4891947

closes odoo/enterprise#88437

X-original-commit: fa284901468911108210c9d4a5a6934188bbcc6d
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

91739e631bed9552eba308edd013b105b2dcbeb8	91739e631be	2025-06-24	Sébastien Theys	[REF] ai, stock_barcode, voip: allow separator in htmlJoin

Enterprise counter-part.

closes odoo/enterprise#88120

Related: odoo/odoo#215145
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

c192fc6be5e0b808c57819f2ed08ac28ec8e5123	c192fc6be5e	2025-06-20	Sébastien Theys	[REF] ai, voip, website_helpdesk_livechat: move html utils to web

Enterprise counter-part.

Part-of: odoo/enterprise#88120
Related: odoo/odoo#215145
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

08558c50389558ef0426ffa859fa644a7681e43a	08558c50389	2025-06-17	Basioni (basm)	[IMP] voip: change ui style of transfer button in VoIP.

This commit changes the style of the transfer button in the transfer
view to be solid instead of outlined.

closes odoo/enterprise#88056

X-original-commit: a584eb1050032c09fde79dc7757cc6e1ff6f9c23
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

f8aaf2699bcdd87c7304291669b2f731278b3e16	f8aaf2699bc	2025-06-17	Brieuc-brd	[FIX] voip: adapt transfer shortcut and back button design

This commit fixes the alignment of the "back" button of the transfer
view.
It also removes the label from small "Transfer" buttons to remain
consistent with the other buttons of the same type.

task-4875960

closes odoo/enterprise#87962

X-original-commit: 2666b475869dfbda0fd2b63bc64120a22802a0fc
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

3468cb0d7dc8c8a774f3843a5adcaf6673b3b6a5	3468cb0d7dc	2025-06-16	Sébastien Theys	[REF] voip, whatsapp: move isInternalUser to user model

Enterprise counter-part.

Part of task-3208257

closes odoo/enterprise#87524

Related: odoo/odoo#214021
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

98affd09558112082b5d6cfcbfa6c9d7d87107d3	98affd09558	2025-06-12	Basioni (basm)	[FIX] voip: handle contacts with falsy/undefined name.

An error was arising when making the following steps:
1. create a company contact with a proper name.
2. create an invoice address for that company through the company form
   view.
3. set a phone number for the invoice.
4. leave the `name` empty.
5. open the contacts tab on VoIP.

This happened because the code was trying to access the first
charachater of a falsy string which is `voipName` in this case. A
solution to this was to guard falsy names of contacts and add a section
for contacts with empty string. This section will have a title of "#"
and will appear at the end of the list.

closes odoo/enterprise#87675

X-original-commit: e98cc48b0725dd9bb1308317010e5e3cadab4847
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

568d29af1e1d792642f0dc288d57871fc7781f38	568d29af1e1	2025-05-09	Louis Wicket (wil)	[IMP] voip: put back Transfer feature

Task-4417102

closes odoo/enterprise#87639

Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

3c3a300460a40a33514aeb8a9c81c8bcc0dd5a6f	3c3a300460a	2025-06-10	Basioni (basm)	[FIX] voip: fix falsy `t9_name` when the partner name is `False`.

This commit fixes a bug that happens when the partner name is a falsy
value like a `" "`. This made the `t9_name` to be `false` and then to
give an error when trying to access the `trim()` function.

A solution for this was to guard it with a condition to check if the
t9_name is falsy or not.

Reproduction steps of the bug:
1. Create a contact where their name is a space (`" "`).
2. Include a phone number for this contact.
3. Open the VoIP wizard then the keypad tab.
4. try to search for that contact using the keypad numbers.
5. you will get the error saying that `trim()` is not a function.

closes odoo/enterprise#87560

X-original-commit: 614b509b79ab36cdc4c4aa6bf2404fc4ed91e952
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

b3969caf2b6ee4466712b280885135f6073dda38	b3969caf2b6	2025-06-04	Basioni (basm)	[FIX] voip: fix keypad stuck in `in call view`.

In VoIP, the keypad state wasn't updated after the user hangs up with
the other part. So, when making a new call, the keypad appears again
with its last state in the previous call. This commit fixes this by
reseting the keypad state everytime the user makes a call.

Task-4848365

closes odoo/enterprise#87453

X-original-commit: bf77c8c3c7c1003a0755fbd67c6c41fe2e9a91ff
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

282ed9ee9bfd8753ac0946ab5645ea94be3c842e	282ed9ee9bf	2025-05-22	Louis Wicket (wil)	[FIX] voip: fix ill-formatted format specifier

closes odoo/enterprise#86567

X-original-commit: 44d987a14d07da5506dd65e4af08410be1737021
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

1b26180dfb709e4d0f7645e14bdca85cd3fc1794	1b26180dfb7	2025-05-15	Basioni (basm)	[FIX] voip: update call status icons for better user feedback.

This commit modifies the icons displayed in the softphone interface to
provide clearer feedback on call status. Now, when the ongoing call is
on hold, the user will see a pause icon in the top bar and the systray
item.

closes odoo/enterprise#86542

X-original-commit: 44ba5ced9e5f62e494baf2e353f8d9f919423238
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

cae7a95e2837aa9ff6b08f038d78421ddf96d516	cae7a95e283	2025-05-19	Basioni (basm)	[REF] voip: rename `startDate` into `start_date`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

closes odoo/enterprise#85887

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

efb9f4ea0d7628a8e7ca0f09f58e9256d8d9faed	efb9f4ea0d7	2025-05-19	Basioni (basm)	[REF] voip, voip_sms : rename `phoneNumber` into `phone_number`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

Part-of: odoo/enterprise#85887
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

d33f2ef934062fa8b37a7cbfab7f1da00fc27b6e	d33f2ef9340	2025-05-20	Basioni (basm)	[REF] voip, voip_{ hr_recruitment, sms }: rename `partner` into `partner_id`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

Part-of: odoo/enterprise#85887
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

1b6b84293d8a62656a8725ff82a3530a093db681	1b6b84293d8	2025-05-19	Basioni (basm)	[REF] voip: rename `endDate` into `end_date`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

Part-of: odoo/enterprise#85887
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

09c31deb8240052c3f4f8ad66543a394c0798533	09c31deb824	2025-05-19	Basioni (basm)	[REF] voip: rename `displayName` into `display_name`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

Part-of: odoo/enterprise#85887
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

cf2ac0c1c1ff83e9c787d49ac63bda03ec5feb04	cf2ac0c1c1f	2025-05-19	Basioni (basm)	[REF] voip: rename `creationDate` into `create_date`.

The discuss team maintaining the `Store` code is getting rid of the
`rename` feature. So, this commit updates the code of the VoIP JS models
to use the same naming convention as the python code.

Task-4801651

Part-of: odoo/enterprise#85887
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

3bb82be6539a1e32a0f46ba53cffd69b01dfc4bd	3bb82be6539	2025-05-22	Louis Wicket (wil)	[FIX] voip: send keep-alives to avoid silent disconnection

PR #64267 implemented a reconnection mechanism, but it is only triggered
when the WebSocket close event is fired. In practice, we noticed that
the WebSocket would sometimes silently lose connection. When this
happens, one should just send data through the WebSocket to refresh it.

This commit enables SIP.js keep-alive feature, hopefully reducing the
number of disconnections, or at least preventing them to go unnoticed.

closes odoo/enterprise#86365

X-original-commit: 26b8521b45b6c6abbcf0e35fd47948e27f7cd868
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

62d8bfaad77a6d5cc4e7b381c09016bd52d3b4f0	62d8bfaad77	2025-05-22	Louis Wicket (wil)	[IMP] voip: move i18n helpers from voip to web

closes odoo/enterprise#86232

Related: odoo/odoo#211279
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

200a3a255f68333cef884aee9e5d42ca66e01c2e	200a3a255f6	2025-05-19	Alexandre Kühn	[FIX] voip: no crash on activity rescheduling call activities (2)

Before this commit, when re-scheduling a call activity to a date
of today or older, it raised the following error:

```
Caused by: TypeError: Cannot read properties of undefined (reading 'avatarUrl')
at ActivityListPopoverItem.template
```

This happens because in this specific case of change of call activity
deadline date, the VOIP softphone code is fetching activity data of
today faster than odoo views, thanks to relying on bus notification,
whereas odoo views and chatter rely on mostly on returned RPCs.
The code of VOIP returns activity data with a custom formatter,
which omits `persona` that is important for the good templating
of an activity in Chatter otherwise there's the crash above.

A recent PR [1] attempted to fix this issue, but the syntax for
Store was wrong: it used the syntax for an item in field
list (e.g. in `_to_store_defaults`) instead of pure store data
from a specific record. This bad use of Store.One() resulted in
actually returning `False`.

[1]: https://github.com/odoo/enterprise/pull/84970

opw-4586756

closes odoo/enterprise#86122

X-original-commit: 53548694f8db1ed1095bf62a8a1aef90bbd3e2a6
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

56601bd4a332caeaa9caf99da8ef2b1d45eb009f	56601bd4a33	2025-05-05	Brieuc-brd	[IMP] voip: review softphone tabs UI

This commit refines the softphone tabs UI for a cleaner and more modern
look.

task-4768693

closes odoo/enterprise#85702

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

aae9421704b66407b98cf086bbb979d7b692c9bf	aae9421704b	2025-05-05	Louis Wicket (wil)	[FIX] voip: correct handler for ontouchend

The touchend event must be preventDefault-ed to prevent zooming on
double-tab on mobile. However, the touchend handler was incorrectly set
to this.props.onClickKey, which doesn't exist.

This commit updates the code to trigger a click event on touchend so
that the same handler is used whether the button is tapped or clicked,
preventing similar situations where the click handler is updated but not
the touchend handler, leaving the latter broken.

closes odoo/enterprise#84740

X-original-commit: c3e809a807a3704e8e418f6232a7e1cfb9e8c3e1
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

79bb50a489be862c3f835af9884d0a960a201fdd	79bb50a489b	2025-05-15	Basioni (basm)	[IMP] voip: enhance keypad input font size dynamically

This commit adds a new method to dynamically adjust the input font size
based on the length of the input value in the softphone keypad.

closes odoo/enterprise#86010

X-original-commit: c2fc0c4a83903d67a51d259627e340eda59c1fef
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

7755d9be848de0ce186483875674006c4b369898	7755d9be848	2025-05-16	Basioni (basm)	[IMP] voip: remove useless space in the caleeSuggestions tab

This commit removes the useless big space between the entered phone
number and the list of suggestions in the calee suggestions tab.

closes odoo/enterprise#85820

X-original-commit: 8b349404a60162a4bde9b44d3493ef0f4aee8af5
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

2ab340151b612023e842836c2714e40b47791e2c	2ab340151b6	2025-05-09	Louis Wicket (wil)	[FIX] voip: hide transfer button

The feature is not implemented yet. Don't show buttons that aren't
mapped to anything.

closes odoo/enterprise#85313

X-original-commit: 1b99cb2f23eb93a196f5a06223cf14b6b3112f37
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

3f99a9c0e16a66551bd4233300c70c1f76563202	3f99a9c0e16	2025-05-09	Louis Wicket (wil)	[IMP] voip: expand ligatures before converting names to T9

Expand ligatures (IJ, œ, æ...) to their constituent letters, so that
they can be converted to T9.

closes odoo/enterprise#85206

X-original-commit: 60b2cbc7ce275f04f61ef515ac7308ade53dc527
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

2e9713e0c06f161f30a453d7a4ab829ec8da90d7	2e9713e0c06	2025-05-08	Alexandre Kühn	[FIX] voip: no crash on activity rescheduling call activities

Before this commit, when rescheduling call activities, this
could lead to the following crash:

```
Caused by: TypeError: Cannot read properties of undefined (reading 'avatarUrl')
at ActivityListPopoverItem.template
```

This error state that the activity has no related persona
in order to its avatar in the popover.
The persona data must be returned with activity data, and this
is a required field therefore any activity should necessarily have
a persona in their data.

The reason of crash comes from voip method `_format_call_activities`
that returns custom activity data that do not pass `persona`.
This commit fixes the issue by passing `persona` data like in the
usual `_to_store` of activity.

The crash occurs since https://github.com/odoo/odoo/pull/190161

opw-4586756

closes odoo/enterprise#85209

X-original-commit: 15af95c483951f305b9aa6990e0985e75b0d549a
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

139890c427e1b0890e89ff0037e20631efac07c7	139890c427e	2025-04-29	Louis Wicket (wil)	[IMP] voip: allow digits in t9_name

Prior to this commit, digits in a partner name would be converted to an
x, preventing you from searching for digits in a T9 name search.

After this commit, the digits remain as they are, so they can be
searched for in a T9 name search.

closes odoo/enterprise#84905

X-original-commit: 410d5a824a1909a9413f68b331ca437a6cb10d43
Signed-off-by: Nicolas Seinlet (nse) <nse@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

68f8381524c6bd4db544680139968ed592d058db	68f8381524c	2025-05-07	Louis Wicket (wil)	[IMP] voip: remove useless trigram index

The trigram index on res.partner/t9_name is not useful. The "t9
encoding" reduces the set of possible trigrams far too much for the
trigram to be effective in discriminating between large amounts of
results.

In consideration of the above, this commit removes the trigram index.

closes odoo/enterprise#85049

X-original-commit: 9afe2828fbd41b1de83cae19f8b6f86207c7b4b8
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a3dc3e89803404be1d7efaa7cd0f20716182bdfe	a3dc3e89803	2025-05-05	Brieuc-brd	[IMP] voip: adapt keypad colors for pending calls

part of task-4642428

closes odoo/enterprise#84904

X-original-commit: 4f35c1c862cfb6b42953c52d2f18c931f2954fee
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

83f5b4dcc36a6abb7b551bea96349a4d71418d43	83f5b4dcc36	2025-04-30	Louis Wicket (wil)	[IMP] voip: introduce keypad to send DTMF in call

part of task-4642428

X-original-commit: 3f8285899c110f1be9d945eea70c0959a5f368fe
Part-of: odoo/enterprise#84904
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

e2f63ce67047706ea02fa8d9c740cb27a376156d	e2f63ce6704	2025-04-29	Louis Wicket (wil)	[FIX] voip: fix failing DND selector test

"Do not disturb selector changes state correctly with limited time" is
failing with this error:

```
9. [toBe] Failed to find 1 of "p" with text "Until Jan 1, 2025, 1:15 AM" (Timeout of 3 seconds). Found 0 instead.
> Expected: true
> Received: false
```

Depending on the environment, it seems that the time is sometimes
formatted with a nonbreaking space before the AM, and sometimes not.
This is likely the reason for the failure.

This commit adapts the test in order to exclude the problematic space
from the selector.

closes odoo/enterprise#84433

X-original-commit: d19c3a750f912bf8fb10a91f968c9634b94f33fa
Signed-off-by: Aaron Bohy (aab) <aab@odoo.com>

de6b9cfea874426e70e540a4a27d9a1f16bf5439	de6b9cfea87	2025-04-25	Louis Wicket (wil)	[FIX] voip: fix dropdown race conditions

According to f02e8173ef0b73ff4f3933fe8296c9c98c0d57ea, tests can click
on a dropdown before its click handler is set (because it is set in a
useEffect), causing tests to fail undeterministically if they are too
fast.

This commit adds an extra step to prevent the dropdown from being
clicked too early in VoIP tests.

closes odoo/enterprise#84254

X-original-commit: 1e4d2629edc919245a4cfa9386ee037d0207dc9a
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

76b223904926d9458c3a711ee13998f287c1a56e	76b22390492	2025-04-22	Louis Wicket (wil)	[IMP] voip: display callee suggestions

Display Callee Suggestions
==========================
The dialer's "Show More" button - which appears when your search returns
more than one result - can now be clicked and open a list of all the
results, grouped by whether they match the contact's name or phone
number.

Separate Dialer from Keypad
===========================
The "keypad" part of the Dialer component is extracted into its own
component, as it will be reused in the upcoming Transfer view.

Improve i18n support
====================
Normalization helpers needed by the match function are added. These are
more complete than the ones in web/ and are based, among other things,
on the list of characters handled by PostgreSQL's unaccent function. At
some point it'd be nice to move the helpers to web.

Part of task-4642428

X-original-commit: 637c7ea983dbf34d1c9341cad11162f69c3a33d0
Part-of: odoo/enterprise#84254
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

091c82530abb665d2cb22d494e0bb2bbfaa2e9ac	091c82530ab	2025-04-25	Basioni (basm)	[FIX] voip: fix viewing incorrect caller in VoIP.

This is a fix for a bug that happens from time to time. It was reported
more than once that another user was viewed as a caller instead of
the actual caller.

This happened because when someone calls from a local number, they have
a `0` at the beginning of their number. For that case, we use a wildcard
that matches anything that the phone number is a suffix to. So, it
happened that it matched more than one number when the calling local
number is a suffix to more than one international number. Then, the code
just picks the first one randomly, which may be incorrect.

This commit fixes this bug by removing the logic of using a wildcard when
the call is made through a local number. Instead, we use an exact match.

Task-4707543

closes odoo/enterprise#84367

X-original-commit: d683e53b6f158dcda002317e9b60fb305646a7d6
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Mohammed Basioni (basm) <basm@odoo.com>

dccad6da0af9a6ea8c2197012c4199b3381bf4a2	dccad6da0af	2025-04-25	Louis Wicket (wil)	[IMP] voip: rewrite domains with Domain

odoo.osv is on its way to being deprecated. This commit replaces its
usage with Domain, along with rewriting some domains with the new super
cool syntax.

closes odoo/enterprise#84138

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

38c1311a707252e2c745a41f9e20b92837ddff82	38c1311a707	2025-04-24	Basioni (basm)	[IMP] voip: add no-search-results buttons.

In voip, you may search for different things through different tabs. For
example, you may search for recent calls in the recent tab, or for
specific contacts in the contacts tab. When there is not matching
result, there should be a button that guides you to a some page that may
be relevant to your search. For example, if you can't find a specific
contact in the contacts tab, you may have a button to direct you to
create that contact as it seems like you don't have it on your list.

This commit introduces those guide button on the following tabs:
`contacts`, `recent_calls`, and `activities`.

closes odoo/enterprise#84028

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

9953f334ded2db0c7fbffadf404e0ad8c1918d70	9953f334ded	2025-04-24	Louis Wicket (wil)	[IMP] voip{,_hr_applicant}: filter out forbidden records from activities

If an activity is created for a record that the responsible user does
not have access to, trying to fetch "today's activities" would result in
an access error.

This commit adapts the get_today_call_activities code to filter out
activities associated with a record that the current user does not have
access to.

closes odoo/enterprise#84039

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

e1ecc127c276d182ac084c6344fcbd0daee63537	e1ecc127c27	2025-04-23	Basioni (basm)	[IMP] voip: remove "calling" notification.

This commit removes the "calling" notification that appears when a call
is initiated. It turns out that it's useless and not needed anymore.

closes odoo/enterprise#83919

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0b98200d68d6f6a1bf474f96cbfd9babef0a1a0c	0b98200d68d	2025-04-22	Louis Wicket (wil)	[FIX] voip_hr_recruitment: load contacts without hr.applicant access

Before this commit, the code unconditionnally reads and sends
hr.applicant records linked to a VoIP contact, leading to a crash in
case the current user doesn't have access to hr.applicant records.

After this commit, applicant data are only sent if the user has access
to hr.applicant.

closes odoo/enterprise#83844

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

383e3a8aecc8bacdfdc3301647f3ac953062d043	383e3a8aecc	2025-04-22	Basioni (basm)	[REF] voip: remove `browser` from voip.

In the past, all browser function/objects were used through the
`browser` object. Now, the only property that you need to use through
`browser` is `location`. For everything else you can use global
functions/objects by calling them directly.

closes odoo/enterprise#83796

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

fa6656437deb4119b0b82fe909f01bca251da7fc	fa6656437de	2025-04-23	Basioni (basm)	[FIX] voip: fix missing getter for contact.

The incoming invitation interface didn't display contact button althought the caller is already in the contacts. Also, after accepting a call from a caller that is in the contact, a button "Add contact" was dispalyed. This happened because the template was trying to retrieve a `contact` variable but there was not getter implemented for this variable.

closes odoo/enterprise#83640

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c8c83c158b08f63b34358d72da24da810410e1ec	c8c83c158b0	2025-04-22	Louis Wicket (wil)	[FIX] voip: block timers in test and wait for bus notifications

Restore b9853be51a16d800b9b131a8c59c6c92a22c9552, inadvertently reverted
during refactoring.

closes odoo/enterprise#83801

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b06899f7c8254f24b1e6b089949e4294f9fc8b8c	b06899f7c82	2025-04-18	Brieuc-brd	[FIX] voip: adjusts softphone height

Since the redesign of VOIP in commit
52b3065993c41c6b7c65dda586a66fdd865b3afd, the height of the softphone
component wasn't responsive.
This could prevent access to the entire layout if the viewport was too
small.

This commit adjusts the height of softphone to suit the viewport.

task-4413793

closes odoo/enterprise#83679

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

9ba9b1056e9a80346798caf148fa65dc26494dd9	9ba9b1056e9	2025-04-16	Louis Wicket (wil)	[MOV] voip: rename UserInfo to ContactInfo

ContactInfo is believed to be more in line with the terminology in use
in VoIP, and less confusing than "UserInfo" since "user" in the context
of Odoo refers to another concept entirely.

closes odoo/enterprise#83544

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b004d0e954f2d024b483668c576cbe1b65a96e1a	b004d0e954f	2025-04-16	Louis Wicket (wil)	[IMP] voip: merge CallView into UserInfo

CallView was introduced to avoid code duplication between
CallInvitation, InCallView, and CallSummary, which have some data in
common.

The concept of CallView is no longer useful since the part that is
shared is fully encompassed by the UserInfo component that was added
later. This commit merges the two to keep only one component.

Part-of: odoo/enterprise#83544
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

60d69b5884c68b023389094212871d1de9fe7d76	60d69b5884c	2025-04-16	Louis Wicket (wil)	[FIX] voip_hr_recruitment: traceback on incoming call

The patch of CallInvitation components was not done correctly and failed
to redefine the original list of child components. As a result, Owl
couldn't find the definitions of ActionButton and UserInfo and would
crash when trying to render the CallInvitation.

Part-of: odoo/enterprise#83544
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

52b3065993c41c6b7c65dda586a66fdd865b3afd	52b3065993c	2025-04-16	Louis Wicket (wil)	[REF] VoIP revamp

This commit introduces a complete rewrite of the Odoo Softphone UI.

## Model changes:
- The computed field "t9_name" is added to res.partner to allow efficient searching by "[T9 code](https://en.wikipedia.org/wiki/T9_(predictive_text))".
- The computed field "country_code_from_phone" is added to res.partner, mail.activity and voip.phone. It computes the ISO country code corresponding to the country contained in their phone number field.

## Bridge modules:
- Introduction of the voip_sms bridge module, adding a button to the VoIP softphone to send SMS if both voip and sms are installed.
- Introduction of the voip_hr_recruitment bridge module, adding a button to open the form view of applicants linked to a VoIP contact.

Task-4642428

closes odoo/enterprise#81257

Community: https://github.com/odoo/odoo/pull/202558
Related: odoo/odoo#202558
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Co-authored-by: Basioni (basm) <basm@odoo.com>
Co-authored-by: Brieuc-brd <brd@odoo.com>
Co-authored-by: Louis Wicket (wil) <wil@odoo.com>
Co-authored-by: yhu-odoo <yhu@odoo.com>

6e728fdd9e630998d03a10553f3843e3c2dfad74	6e728fdd9e6	2025-04-02	Julien Mougenot	[FIX] voip: fix tests taking too long

This commit fixes a couple of unit tests in the VOIP addon which
performed `advanceTime` calls with huge time leaps (e.g. 24h), which
triggered a whole lot of `heartbeat` calls from the "multi_tab" service.

This caused long needless CPU locks that may crash these tests.

To fix this issue, this commit adds some `blockTimers: true` options
to the `advanceTime` calls to prevent more timers to be added during the
time leaps, and thus speeding up the tests to only take the time they
actually need.

Additionally, these tests were not properly awaiting changes made on the
"res.users.settings" model when setting "Do not disturb" values,
resulting in non-deterministic failures. This has been fixed as well, by
properly awaiting changes on the model before proceeding.

Part-of: odoo/enterprise#82734
Related: odoo/odoo#204471
Signed-off-by: Michaël Mattiello (mcm) <mcm@odoo.com>

5791eda6d0e551da929e08a700173744855d5075	5791eda6d0e	2025-03-14	Pierre Paridans	[IMP] voip: removes unused CSS animation

This commit removes the unused `o-voip-SystrayItem-vibrateAnimation` CSS
animation and also removes the `vibrate` animation as it is an unknown
CSS animation-name.

Reference:
- https://developer.mozilla.org/en-US/docs/Web/CSS/animation

closes odoo/enterprise#81593

Signed-off-by: Romain Estievenart (res) <res@odoo.com>

3f59cba608655b097781f2387727d589de61fc66	3f59cba6086	2025-03-20	Basioni (basm)	[FIX] voip: fix loading flags from all pages.

When opening the VoIP interface from any page other than the home page,
it doesn't show the flag as the uri for the flag was relative. This
commit fixes that by changing the relative uri (`base/...) to an
absolute uri.

closes odoo/enterprise#81866

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

3b5d0089e37b329b435983847854922a7acecc61	3b5d0089e37	2025-03-13	Louis Wicket (wil)	[FIX] voip: remove extra OR from get_contacts domain

PR #75203 removed the mobile field, and so updated search domains that
used it in VoIP, but the corresponding ORs weren't correctly cleaned up,
breaking the search.

This commit gets rid of the obsolete ORs.

closes odoo/enterprise#81458

X-original-commit: 354568e22787e9b0c1153085086b9ca0bca69c9c
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

50b539e00bace8306063b1df2e9eddac8568ae7f	50b539e00ba	2025-03-12	Louis Wicket (wil)	[FIX] voip: VoIP systray item must respect DND status

Adapt the condition in VoIP systray item code so that it takes into
account the Do Not Disturb (DND) status and doesn't play the ringtone
when it shouldn't.

closes odoo/enterprise#81283

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b06b249b16981a8947e942921c8fcb3db1c29921	b06b249b169	2025-01-08	yhu-odoo	[IMP] voip: Add Do Not Disturb mode

Add Do Not Disturb mode to VoIp. When user in DND mode, incoming calls
won't ring.

Task-4398564

closes odoo/enterprise#76799

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

4e588dfbe8141c730dea146ef408ba3667b99d56	4e588dfbe81	2025-03-06	Basioni (basm)	[IMP] voip: add a shortcut button to the providers' list.

This commit adds a button next to the providers' dropdown menu in the
users' settings/preferences to lead to the providers' list view.

Task-4416699

closes odoo/enterprise#80448

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

4c7dabd6710138f017c26e399454f680f88741a9	4c7dabd6710	2025-03-05	yhu-odoo	[FIX] voip: clean code related to `mobile` field

Field `mobile` has been removed from `res.partner`. Clean the code
related to it in voip.

Task-4624455

closes odoo/enterprise#80915

X-original-commit: 788415867c851a8593131939b03dad3b11ac88f3
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

1086888a07efd6876950d116a154c17e1ab2f781	1086888a07e	2025-03-04	Louis Wicket (wil)	[IMP] voip: lint numpad.js

closes odoo/enterprise#77271

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

86d121782c260179fd25e3c871aa473bc4da758a	86d121782c2	2025-01-16	Basioni (basm)	[IMP] voip: improve keypad and add countries' flags.

This commit improves the keypad of the VoIP modules through two main
features:
- Adds the flag of the country of the number the user types.
- Improves the style of numbers on the numpad to have a modern look.

Task-4416929

Part-of: odoo/enterprise#77271
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

441dbdd1c03d1801fa0d157427d2b7da3c314210	441dbdd1c03	2025-02-27	yhu-odoo	[FIX] voip: missing "user_id" in _to_store_defaults

After fff2083, by default we don't provide the user_id of mail.activity
for Store. However, in voip, we need user_id to filter activities for
current user:
https://github.com/odoo/enterprise/blob/60137cdea6412278ce9b94852926f09d61e9cb38/voip/static/src/softphone/softphone_model.js#L38
To fix, add this field in _to_store_defaults for voip.

closes odoo/enterprise#80351

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8242e3d718e155464b80714902f380334948722e	8242e3d718e	2025-02-10	Basioni (basm)	[FIX] voip: change `landlineNumber` field name and fix related issues.

This commit fixes the naming of the `landlineNumber` field. Previously,
this field was referred to as the `phone` field. This commit changes
its name to `phoneNumber`. Also, we had a `mobile` field that was
removed in this PR: https://github.com/odoo/odoo/pull/189739 and it
resulted in a bug in the `mobileNumber` getter in
`correspondence_details.js` as it was retrieving a `phoneNumber`
attribute from the `partner` model. In contrast, it doesn't have
this attribute.

closes odoo/enterprise#78996

Related: odoo/odoo#197205
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

87ff0acb9fcc7c1b388333986fe9ef3b49108368	87ff0acb9fc	2024-12-19	Basioni (basm)	[IMP] voip: add "In call" status and close options.

1. When you close the VoIP widget while you are in a call, it won't hang up
   but there is nothing to show that you are still in a call. So, this
   commit solves this by adding an "In call" status next to the voip icon
   when you are in a call.
2. When someone is calling you and you are busy, you close the widget,
   the call will stop ringing and a small vibration is added to the voip
   icon to show that there's an incoming call.

Task-4398564
Subtask-4416855

closes odoo/enterprise#75869

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a00faee178b94e455a670fb59a3c77c3827b3b49	a00faee178b	2024-06-21	yhu-odoo	[IMP] voip: allow "infinite scrolling"

Implement "infinite scrolling" in recent calls/contacts tabs.

Task-3984680

closes odoo/enterprise#65596

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

55a80b7e2067624609e5cc6425599f0872099da2	55a80b7e206	2024-12-12	yhu-odoo	[FIX] voip: only play incoming ringtone on master tab

Currently when receiving incoming calls, it's possible that all opened
tabs will play the ringtone. To reduce the chaos, we now only play the
incoming ringtone on the master tab.

Task-4402909

closes odoo/enterprise#75637

X-original-commit: ab318282d9d852f1182a83cb62690e17ca65c363
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

5e702810241ad9c74e3b74f42c4974a0830e3e7a	5e702810241	2024-12-10	yhu-odoo	[FIX] voip: no input when click between buttons

Issue:
Clicking the space between buttons but no click on any buttons, a input
of "123456789*0#" will be generated.

Fix:
Do nothing when click in this situation, only generate input when
clicking on buttons.

closes odoo/enterprise#75576

X-original-commit: 4c97a1a1ea80e499f76c471a0447d99c17d24275
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

55e56f54c5868ec73042602faae0607af58c6799	55e56f54c58	2024-09-04	saurabh	[IMP] voip: move missed call notifications in top icon

This commit will stop opening the softphone container for
showing missed calls count in topbar instead the missed
calls count will be shown in VoIP systray item icon badge.

closes https://github.com/odoo/enterprise/pull/69490
Task-3392951

closes odoo/enterprise#69490

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b65163a71a0ac1a9bad545ddb9ec0b80922021ee	b65163a71a0	2024-12-06	Sébastien Theys	[REF] mail_enterprise, *: clean Store, simplify _to_store and improve relation

* = approvals, documents, knowledge, voip, website_helpdesk_livechat, whatsapp

Enterprise counter-part.

closes odoo/enterprise#72312

Related: odoo/odoo#184344
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

fd5116b5cf159cd38c9915711971872bf217073c	fd5116b5cf1	2024-11-26	Sébastien Theys	[IMP] knowledge, voip: speed up test contains with focus or value

Enterprise counter-part.

closes odoo/enterprise#74605

Related: odoo/odoo#188638
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

53ff9d057477d55dc315765803e704a0749b1d08	53ff9d05747	2024-11-18	Xavier ALT	[FIX] voip: update neutralization

Since odoo/enterprise@4f162e7e1ea, the `voip.mode` ICP has been
replaced by `voip.provider`'s mode.

This commit update the neutralization script accordingly.

closes odoo/enterprise#74350

X-original-commit: 6f06ef259fc80148cafb32b2737af71afc1e72d7
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

7b8246793867d51ec428b85db67657c7cd5c17b9	7b824679386	2024-11-08	Thibault Francois	[FIX] voip: improve performance of _format_call_activities

Store the partner one by one is very costly.
Since all the partner return by _mail_get_partners
will end up in the store, we can store them all at once

This improve the time for get_today_call_activities
from 25000ms to around 700ms for one of the worse case
(thousands of partners to fetch)

closes odoo/enterprise#69132

X-original-commit: c2cc1570f217a520f7b47efdf09d522927587f1f
Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

d6f90825b3bcf4cf061c4822a0285f22e2382089	d6f90825b3b	2024-11-06	Adnan Saiyed	[IMP] voip_onsip, voip: convert qunit tests to hoot

Purpose of this commit is to convert remove QUnit tests
which rely on `mail/test_utils` to hoot.

Part of task-3818666

closes odoo/enterprise#73384

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

512d44ccee5a589ee62a0c0573bfead36e85d9aa	512d44ccee5	2024-10-01	Sébastien Theys	[REF] mail_enterprise, *: rename Activity JS to patch PY name

* = approvals, documents, sign, voip

Enterprise counter-part.

Part of task-3605717

Part-of: odoo/enterprise#71221
Related: odoo/odoo#182364
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

2d0b681847a3aaf87713d340c1e8ee69343b268c	2d0b681847a	2024-09-13	Louis Wicket (wil)	[FIX] voip: disable ringtones in tests

Patch the voip.ringtone service in all voip tests to avoid playing
ringtones while tests are running.

closes odoo/enterprise#70090

X-original-commit: 4193d7ccf2cf1cfd64d7079b251cb90b186293b7
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

de1a4ebde7d7429b6dbd602a0a0ede369049cee7	de1a4ebde7d	2024-08-20	Alexandre Kühn	[FIX] voip: adapt voip model with model fix

The voip model was overriding `static insert` method as if this
works on a single record. For some time, this method works on
multiple records, and its implementation detail has changed so
assuming it does `get() ?? new()` is no longer guaranteed.

The intent of override was to enrich data after them being assigned.
This has been converted to an override of `update()`, which
guarantees it being called whenever fields are updated on record,
without making too much assumption in implementation details of
records.

This commit also speeds up tests of VOIP, which were awaiting
input that contains a value. This is not observed by mutation
observer, so these tests took 3 seconds to execute. This PR puts the
value in `data-value`, so that this is a mutation that can be
observed by contains, thus reducting time of such test to mere dozens
of ms.

closes odoo/enterprise#68604

Related: odoo/odoo#177059
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

2c5a12d8ebbd46785accbcdd12a85dfaaa72806e	2c5a12d8ebb	2024-08-01	Sébastien Theys	[REF] bus, *: shortcut to send message to user via bus

* = account_online_synchronization, delivery_iot, l10n_uk_reports,
spreadsheet_edition, voip, website_helpdesk_livechat, whatsapp

Enterprise counter-part.

closes odoo/enterprise#67733

Related: odoo/odoo#175205
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

742d7c969569cf7057c6341551190849ba36e8b0	742d7c96956	2024-07-24	Thibault Francois	[FIX] voip: speed up call to _format_call_activities

We notice that get_today_call_activities is a very frequent call that
spend a lot of time runing sql queries.

during 1h30 it was called 20515 times for an average of 719ms of sql times
on odoo.com database.

It was cause by _format_call_activities
which can be called with many hundreds of activities

before this commit for each activity
_mail_get_partners and mail_partner_format were called once per
activity. It take 581s for all the internal user of odoo.com database

after this commit
the method _mail_get_partners and mail_partner_format are called for an
entire batch as it's intended. The same computation for internal user
takes now 84s

closes odoo/enterprise#67718

X-original-commit: b31cf7dec220a125adbb860bc89165d5eba35ec3
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Thibault Francois <tfr@odoo.com>

7995d248340edf2083880d37f1cd5c7c2d95b79f	7995d248340	2024-07-26	Sébastien Theys	[REF] mail_enterprise, *: add extra values to Store on records

* = approvals, voip, whatsapp

This allows to easily set extra values on records without having to
repeat the model name or the id in many different places.

Part of task-3605717

closes odoo/enterprise#67343

Related: odoo/odoo#174507
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5a71e4659695e2cb1fa1a9abec8b5acb4637f2b2	5a71e465969	2024-07-19	Sébastien Theys	[REF] mail_enterprise, *: introduce support for relations in Store data

* = knowledge, voip, whatsapp

And adapted the most simple cases.

Part of task-3605717

closes odoo/enterprise#66544

Related: odoo/odoo#172863
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

5e6d976d58f78b08844a7140dbd8de50567d628b	5e6d976d58f	2024-07-05	Sébastien Theys	[REF] voip: convert partner format to store

Part of task-3605717

Part-of: odoo/enterprise#65894
Related: odoo/odoo#171585
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

2ae7759618fa62a73e657d6e681117cd08f2109e	2ae7759618f	2024-06-24	Sébastien Theys	[REF] voip: flatten persona data in get_today_call_activities

Part of task-3605717

Part-of: odoo/enterprise#65411
Related: odoo/odoo#170709
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

f04ca25c6baab2ffc6e578b7cc7f08881c180050	f04ca25c6ba	2024-06-24	Sébastien Theys	[REF] voip: make get_today_call_activities store data ready

Part of task-3605717

Part-of: odoo/enterprise#65411
Related: odoo/odoo#170709
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

716f5216269b4b76de91883fd26d82e8ae3614ab	716f5216269	2024-06-18	yhu-odoo	[FIX] voip: fix test failure

"Switch audio input" test failed in an undeterminitic manner on this
line:
https://github.com/odoo/enterprise/blob/e808e583e9d406735a05dab42bf24f8b89899b67/voip/static/tests/softphone/device_selection_dialog.test.js#L54
After clicking the "Call" button, func `makeCall` has asynchronous call
before setTimeout:
https://github.com/odoo/enterprise/blob/e808e583e9d406735a05dab42bf24f8b89899b67/voip/static/src/core/user_agent_service.js#L268
https://github.com/odoo/enterprise/blob/e808e583e9d406735a05dab42bf24f8b89899b67/voip/static/src/core/user_agent_service.js#L284
It may happen that because of the asynchronous call, our
`advanceTime(5000)` is executed before we call `setTimeout` in `makeCall`.
To avoid this, we check the dom change to make sure the asynchronous call
has finished before we continue.

closes odoo/enterprise#65246

X-original-commit: 7065a4500e5351cc75323b2efc4a85ea0cf3a0e0
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

eabdad3f0c95c8f75ad7ca4c6ab694f498a2a5d9	eabdad3f0c9	2024-06-10	Louis Wicket (wil)	[FIX] voip: attempt to reconnect after WebSocket disconnection

Task-3610647

closes odoo/enterprise#65077

X-original-commit: d084861f3b8fe08a948e94952b747c9161a8ba8b
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

92c9d5bf36a2a22fc139db89b1abf4199a03245a	92c9d5bf36a	2024-06-10	dane@odoo.com	[FIX] voip: no crash on adding removed call activity

When call activity gets deleted or added, the related component has to
be re-rendered so that most uptodate information is shown, otherwise
this might lead to crash if those activities are accessed. To mitigate
the issue, component re-rendering is invoked when call activity gets
added or removed from the queue.
The activity removal happens when `delete_call_activity` function is
invoked directly, which crafts domain, to search the activies that are outdated.

Steps to reproduce:

- on crm lead schedule call activity and make sure that activity is old
- book activity and save it
- add it to Call Queue
- remove it from Call Queue
- try to access it/click on it

X-original-commit: 2ed3780ade29b0e1f404aca85dccf11f1dbb21a1

.

closes odoo/enterprise#64476

X-original-commit: edb5ea7c5ba8d80d5746aabd12e99f571e820c5b
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Dato Nefaridze (dane) <dane@odoo.com>

9bedb5999c06e7c49e4524c6218a48ddbac3df73	9bedb5999c0	2024-05-22	Louis Wicket (wil)	[IMP] voip: Include the version of Odoo in the UserAgent header

Include the version of Odoo in the UserAgent header of SIP requests so
that the information is available to the provider.

Task-3940569

closes odoo/enterprise#63509

X-original-commit: b89add4513af4e659d2b96b407cc7328603817b1
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a9821fae63c1fa24e996f0227c2bec03e6228468	a9821fae63c	2024-05-21	Xavier Luyckx (xlu)	[IMP] voip: center softphone Error Message (UI)

Prior to this commit, the VoIP error text was not properly centered
within the overlay div, and had dark-mode background color issues.

This commit restructures the code for improved maintainability, centers
the error text, updates a few classes and adapts the design for dark mode.

task-3539670

closes odoo/enterprise#63096

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

04aca233750952f1a9eff581fc22761087fee403	04aca233750	2024-05-29	Rahul Prajapati	[REF] voip: convert tests to hoot

This commit aims to convert QUnit tests which rely on mail/test_utils to hoot.

Part of task-3818666

closes odoo/enterprise#63499

X-original-commit: 61faf35a9656c63ed007033453435dcaaff58e34
Related: odoo/odoo#167341
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>
Signed-off-by: Rahul Prajapati (rapr) <rapr@odoo.com>

0e0969d97b7d37bea5a4814babf888d40807fc07	0e0969d97b7	2024-03-07	yhu-odoo	[IMP] voip: add Hold/Unhold button to voip

We finally have a button to hold/unhold during a call.

Task-3670392

closes odoo/enterprise#58249

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

edb951ae9664cce6522cd2feda831c6e6c42158d	edb951ae966	2024-05-13	Louis Wicket (wil)	[FIX] voip: search contact/activity/call onInput

When typing in the softphone's search bar, the search result doesn't
appear immediately; the user has to press Enter to make it happen. This
is because the input field uses the t-model directive with the trim
modifier. The trim modifier silently switches the directive to lazy
mode, meaning that the content of the field is updated whenever the
onchange event is fired instead of oninput.

This commit removes the trim modifier to fix the problem.

opw-3890028

closes odoo/enterprise#62747

X-original-commit: 1cab6b1aa9ca0aa3214992999e078447455b4824
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

e52e757e99fdf7998c8c508ca4000b46a5fddb37	e52e757e99f	2024-05-07	Louis Wicket (wil)	[FIX] voip: open record from correspondence details

Since the complete refactoring of the module in 17, the "open record"
button of the CorrespondenceDetails no longer works: Clicking it causes
the softphone to fold, but nothing more happens (the record is not
displayed as expected).

This is because we started retrieving the ORM service from the
useService hook, whereas before we used to retrieve it from the env.
useService untransparently wraps the ORM call in a "_protectMethod",
which drops the return value of an RPC if the component that made it has
been destroyed in the meantime. Since clicking the "open record" button
also folds the softphone, it destroyed the Correspondence Details
component, preventing it from ever receiving the RPC's return value.

This commit changes the way the ORM service is retrieved in order not to
use useService and to solve the problem.

opw-3904519

closes odoo/enterprise#62159

X-original-commit: 439b14957cf4282b18fcf1ed959a5467ada90a17
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

b7cd55da79ed2de1acf10caadfb8163f9ad310cf	b7cd55da79e	2024-04-24	Ryan Cen	[FIX] voip: add back customer info on calls

Functionality was removed during the refactor of the voip module between
16 and 17 where you could enter any number through the phone keypad on
voip or receive a call and have access to the information on the
customer with the associated phone number.

This was a functionality that the customer on the ticket was using
prior to upgrade.

I have added back this functionality through a non blocking call to a
new function in voip.call that will search up the contact based on the
phone number entered in the softphone. When the data comes back from the
back end the UI will be updated with the partner information if it found
it.

This also has a side effect of fixing the customer wizard button as
well.

opw-3770625

closes odoo/enterprise#62048

X-original-commit: 1dd49e09a6907767593af8a2ec72ec79917ba077
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

4f162e7e1ea152c7a5f7fa3e66351bf9effeeebf	4f162e7e1ea	2023-12-05	yhu-odoo	[IMP] voip, *: add support for multiple voip providers

* = test_discuss_full_enterprise, voip_onsip

Add the support for multiple voip providers.

Task-3130964

closes odoo/enterprise#55530

Related: odoo/upgrade#5615
Signed-off-by: Yuchen Huang (yhu) <yhu@odoo.com>

2a0cf55c3e67bd89fe736e3d43cd03dbdb313dca	2a0cf55c3e6	2024-04-09	yhu-odoo	[REF] voip{,_crm,_onsip}: remove useless attributes/comments

Remove:
1. Licence comments
2. utf-8 encoding attributes/comments
3. xml:space="preserve" attributes

closes odoo/enterprise#60317

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

636c4c62044ebfb7bd84b3be43d840d58b2564e0	636c4c62044	2024-03-08	Sébastien Theys	[REF] mail, *: tests: use serverState

* = account_accountant, approvals, documents, mail_enterprise, sign,
  voip, voip_onsip, website_helpdesk_livechat, whatsapp

In hoot, pyEnv current state was moved to a new object called
`serverState`. This commit prepares the tests to use this new object to
reduce the diff in the main PR.

closes odoo/enterprise#58350

Related: odoo/odoo#157058
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

307476d5f54c6c026bb716ae2a7ae57fb168b819	307476d5f54	2024-03-08	Sébastien Theys	[REF] voip: tests: rename pyEnv searchRead

The python method name is `search_read`. This was corrected in hoot,
this commit prepares the tests for the change by adapting the old one.

Part-of: odoo/enterprise#58350

1378f5e48ebc20bfce71b6f49e6c8754308c92b6	1378f5e48eb	2024-03-08	Louis Wicket (wil)	[IMP] voip: remove useless licence comments

closes odoo/enterprise#58336

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

4354a4ea1810837565b8c98cf016127bd687b7c7	4354a4ea181	2024-03-08	Louis Wicket (wil)	[IMP] voip: remove unused imports

Part-of: odoo/enterprise#58336

04b3af762e9afde361618707a0676a50ee67eb78	04b3af762e9	2024-03-08	Louis Wicket (wil)	[IMP] voip: make optional parameters explicit

"Implicit Optionals" are prohibited by PEP 484. This commit adapts VoIP
code to make them explicit.

Part-of: odoo/enterprise#58336

817e51e8e938d3e0855a2d2c8e4c2193d7a6fc01	817e51e8e93	2024-03-06	Sébastien Theys	[REF] mail_enterprise, *: tests: import openFormView

* = account_invoice_extract, account_online_synchronization, knowledge,
    test_mail_enterprise, voip, website_helpdesk_livechat, whatsapp

Rather than having to extract it from start on every test, we ca now
import it once at the top.

Part-of: odoo/enterprise#58170

fa12d843d041e22ff83a349ba2f0573e98946ad2	fa12d843d04	2024-03-05	Sébastien Theys	[REF] mail, *: tests: add missing await

* = knowledge, mrp_workorder, voip, website_helpdesk_livechat

In preparation of hoot convertion, let's ensure all tests properly await
their "open" functions.

Part-of: odoo/enterprise#58075

06f8dd25589c6d4a282d051453b6127411a6a40b	06f8dd25589	2024-02-27	Louis Wicket (wil)	[FIX] voip: call stuck in invitation view

Description:
============
If the execution of the code is abruptly interrupted during an incoming
call invitation (e.g. by closing the page), when the call is reopened in
the softphone, the correspondence details of the call get stuck in the
invitation view.

This commit prevents this from happening by also checking for the
presence of an actual session as a condition to display the call
invitation view.

How to reproduce:
=================
1. Configure a database with VoIP in production mode
2. Receive an incoming call invitation and refresh the page without
   accepting/rejecting it
3. Re-open the call and notice that it's stuck on the invitation view
   :((

Task-3770997

closes odoo/enterprise#57668

X-original-commit: 04b8d183a3b49d4e8fdaab9bf1797fab2d1351aa
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

9e31c992928fcbc5b9d1b3dac6b9e2cdbdd2f1d5	9e31c992928	2024-02-26	Louis Wicket (wil)	[FIX] voip: user is stuck in busy state after a missed call

When an incoming call is cancelled by the remote party, the current
session is not properly cleared, causing Odoo to reject all subsequent
calls, assuming the user is busy, since the previous session is still
present.

This commit fixes the problem by properly clearing the current session
when a CANCEL message is received.

closes odoo/enterprise#57626

X-original-commit: 7244a4cd9453fbc897db638cb638da914f4be236
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

59d7b430372cdfd5914dfac120b791a85063dd0a	59d7b430372	2024-02-22	Louis Wicket (wil)	[FIX] voip: no crash on transfer to another device

The forward-port of #54535 neglected to adapt the code it introduced to
the move of settings to its own model. Because of this oversight,
this.settings is undefined, and this.settings.external_device_number
would crash.

This commit adapts the code to properly retrieve the config, and adds a
test to make sure this never happens again.

opw-3743892

closes odoo/enterprise#57294

X-original-commit: 984c2d964594c36dd8d9ad909cadbacd5ba1e89f
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

13d95867e5d9a6d8edd61444d0516817d2299942	13d95867e5d	2023-12-06	yhu-odoo	[FIX] voip: make `how_to_call_on_mobile` editable on user.setting view

This commit makes `how_to_call_on_mobile` editable from the res.users
form.

Note: simply setting "readonly=0" resulted in a crash when no value is
provided for how_to_call_on_mobile, as it is a required field. Even
though it has a default value in res.users.settings, the value was not
properly forwarded to res.users. It turns out that related fields should
not be used with an inverse, causing all sort of odd behavior otherwise.
That's why this commit also replaces relateds with computes.

closes odoo/enterprise#57076

X-original-commit: 01fbdb03a1eeab56244d282f336f312d260c321f
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

05d64c79087878517269bf5f3fda64cd14b8b473	05d64c79087	2024-02-15	Louis Wicket (wil)	[IMP] voip: remove useless "@odoo-module" comments

.js files are now treated as odoo modules by default if they are under
/static/src or /static/tests.

This commit removes the now useless odoo module declarations from VoIP's
codebase.

closes odoo/enterprise#56709

References: https://github.com/odoo/odoo/pull/142858
Signed-off-by: Tiffany Chang (tic) <tic@odoo.com>

ffe2eb8a932bd38cff15c1722d1e2aa1bc473e5a	ffe2eb8a932	2024-01-19	Victor Piryns (pivi)	[PERF] voip: add missing indexes on `voip.call`

Description:
Add missing index on `user_id` and `partner_id` to support the searches
done in `get_recent_phone_calls` and `_get_number_of_missed_calls`.
In a long living database that is making heavy use of the module, the
table can grow to the millions of records.

closes odoo/enterprise#56312

X-original-commit: e9dac5c7dcf9afcb6f9094bba1e3ad92b27512ef
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Piryns Victor (pivi) <pivi@odoo.com>

6570a9735de62130b6451202fb33fac70a0e7901	6570a9735de	2024-01-03	yhu-odoo	[FIX] voip: avoid error when user's microphone access is denied

To reproduce:
1. Install and configure the VoIP module in prod mode
2. Place a call to anyone
3. Block the browser from accessing the microphone
Error: Invalid state transition from Terminated to Terminated

Fixed in https://github.com/onsip/SIP.js/commit/f06939c119149a3e00ad8acf69f37360d3331a62
Adapt it in old version.

Task-2810572

closes odoo/enterprise#56016

X-original-commit: dbc285f65b1e7c9a18ca662db1cc8211924ffafb
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8110ccc2519415b8586c8e83448dcd4624fada60	8110ccc2519	2024-01-16	kthe-odoo	[FIX] voip: fixed validation error while clicking on call button

- master
- 17.0

Steps to reproduce:

- Open Field Service / HR Employee Application
- Open any task / employee record
- Click on call button in mobile or phone field

Issue:

- Throws out a validation error to the user saying the mobile number
 which is a required field is not set

Cause:

- The Phone Widget Activity Patch which supplies the value of phone number from
the field in which the call button has been presses has an issue
- It gathers the field name in which phone widget is present and matches it to
mobile or phone and returns either of the values

Solution:

- The simple solution is to supply the mobile number based on the field it is
clicked rather than a fixed setup of supplying only mobile or phone values.

task-3678808

closes odoo/enterprise#56063

X-original-commit: e8ac43c204eaf09c03c54b7741511b0a3a6b12ab
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

70429cee1ebc6ab853ffa21ad89787554c0d069e	70429cee1eb	2024-02-06	Didier (did)	[IMP] sign,voip: rename activity props

PR community: https://github.com/odoo/odoo/pull/152303

closes odoo/enterprise#55945

Related: odoo/odoo#152303
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

40de0be0ac8bb9203d3caaa0ad4db808e0f39353	40de0be0ac8	2024-02-06	Louis (wil)	[IMP] voip: upgrade SIP.js library from 0.20.0 to 0.21.2

So that we can benefit from the latest bug fixes, including
onsip/SIP.js@f06939c, which we already had to backport[1] to prevent
crashes in stable versions of Odoo.

Changelogs: https://github.com/onsip/SIP.js/releases
[1]: https://github.com/odoo/enterprise/pull/53581

Task-3724836

closes odoo/enterprise#55933

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

cbad1e21e754b098a54f11be19422bbfcf638dcf	cbad1e21e75	2024-02-05	Louis (wil)	[FIX] voip: do not crash on cancelled call invitation

Sending a CANCEL request while a SIP session is being established will
result in a 487 Request Terminated response to the pending INVITE
request.

Prior to this commit, cancelling a SIP session would cause the session
to be deleted twice: once immediately after the CANCEL request was sent,
then a second time after the response to the INVITE request was
received, resulting in a crash the second time because the session had
already been deleted.

After this commit, 487 Request Terminated responses are ignored,
preventing the code from attempting to delete the already deleted
session and causing a crash.

opw-3702140

closes odoo/enterprise#55912

X-original-commit: 2efe0d24180e6e4afc2e95a95502b1eda859dba6
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

34678f588f72e2238de2d898d59db2ad3f5e055a	34678f588f7	2024-01-24	Sébastien Theys	[REF] mail_enterprise, *: move remaining values out of init messaging

* = documents, test_discuss_full_enterprise, voip,
    website_helpdesk_livechat

In attempt to remove the extra RPC made by `init_messaging` and extra
await on `isReady` in code, move easy data from init to session.

closes odoo/enterprise#54926

Related: odoo/odoo#150625
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

949fc8b752760b614bf17d493084921c5a4cee2a	949fc8b7527	2024-01-23	Sébastien Theys	[REF] mail, *: create common helper for building store data

* = documents, voip, website_helpdesk_livechat

As filling store data becomes a common pattern, the code will be more
manageable with a standard helper.

Part-of: odoo/enterprise#54926

ce95ee843f9d5c2ed6b622ed54c77757b8224722	ce95ee843f9	2024-01-17	Louis (wil)	[FIX] voip: sanitize number before calling makeURI

Sanitizes phone numbers before using them to build request URIs. This
will prevent failure whenever a phone number contains spaces.

Task-3689342.

closes odoo/enterprise#55046

X-original-commit: 1fe81a9da4680c9cb4e9104072a23099078ed511
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

05c3af0752358920ed5f6dc6bb986d444d4e70e0	05c3af07523	2024-01-22	Sébastien Theys	[IMP] mail, *: add systray activity to generic data route

* = account_accountant, documents, voip, web_studio

This will remove one RPC at every webclient startup.

closes odoo/enterprise#54801

Related: odoo/odoo#150367
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

1fc584408dc89abb96479a75dd7d25a405369991	1fc584408dc	2024-01-18	Sébastien Theys	[REF] mail_enterprise, *: add fetchData helper to group RPC calls

* = account_accountant, documents, voip, web_studio,
    website_helpdesk_livechat

In particular, init_messaging and failures are now done in a single RPC.

Time control tests have to be adapted to take into account the extra
delay that is introduced before fetching data.

Discuss action is made to render even if messaging is not initialized
in order to resolve the action promise, to know when to advance time.

The new async step helper is used to guarantee proper order between RPC.

closes odoo/enterprise#54575

Related: odoo/odoo#149860
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

1c4471f24be35cf97bf9e5cf1bc6e99219fbf150	1c4471f24be	2024-01-16	Sébastien Theys	[REF] mail, *: add data generic route

* = account_accountant, test_discuss_full_enterprise, voip, web_studio

The goal is to centralize the entry for all data, allowing to batch all
requests together.

Tests are adapted to check for params, as the route name itself becomes
insufficient.

closes odoo/enterprise#54496

Related: odoo/odoo#149712
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

76c74bcb33362e401a2725187c9b96b36eee1133	76c74bcb333	2024-01-17	Sébastien Theys	[REF] mail, *: fill store self (user) with data from session

* = approvals, voip, website_helpdesk_livechat

This will ease the transition to removing await dependency on
init_messaging, as the biggest remaining reason was to know the current
user.

closes odoo/enterprise#54509

Related: odoo/odoo#149561
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

0eb03c78b730fc6079fe64f70905ceef7830a00f	0eb03c78b73	2024-01-15	Louis (wil)	[FIX] voip, voip_onsip: properly set voip_onsip override

Follow-up of #53729.

With only VoIP installed, without voip_onsip, running the test would
result in a crash because onsip_auth_username doesn't exist on the
mocked model.

This commit fixes that by correctly adding onsip_auth_username only if
voip_onsip is installed.

closes odoo/enterprise#54290

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

6a0b4afd5c9db75fcd7f5b8dd58588b9f7a8007c	6a0b4afd5c9	2024-01-10	Sébastien Theys	[REF] mail_enterprise, *: move init messaging data inside Store

* = documents, test_discuss_full_enterprise, voip,
    website_helpdesk_livechat

closes odoo/enterprise#53934

Related: odoo/odoo#148549
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

39bec2573e2618ecd7fae38ffd8d129df654210d	39bec2573e2	2023-12-21	Xavier-Do	[IMP] timer, voip, make some call_kw readonly

closes odoo/enterprise#36587

Related: odoo/odoo#112000
Signed-off-by: Xavier Dollé (xdo) <xdo@odoo.com>

781c6fcd0b293280bed994e3a3eaa6e9bd884268	781c6fcd0b2	2024-01-05	Alexandre Kühn	[FIX] voip: adapt from settings becoming a discuss model

Follow-up of https://github.com/odoo/enterprise/pull/50720

PR above turned Settings into a model, to ease inserting data
from the server. To accomodate from this change, accessing to
settings has to go to `store`.

Some LOCs were not properly adapted, which this commit fixes.

closes odoo/enterprise#53729

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0876185b1e23ee3b10b624cd1ab989435a083b58	0876185b1e2	2023-12-06	yhu-odoo	[FIX] voip_onsip: settings undefined

Follow the change of odoo/odoo#141904
user.settings service is changed from service to record and is now in
mail.store service. Missing this change in voip_onsip.

closes odoo/enterprise#52242

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

89ef86962f0f78cf6e7ed1661fb5d7a3c594efeb	89ef86962f0	2024-01-04	tsm-odoo	[REF] *: remove notification event from the bus service

*: iot, pos_preparation_display, pos_restaurant_appointment,
spreadsheet_edition, voip.

closes odoo/enterprise#53496

Related: odoo/odoo#147747
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

2e8f18801156a8069e26fb3d61d4f8d84893e891	2e8f1880115	2023-11-21	yhu-odoo	[FIX] voip: cursor position ignored when click on numpad

Fixed the issue when click on the numpad (number or backspace), cursor
position is always ignored.

closes odoo/enterprise#51817

X-original-commit: 73b01fa5e1f56d4ab71d67760b15942fb2fa0e31
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

68d2b016bf16abfe48feef7a60b9e228a3154168	68d2b016bf1	2023-11-22	vevi-odoo	[FIX] voip: give valid domain format in search records in voip_call

This traceback arises when the user tries to call Recent.

To reproduce this issue:
1. Install 'VoIP'
2. Open Discuss/Softphone/Recent
3. Try to search for something in the Voip search bar

Error: ' ValueError: too many values to unpack (expected 3)'

When the user tries to search for something in the search bar an invalid domain
format is formed in 'get_recent_phone_call'method.
Which leads to the traceback from here

https://github.com/odoo/enterprise/blob/5c42708683905cfb5fe8c1005aabbbc9fb016fa2/voip/models/voip_call.py#L79-L85

After applying this commit will resolve the issue by giving a valid
domain format to search.

sentry-4644858097

closes odoo/enterprise#51358

X-original-commit: 981c224178b4331da4ff7b5db7a1e8bfb2d54eae
Signed-off-by: Adrien Widart (awt) <awt@odoo.com>

87fb7ff491f62de2d9e4ab5a2a216474fc718e74	87fb7ff491f	2023-10-24	Rémy Voet (ryv)	[REM] *: change due to removal of `unaccent` parameter

In the community branch, we remove the `unaccent` parameter from
`Field`. Then there are some changes to make in the enterprise:
- Remove `unaccent=False` from all `parent_path` fields.
- Since we remove `unaccent=False` from `phone` + `mobile` of
`res.partner`, we replace the `ilike` with `like` to have the same
behavior as before in `get_contacts` (voip module).

closes odoo/enterprise#49448

Related: odoo/odoo#139568
Signed-off-by: Raphael Collet <rco@odoo.com>

ed55923513cdaf52e6a8541b977c1f2de63ee499	ed55923513c	2023-10-27	Alexandre Kühn	[FIX] mail,*: markup chatbot livechat message

*: approvals, voip, whatsapp

Before this commit, messages in chatbot conversation were not
properly markup. This comes from changes from [1] that added
trusted insert. Original code in `Record.insert()` makes a model
insertion of the data using the `html` flag. Patches must not
override `static insert()` as only the super call is affected by
the provided `html` flag. For patches to take account of it, they
must instead patch `_insert`, with `_` prefix, which is internally
called by original `Record.insert()`.

In addition:
- `static insert` allows array of data while `static _insert` works
  with data on single record. Patches were designed with data on
  single record, so some code were not working properly
- Signature of `static insert` has been overloaded with new option
  `html: true`, so patches must propagate it. They were only
  propagating `data` and omitting the 2nd paramater, which results
  in omitting provided `html` thus falling back to `html: false`,
  resulting to non-escaping message body

This commit fixes all model patches to override `static _insert`
instead of `static insert`.

[1]: https://github.com/odoo/odoo/pull/139501

closes odoo/enterprise#49784

X-original-commit: 4c8e2b505e70076d34b576ff11a5c22a055e58a4
Related: odoo/odoo#140202
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

27a7a5245ad2e041048c12beebba2a18901f9d42	27a7a5245ad	2023-10-24	Louis (wil)	[FIX] voip: properly display calls in “calling” and “ongoing” states

If for some reason (e.g. a power outage in the middle of a call) the
call is never properly terminated, it may be stuck in the “calling” or
“ongoing” state.

Prior to this commit, trying to display a call that was stuck in the
wrong state would cause a crash.

After this commit, the call will be displayed correctly, even if it is
in an improper state.

closes odoo/enterprise#49465

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

ffcc2a11bde1a258cc4f4d68298964c3b96091c7	ffcc2a11bde	2023-10-19	Sébastien Theys	[FIX] voip: do not return calls at init for portal users

closes odoo/enterprise#49323

Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

bbdb033031720365c448c6f3de40906ee0c4243e	bbdb0330317	2023-08-17	Louis Wicket (wil)	[REF] voip: complete refactoring

The code of the VoIP module is getting quite old and has accumulated a
lot of technical debt over the years, making it very difficult if not
impossible to add new features and fix some bugs. An upgrade of the code
to our current coding standards is required prior to any further
improvements.

This commit rewrites the code to use the newest APIs. In particular, it
rewrites all the javascript code in a more declarative fashion, using
Owl components and services instead of the old widgets.

Task-2376357.

closes odoo/enterprise#38339

Related: odoo/upgrade#5021
Related: odoo/odoo#115689
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

01ce3c6f93bc1f39848bfaf39d6e6300adb3020b	01ce3c6f93b	2023-09-19	Louis Wicket (wil)	[FIX] voip: transfer popover improvements

+ Clears the contact suggestion list when the transfer popover is blank
+ Ensures that a value is always provided as a phone number
+ Refactoring

opw-3480011

closes odoo/enterprise#48224

X-original-commit: 2c404499eda1374916fe5c61411d08c15fda3c33
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a2057eae62283005812acefd3fffdcb428f3f0f7	a2057eae622	2023-09-26	Louis Wicket (wil)	[FIX] voip: fix partner search domain

Since https://github.com/odoo/odoo/pull/122085, display_name on
res.partner is no longer stored, and therefore can't be used in a search
domain.

This commit replaces occurrences of display_name in search domains with
complete_name, which is now the correct field to use.

Task-3518197

closes odoo/enterprise#47972

X-original-commit: 97336b71ab3031ce227c7a7a41e6090420c7c3b8
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b9d1e520cc6633e7d5fee17cfe962a8084c3891f	b9d1e520cc6	2023-09-19	Louis Wicket (wil)	[FIX] voip: restore incoming call after fold/unfold

Before this commit: if the dialing panel is folded while a call is
incoming, unfolding it afterwards would cause the call accept/reject
buttons to disappear, making it impossible to do anything but to wait
for the caller to hang up.

After this commit: folding then unfolding the panel doesn't break the
state.

opw-3090255

closes odoo/enterprise#47870

X-original-commit: 1bb69232e7ebbce79a7263a1f9248e665abd996c
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

31e686da7ec1b7d9eb6a9f3e7d7b93d5c0693544	31e686da7ec	2023-09-13	Sébastien Theys	[REF] mail, *: tests: refactor `contains` to further remove `jQuery`

* = account_accountant, account_invoice_extract,
    account_online_synchronization, approvals, crm_enterprise,
    documents, documents_spreadsheet, helpdesk, hr_gantt, knowledge,
    mail_enterprise, project_enterprise, sign, test_mail_enterprise,
    timesheet_grid, voip, web_enterprise, web_studio,
    website_helpdesk_livechat, whatsapp

Enterprise counter-part of community changes.

closes odoo/enterprise#47064

Related: odoo/odoo#134652
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

582165788cece2a28a76077f1085d00c5d110bf5	582165788ce	2023-09-04	Sébastien Theys	[REF] mail, *: tests: remove `afterNextRender`

* = account_online_synchronization, test_mail_enterprise, voip,
    web_studio

Follow up of https://github.com/odoo/odoo/pull/130451

`contains` is faster and functionally more significant.

closes odoo/enterprise#46739

Related: odoo/odoo#134025
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

33ebf000b3f951bfae7c098b4ff782062edb4416	33ebf000b3f	2023-08-31	Sébastien Theys	[REF] voip: tests: replace remaining jQuery text() occurrences

closes odoo/enterprise#46603

Related: odoo/odoo#133717
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

d99a615fbbc675a541502d5541a75ef60ed00cbc	d99a615fbbc	2023-08-31	Louis Wicket (wil)	[IMP] voip: only load SIP.js library for actual VoIP users

This commit creates a separate bundle for the SIP.js library and only
loads it when the current user can use VoIP (i.e. when they have VoIP
credentials).

closes odoo/enterprise#46649

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

1d2d937eafb70e6d06b4cea3f410bdd8b4cde3b9	1d2d937eafb	2023-08-18	Adrien Dieudonne	[REF] voip: replace BlockUI by using custom one

Note that you can now close the dial popup by clicking on the
close button located in the title.

Task ID: 3439226

closes odoo/enterprise#46166

Related: odoo/odoo#132295
Signed-off-by: Pierre Paridans (app) <app@odoo.com>

1c775ad78daeb3ae9801fdfcdf7101bf4440af83	1c775ad78da	2023-08-21	Sébastien Theys	[IMP] mail_enterprise,*:tests:use `contains` in `click`, `insertText`

* = account_online_synchronization, approvals, crm_enterprise,
    documents, knowledge, sign, test_discuss_full_enterprise,
    test_mail_enterprise, voip, website_helpdesk_livechat

`contains` is more efficient than `afterNextRender` as it does not wait
for several extra animation frames, and it is functionally more
meaningful.

closes odoo/enterprise#44999

Related: odoo/odoo#130451
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

8734e5ddb573a6fc21477ec13c55e054d66af3c9	8734e5ddb57	2023-08-17	Louis Wicket (wil)	[IMP] voip, voip_{crm,onsip}: format python code with Black

closes odoo/enterprise#45919

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

3169752dbf5943df41133af8b7b50c0d24a4dcce	3169752dbf5	2023-08-02	Aaron Bohy	[REF] *: use new formatters instead of legacy ones

*mrp_mps,mrp_workorder,voip

Part of task~3439226

Part-of: odoo/enterprise#45015

9591fca4d30d574db08e55a093066c8f3b1903e9	9591fca4d30	2023-08-01	Louis Wicket (wil)	[FIX] voip: restore missing class

Put a class on the softphone header icon to allow it to be retrieved
from the javascript code.

closes odoo/enterprise#45088

X-original-commit: e81e2487de5e65a458dcdd28a2d9514157cefbab
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

de3c60d4a052f13d91435e2697fc71ffbdcffa39	de3c60d4a05	2023-07-12	Thibault Delavallée	[REF] voip: simplify partner link on voip activities

Followup of community code improvements. Finding partner / customer on a given
record has been moved directly at model level in community, allowing to
cleanup and simplify some code. Finding partners is now a generic feature
once 'mail' is installed.

Task-3422449 (Mail, Phone: Move and improve field helpers)

Part-of: odoo/enterprise#45036

362dc29bf8b40ce1cd0f8ffe4c763e312d2e14e2	362dc29bf8b	2023-07-28	bara-odoo	[FIX] voip: call from mailing list contacts

when user clicks on call widget in mailing list contacts traceback will appear.

steps to produce:
1) install mass_mailing_sms and voip.
2) open one record and add mobile number.
3) click on mobile number.

Error: A traceback appears: "IndexError: list index out of range"

https://github.com/odoo/enterprise/blob/22992c1226268111ebf66f39214d8e15d0ede2e3/voip/models/voip_phonecall.py#L322
In the mailing.contact model, there is no field of type many2one with a
comodel name of res.partner. As a result, the partner_field_name returns an
empty list, and attempting to access the 0th element of an empty list is not
possible.

sentry-4306579710

closes odoo/enterprise#44807

X-original-commit: 37200401bdb1901a0abff895180945a657960576
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Bansi Ranpariya (bara) <bara@odoo.com>

89c915835acaf817b027ecd040997ab2ac35500d	89c915835ac	2023-07-26	tsm-odoo	[IMP] *: remove setup manager patches in test

*: documents, project_enterprise, timesheet_grid, voip, web_studio.

closes odoo/enterprise#44596

Related: odoo/odoo#129705
Signed-off-by: Matthieu Stockbauer (tsm) <tsm@odoo.com>

cba34344c55f59ad83f7ef351baab7bf2aa33d5d	cba34344c55	2023-07-26	Sébastien Theys	[REF] voip: move voip-reload-chatter to voip bus

Part of task-3265211

closes odoo/enterprise#44583

Related: odoo/odoo#129583
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

e590e17840612f7151a960148e5bb46783bb9ec9	e590e178406	2023-07-10	Louis Wicket (wil)	[REM] voip: remove useless sanitized_{phone,mobile} fields

Since phone numbers in `phone` and `mobile` fields are already sanitized by
the phone_validation module, there is no need to have the
`sanitized_phone` and `sanitized_mobile` fields.

Part of task-2832241

closes odoo/enterprise#27525

Related: odoo/upgrade#3530
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

f33831d964f58e812cf93f17c974fb42bf96bebb	f33831d964f	2023-07-04	Elisabeth Dickinson	[IMP] voip: realign phone icons in buttons

task-
part of task-3326263

closes odoo/enterprise#44285

X-original-commit: 64296aca0a414d562a6032249bc3058541324c2a
Signed-off-by: Bouvy Damien (dbo) <dbo@odoo.com>
Signed-off-by: Elisabeth Dickinson (edi) <edi@odoo.com>

c6cdbdb48d63abe0fee233fd38d42581fa5e43da	c6cdbdb48d6	2023-07-18	Louis Wicket (wil)	[FIX] voip: redisplay tabs after a call

6b1d61b2df4037fad7dbc7a0401f9bee0d0647fb removed some `div`s that were
no longer useful, but neglected to update some part of the JavaScript
code accordingly, resulting in the tabs not being displayed after a
call.

Task-3430368.

closes odoo/enterprise#44292

X-original-commit: 2e4ad25856dd20f94ed07509e1c11ea8862494c9
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

18cb0b640e9b05fda3799ab2adfc27e395318061	18cb0b640e9	2023-07-14	Victor Piryns (pivi)	[FIX] voip: add missing index on selection fields

Add missing index on `state` of `voip.phonecall` used in:
- view search filters
- `get_missed_call_info`

task-3420528

closes odoo/enterprise#44139

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

5b07f7457df73c4f9389a37e9d3845915be3eb7f	5b07f7457df	2023-07-11	Pierre Pulinckx (pipu)	[REM] voip: remove transfer_call action

This action is no longer used because
it is directly triggered in javascript.

task-3416597

closes odoo/enterprise#43932

Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

dedc5616cfe5c099e2b32a0b08c726fde96e46c8	dedc5616cfe	2023-07-10	Louis Wicket (wil)	[FIX] voip: properly display number of missed calls

Restore the missing `await` that was omitted when adapting VoIP to
Discuss refactoring in c33fe997f270a086150b628ab1021e9469e89c02, causing
the missed calls counter to show NaN.

Task-3416647.

closes odoo/enterprise#43875

X-original-commit: 5d016345b982bc09052fbd91c6433708345ceb84
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

74b3db4e6f238d2b1553fd98f0a1d3629e92e9e4	74b3db4e6f2	2023-06-20	Louis Wicket (wil)	[FIX] voip: dialing panel style improvements

+ Realign the search bar with the search button
+ Remove unwanted scroll bar under the tab list
+ Remove form view related classes

closes odoo/enterprise#42888

X-original-commit: a721f408e04ffae1dff80433ae5a2ad398591da7
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

93c57d43e26e523da7bbc7103299f004c9bc4e7f	93c57d43e26	2023-06-09	Sanket Brahmbhatt	[FIX] voip: user can perform call from voip

When the user opens the VOIP app, selects any contact, and clicks on the number
the error would be generated.

Steps to reproduce :
-Install the VoIP module.
-Open the VoIP app.
-Go to the contacts tab.
-Select any one contact.
-Click on Number
Error:  A traceback appears

sentry-4238616490

closes odoo/enterprise#42782

X-original-commit: 0ed92a82daac949a58c37662ce5b05682fa9306a
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

39f303ba4ff0f575392a675208633618619cd95d	39f303ba4ff	2023-06-15	Louis Wicket (wil)	[FIX] voip: properly restore selected contact after tab refresh

Selecting a contact in VoIP, then folding/unfolding the VoIP window,
then calling the contact causes a crash 😩

Steps to reproduce:
1. Install VoIP
2. Click on the phone icon in the systray to open the VoIP window
3. Go to the Contacts tab
4. Select a contact by clicking on it
5. Click twice on the top bar of the VoIP window to fold/unfold it
6. Click on the bottom phone button to make a call → 💥💥💥

This is because the logic that restores the selection after a tab
refresh is based on the phonecall id. Since contacts are not phonecalls,
they use virtual phonecall ids that are regenerated each time the tab is
refreshed, so the virtual id is not longer valid and the restoration
mechanism fails.

This commit fixes the problem by overriding the selection restoration
logic for the Contacts tab to reconcile the selection based on the
partner id rather than the phonecall id.

sentry-4066220991

closes odoo/enterprise#42728

X-original-commit: bcdb6f8073f5190b71dba214d642428e70177d0e
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

0a11f32e12520511f7997b40691cb4e64f33b6cf	0a11f32e125	2023-06-07	Louis Wicket (wil)	[FIX] voip: wait for required data to start user agent

The User Agent was started before the VoIP configuration could be
fetched, resulting in it being initialized in an unexpected state,
preventing normal use of the application.

Task-3355307

closes odoo/enterprise#42128

X-original-commit: bff13e4c03e1033fe1105467fc10452151207c1a
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5a857fa8dc07234f19c6c92b142fd7cc47ac479a	5a857fa8dc0	2023-06-05	Sébastien Theys	[FIX] voip: apply multi-company when feching calls (2)

Follow up of https://github.com/odoo/enterprise/pull/41549

Apparently the fix does not work starting from 16.2, likely due to the
introduction of orm fetch method, which changes when fields are loaded
in cache and when access rights are checked (the previous code was
assuming res_id was already accessible but it is not guaranteed and it
is now no longer the case).

Part of task-3266643

closes odoo/enterprise#41987

X-original-commit: a766d03ca5419848bf82725b87bdddf1de9c2d50
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

6dfdd3be38ba6a12dd80674b49e8364e8fa47647	6dfdd3be38b	2023-06-01	Louis Wicket (wil)	[FIX] voip: abort obsolete RPC + fix spinner display

With this commit, if a RPC is pending but the search terms change, the
current RPC is aborted and a new one with the updated search terms is
made instead.

This commit also fixes a bug introduced in
https://github.com/odoo/enterprise/pull/41704: sending two RPCs in a row
could desynchronise the state of the interface, displaying the spinner
when it shouldn't.

Part of task-3343258.

closes odoo/enterprise#41958

X-original-commit: 73f5646ca95d1bc35263b1f2cbbdc84fed8e916f
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

c44c160bf1687a13feac7343a99e8289cc72e62c	c44c160bf16	2023-05-22	Elisabeth Dickinson	[FIX] *: switch image's `.rounded-circle` to `.rounded`

*: documents, knowledge, mrp_workorder_hr, planning, social,
social_push_notifications, spreadsheet_edition, voip

Since the Milk refactoring, the backend uses only `.rounded` avatar
images. The `.rounded-circle` classes on images have been replaced by
`.rounded`.

task-3336569
part of task-3326263

closes odoo/enterprise#41798

X-original-commit: 124f98f797086ad95ade927a0ac688f9f8feefa0
Related: odoo/odoo#123286
Signed-off-by: Pierre Paridans (app) <app@odoo.com>

4a6e9b4dbb472134450e59038e719fc6af4691d6	4a6e9b4dbb4	2023-05-26	Sébastien Theys	[FIX] voip: apply multi-company when feching calls

Part of task-3266643

closes odoo/enterprise#41659

X-original-commit: ae50ddeacd11c4d68cc4adebd9a6538c9e0b300e
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

f75db5cef94c74c0d131bfe88e1509d25d1543f7	f75db5cef94	2023-05-22	Damien Bouvy	[FIX] voip: badly structured views

closes odoo/enterprise#41355

X-original-commit: 00896c413a92a7f2035b5dfe70b51acb0eab3cbb
Related: odoo/odoo#122111
Signed-off-by: Bouvy Damien (dbo) <dbo@odoo.com>
Signed-off-by: Pierre Paridans (app) <app@odoo.com>

691572027f57e29b21eed5597aaf7351ebb5c46b	691572027f5	2023-05-04	Brieuc-brd	[IMP] documents, planning, voip: milk adaptations

task-2818586

Part-of: odoo/enterprise#38775

7c39ec3384c348c54863e59208a5460106d7427c	7c39ec3384c	2023-04-28	stefanorigano (SRI)	[REF] web_enterprise, web_studio, voip: top-menu design

task-2818586

Part-of: odoo/enterprise#38775

f73d3b5c4332e28d5b9fa0a014e6a3ff2ff7fe6f	f73d3b5c433	2023-03-20	Louis Wicket (wil)	[FIX] voip: return when UA instantiation crashes

closes odoo/enterprise#38399

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

4ab64d5ae8c3c364b93beca3427f7e144ab7a0b5	4ab64d5ae8c	2023-03-15	Louis Wicket (wil)	[FIX] voip: properly catch crash on UA instantiation and display it

Prevents a traceback from being displayed in case of a crash during the
user agent initialization. Instead, the error message is displayed in
the dedicated VoIP window.

closes odoo/enterprise#38299

X-original-commit: 9e4aff8267dd85e39a2568bb01f35f9ffdc7f5a5
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

6bcb661c43254d27c0b64216524e129177295eef	6bcb661c432	2023-03-14	MerlinGuillaume	[FIX] voip: render the error message of voip in white

The error message of voip is written in black in dark mode making it
impossible to read

Steps to reproduce:
1. Install VOIP
2. Enable dark mode (top right corner)
3. Go to Settings > General Settings > Integrations > Asterisk (VoIP)
   and change the VoIP Environment to 'Production'
4. Click on the VOIP icon, the dialing panel opens up but it is not
   usable (there is an error message but it's written in black on black)

Solution:
Render the text in white when dark mode is enabled

Problem:
The blockMsg is rendered with the class `text-white` but this sets the
color of the text to black when dark mode is enabled

opw-3210443

closes odoo/enterprise#38261

X-original-commit: 69baba79d7fe5e2beed2ac12369b02f2e71ef1d8
Signed-off-by: Guillaume Merlin (megu) <megu@odoo.com>

dbe7d7bd681d31d13a3e0f6bd10b5c1dd85ac518	dbe7d7bd681	2023-03-03	Louis Wicket (wil)	[IMP] *: remove "French spacing" 👺

According to Wiktionary, French spacing is "the archaic practice (though
still current in French) of inserting a space around colons, semicolons,
question marks, and exclamation marks". This is not standard practice in
English and most languages of the world.

The purpose of this commit is to start purging the code from this typo,
as it may reflect poorly on the software for some people.

* = account_asset, account_auto_transfer, account_bank_statement_import,
account_consolidation, account_sepa_direct_debit, appointment,
documents_l10n_be_hr_payroll, event_barcode, event_social, helpdesk,
hr_appraisal, hr_appraisal_survey, hr_contract_salary, hr_payroll,
hr_payroll_account, hr_referral, industry_fsm, iot, knowledge,
l10n_be_hr_payroll, l10n_be_reports, l10n_de_pos_cert, l10n_es_reports,
l10n_ke_hr_payroll, l10n_ma_hr_payroll, l10n_mx_edi_website_sale,
marketing_automation, mrp_mps, mrp_plm, mrp_workorder, mrp_workorder_hr,
pos_hr_mobile, sale_planning, sale_purchase_inter_company_rules,
sale_renting, sale_stock_renting, sale_subscription, sign, social,
spreadsheet_edition, stock_barcode, stock_barcode_picking_batch,
timesheet_grid, voip, web_gantt, web_studio

closes odoo/enterprise#37853

Related: odoo/odoo#114533
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

4495720d0fc58fc62103bdd7d079ffec47b6fd16	4495720d0fc	2023-02-21	Louis Wicket (wil)	[FIX] voip: always look for partner related to a call activity

Commit 5ba660f87a71f068ffb13f54f8de63d90ffcc166 changed the way
phonecalls are created from 'phonecall' activities. As a result, if an
activity is already associated with a phone number, the related partner
is never computed, resulting in this information remaining missing.

The goal of this commit is to restore the previous behavior, that is,
looking for the relevant partner even if a phone number is already known
for the given activity.

Task-3199796

closes odoo/enterprise#37646

X-original-commit: 3db5769e2b95fe805dfdd34325b919dff84cd364
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

3d8a14d3b2201f588622defb463a2ae031a303ba	3d8a14d3b22	2022-12-29	Alexandre Kühn	[FIX] voip: do not block webclient from init_messaging load

Before this commit, when installing voip, the web client had
to wait for messaging being initialized.

This happens because voip registers a main component whose
children `willStart` waits for initialized messaging.
Main components full rendering, including children ('s `willStart`),
affect the web client waiting as a whole.

This commit fixes the issue by not mounting the voip container
children until messaging is initialized.

closes odoo/enterprise#35305

X-original-commit: 13a9744678bab80c68ed86c702c1e1d01aac0a0b
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

ac4dd830b24c7dd8dce2245596dca82055028c6a	ac4dd830b24	2022-11-14	Romain Estievenart	[IMP] voip: add the ability to switch the input for mobile device

The `replaceTrack`[1] allows the mobile web browser to switch between
the `Headset earpiece` and the `Speakerphone`[2]. This change allows the
user to change the audio output via a dialog when the call is
made (instead of the current value set to `default` as Speakerphone).

This commit also fixes the opw-2991278

Steps to reproduce:
- Setup a VoIP
- User `Foo` connected with the mobile app
- User `Bar` call the VoIP number of the user `Foo`
- When `Foo` answer the call, it is not possible to take it by ear
  "communication" mode, it's using the "loudspeaker" => bug

links:
1. https://developer.mozilla.org/en-US/docs/Web/API/RTCRtpSender/replaceTrack
2. https://source.chromium.org/chromium/chromium/src/+/main:media/base/android/java/src/org/chromium/media/AudioDeviceSelector.java;l=119;bpv=0;bpt=1

closes odoo/enterprise#34088

Related: odoo/odoo#107392
Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>

efa607853819722d0f42d62d75d3da0b616010fe	efa60785381	2022-10-17	Romain Estievenart	[IMP] voip: remove all native Odoo mobile app call usage

This commit restores the parity between the mobile app and the mobile
web browser on VoIP calls.

Before this commit:

│─────────────────────────────────────────────────────────────────│
│                           │ Mobile Browser  │   Odoo App        │
│─────────────────────────────────────────────────────────────────│
│ Ringtones (dialtone)      │  Default*       │  Speakerphone     │
│                           │                 │                   │
│ Ringtones (incoming call) │  Default*       │  Speakerphone     │
│                           │                 │                   │
│ Call Make                 │  Default*       │  Headset earpiece │
│                           │                 │                   │
│ Call Answer               │  Default*       │  Speakerphone     │
│─────────────────────────────────────────────────────────────────│

After this commit:

│──────────────────────────────────────────────────────────────────│
│                           │ Mobile Browser   │   Odoo App        │
│──────────────────────────────────────────────────────────────────│
│ Ringtones (dialtone)      │  Default*        │  Default*         │
│                           │                  │                   │
│ Ringtones (incoming call) │  Default*        │  Default*         │
│                           │                  │                   │
│ Call Make                 │  Default*        │  Default*         │
│                           │                  │                   │
│ Call Answer               │  Default*        │  Default*         │
│──────────────────────────────────────────────────────────────────│

Notes:

- The default* value is the default device configured by the os
  => The Speakerphone is the default value.
  But if a USB / Bluetooth Devices are plugged to the phone, it can be
  the default configuration.

Part-of: odoo/enterprise#34088

ea21380205c6965156ad089227b48039993a4f6b	ea21380205c	2022-11-18	Romain Estievenart	[FIX] voip: blank screen on mobile devices when missing a VoIP call

When we load Odoo and we missed a VoIP call, the VoIP dialog is showed
folded on desktop. Folded isn't a supported state on mobile screen.
So in that case to avoid a VoIP Blank screen, we loaded the recent call
VoIP Tab.

Steps to reproduce:

1. Missed a VoIP call
2. Open the mobile device
2. The VoIP dialog is blank => bug

closes odoo/enterprise#34384

Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>

114c249bfc1f9a9af88ac78ab3bcabbb82d56ef0	114c249bfc1	2022-10-31	Romain Estievenart	[FIX] voip: traceback on mobile device when click button on voip panel

Before this commit we had the following traceback:
> Uncaught Promise > this listener was already registered
This is because we tried to add back button listener, but it was already
done in _toggleDisplay.
This error only occurs in the mobile app.

Steps to reproduce:

- Click on the VoIP icon in the systray to open the voip panel
- Go to "next activities" tab
- Click on "Marc Demo"
- Click on button: "mail", "log", "reschedule activity", "partner"
  => traceback

Part-of: odoo/enterprise#34384

f0f9b27e02b08d1d8c26ac6031c92d650d8fcf71	f0f9b27e02b	2022-11-02	niyasraphy	[IMP] l10n_pe_edi, voip: remove useless upgrade_boolean widget

In a Community database, in Settings, when checking a config exclusive
to Enterprise, the Upgrade Boolean field is used to display a popup
suggesting the user to upgrade to Enterprise.

The presence of this field does not make sense for modules that are
Enterprise-only, such as VoIP.

This commit deletes occurrences of the Upgrade Boolean field in
Enterprise modules, as they are not relevant there.

closes odoo/enterprise#34120

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

203426c9d7e7345d5a98f9c460eb4faed5e01a27	203426c9d7e	2022-11-10	Louis Wicket (wil)	[FIX] voip: use grey avatar by default for phone calls

Phone calls with no partner are displayed with a white silhouette as an
avatar, which is not quite visible as the background itself is also
white.

This commit changes the default avatar to use the grey one so that it
becomes visible on white background.

Task-3063301.

closes odoo/enterprise#33872

X-original-commit: aa62a11e60f28efcc197fe8c47828b5ea1fd00fd
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

34787fae6f8933f0716d49e261e34674ccc61c71	34787fae6f8	2022-11-02	Antoine (anso)	[FIX] voip: fix incoming call buttons layout and style

Accept and decline buttons were wrongly positioned and their style
was too close

White png's were not visible on a white bg

task-3047632

closes odoo/enterprise#33859

X-original-commit: deab8e07577c30bf54473f12f827b2ae48c290d0
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

8031552d5e9118ad173f2c511179932e49a45b26	8031552d5e9	2022-11-07	Louis Wicket (wil)	[IMP] voip, knowledge: remove leading whitespaces

Remove leading whitespaces introduced in
85ec2e4588464e7100c5315bbeef5af30daf4000

closes odoo/enterprise#33692

Related: odoo/odoo#105123
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

1e91edcb74ce0f690200652289e8295cd414a7ce	1e91edcb74c	2022-11-05	Alexandre Kühn	[IMP] mail_enterprise, *: simply import @mail/model

* = account_accountant, approvals, crm_enterprise, documents,
hr_recruitement_extract, knowledge, sign, social, voip, voip_onsip,
website_helpdesk_livechat

Replaces the numerous imports related to the definition of models by a
single import of the '@mail/model' module.

Task-3056971

Part-of: odoo/enterprise#33679

8743fca9dee21f8382d54ea4cd940be31abd8f1a	8743fca9dee	2022-11-03	Alexandre Kühn	[IMP] mail, *: introduce useMessagingContainer

*: mail_enterprise, voip

This commit introduces component hook useMessagingContainer,
which allow to lazily use messaging component in template.

This allow simplifing some code in container, and more notably
in child messaging components, as they can now define their
template in models.

Task-3055886

Part-of: odoo/enterprise#33681

a4cb5b4dbbb7cd04dccd46c823ec4bdf8bceeb82	a4cb5b4dbbb	2022-11-03	Alexandre Kühn	[IMP] mail, *: simplify discuss template (no templateGetter)

This commit simplifies discuss template by putting record accessors
in the context of template.

*: approvals, knowledge, sign, voip

Task-3055022

Part-of: odoo/enterprise#33681

9f2e9dbcfeaae8fc39a570c4cda00a386102a553	9f2e9dbcfea	2022-10-28	Zelong Lin	[FIX] voip: call first when only has mobile number

Cannot call first partner if partner only has mobile number

task-3046595

closes odoo/enterprise#33425

X-original-commit: f5027137b54c47958a4bb42160a81a9f54a81f02
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

cfe545bcae35972ee3f5e8d7fe961d8a8b39bda3	cfe545bcae3	2022-10-26	Alexandre Kühn	[IMP] mail, *: Rename component to match model (step 1)

*: approvals, documents, sign, voip

[IMP] approvals: rename Approval to ApprovalView (component)
Task-3045295

[IMP] sign: rename SignRequest to SignRequestView (component)
Task-3045299

[IMP] mail, *: rename component Activity to ActivityView
*: approvals, documents, sign, voip
Task-3045361

Task-3046089

closes odoo/enterprise#33300

Related: odoo/odoo#104261
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

9b83770f4894d2aa0d1c5ed8e08b36083f012cf0	9b83770f489	2022-10-24	Louis Wicket (wil)	[IMP] voip: get rid of trigger_up

Task-3042783.

closes odoo/enterprise#33228

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e9fdd8de5e289b738e6b7011dff702e011bb489a	e9fdd8de5e2	2022-10-21	Jorge Pinna Puissant	[IMP] web,*: force props validation for components

*: mrp_workorder, spreadsheet_edition, voip, web_enterprise, web_gantt,
    web_studio

This commit adds a warning if the props validation is not set for a
component.

The props validation is important to tell how a component should be
used, by looking at its code, it's a good documentation of the component.
It's also critical, to test if the component is correctly used, if all
the obligatory props are passed and that there are of the correct type.

For more information, see: https://github.com/odoo/owl/blob/master/doc/reference/props.md#props-validation

closes odoo/enterprise#33044

Related: odoo/odoo#103723
Signed-off-by: Géry Debongnie <ged@odoo.com>

9b494cc63e4e6e3fc8d9c4b9f1acb87fa33a102b	9b494cc63e4	2022-10-20	Louis Wicket (wil)	[IMP] voip: convert VoipSystrayItem to models

Task-3036700.

closes odoo/enterprise#33036

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

c256c795ecd9d89cb7e78e4ccaff03124129c55f	c256c795ecd	2022-10-17	tsm-odoo	[IMP] voip: remove owl bus on/off

These are deprecated since Owl 2, and lead to memory leak in the
compatibility layer. This PR removes the last ones in the mail code.

task-2877316

closes odoo/enterprise#32842

Related: odoo/odoo#103301
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

af2d86d15307ff497942c503bb0155cea238917a	af2d86d1530	2022-10-10	Xavier Luyckx (xlu)	[FIX] voip: adapt window title for dark mode

Prior to this commit, the window title for VOIP used incorrect colors.
This commit adapts to the correct colors for dark mode.

task-3012970

X-original-commit: 1c7807ba80e2bd44bc009e4c5ff5491b77491344
Part-of: odoo/enterprise#32753

a7beb416f27514249a6ffcbf078a2b351107b7cf	a7beb416f27	2022-10-10	Louis Wicket (wil)	[IMP] voip: merge path and filename fields of SoundEffect model

Context:
We want to get rid of default values on identifying fields, and
SoundEffect/path is currently the only field to present this pattern.

Merging path and filename fields together makes the default value no
longer meaningful, as there is no full path that is shared by multiple
records and which would therefore consist of a relevant default value.

The point of removing default values from identifying fields is to
simplify the code of findFromIdentifyingData, which is called by every
single insert, so that we no longer have the overhead of looking for
default values.

This commit adapts the Enterprise code, and especially the VoIP code, to
the changes made to the SoundEffect model.

closes odoo/enterprise#32634

Related: odoo/odoo#102912
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b649d34ec186cc1c2e5c95f0f99123bfa29c2cc1	b649d34ec18	2022-10-06	Louis Wicket (wil)	[IMP] voip: do not wait for Messaging in VoipService

closes odoo/enterprise#32433

X-original-commit: 25df3993409e4ab878e504b046d6e90b964733d7
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

87cd6d02ad471d7a9759b1e323e31a21fb0011e7	87cd6d02ad4	2022-10-03	tsm-odoo	[IMP] *: split mock server by model/controller

*: approvals, documents, voip, website_helpdesk_livechat.

The mail mock server is getting bigger and bigger. As a consequence,
navigating/keeping it up to date is quiet inconvenient.

This commit solves this issue by splitting it by model/controller.

closes odoo/enterprise#32314

Related: odoo/odoo#98374
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

f60b3226365f737c5a81f98f15864b1a912f5abe	f60b3226365	2022-10-06	Didier (did)	[IMP] voip: remove useless guard

part of task-2783065

closes odoo/enterprise#32360

Related: odoo/odoo#102336
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

a16f6d61d11a3ea316783486bd2e2debd923ddf5	a16f6d61d11	2022-09-27	Louis Wicket (wil)	[IMP] mail_enterprise, *: refactor patch API to match model definitions

Task-2998282.

* = approvals, crm_enterprise, documents, knowledge, sign, voip,
    voip_onsip, website_helpdesk

closes odoo/enterprise#32136

X-original-commit: 7c403fd8ce4b292eeb5db2302e9384f9a7358e22
Related: odoo/odoo#101827
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

61923ecea206f71b70eab57f6430d172ae6d317d	61923ecea20	2022-09-27	luvi	[FIX] voip: adapt code to PhoneField changes

This commit is the counterpart of https://github.com/odoo/odoo/pull/101433,
and  adapts the code of voip to patch the right elements in the
PhoneField template. As the field now always displays a Call button,
the call must be enabled even in edition mode.

Tests have been adapted with a new selector

closes odoo/enterprise#32108

X-original-commit: 944ec9f4a77376d8f21af594e8fe4020868f5fa0
Related: odoo/odoo#101786
Signed-off-by: Michaël Mattiello <mcm@odoo.com>
Signed-off-by: Luca Vitali <luvi@odoo.com>

165b3afd2118891cb8d57a6f8f0972ae88555262	165b3afd211	2022-09-20	Louis Wicket (wil)	[IMP] voip, voip_crm: refactor call_center_field

Rewrite call_center_field to use OWL and models framework.

Task-2992592.

closes odoo/enterprise#31668

X-original-commit: 95cba6cff0dad7a8cc84a84abf5127a338e91bc0
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

dc6e264543411a36e1143361fa8d2d1a3b12c1ce	dc6e2645434	2022-09-20	Alexandre Kühn	[IMP] mail, *: introduce public livechat bundle

*: documents, knowledge, voip

This commit introduces the public livechat bundle, which
contains the models that are specifically used in public livechat.

Doing so reduces the amount of model and data in frontend and
external lib, which makes the page load faster.

Task-2990182
Task-2990191

closes odoo/enterprise#31608

X-original-commit: f5781df165af8233fce2187513bc92b44d0f24a7
Related: odoo/odoo#100768
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

f59ccad088633a4b04311b175c739b33743fbfcd	f59ccad0886	2022-09-16	Aaron Bohy	[FIX] voip,web: PhoneField: set correct type on input

This pr is the enterprise counter part of odoo/odoo#100388 where
we set the input type to "tel" in PhoneField, instad of "phone",
which simply doesn't exist.

closes odoo/enterprise#31437

Signed-off-by: Pierre Paridans (app) <app@odoo.com>

d34bcf17b67424b49c7e236efd3894a74f1de0c8	d34bcf17b67	2022-08-29	Romain Estievenart	[FIX] voip: alignment issues in transfer call form

Before this commit, the close button was right next to the title instead
of on the right.

This also fix the button that was below the field instead of being next
to it.

Steps to reproduce:
- Call an user
- Click on transfer button
=> See the popup form

Part-of: odoo/enterprise#31261

aeecaeb5b1994925da8c1091fba954af541ff6c6	aeecaeb5b19	2022-09-13	Louis Wicket (wil)	[IMP] mail_enterprise, *: remove unnecessary declarations of `isCausal: true`

* = approvals, documents, sign, voip

Inverses of identifying fields are now automatically causal. This commit
therefore removes the unnecessary declarations of `isCausal: true` from
the code.

Task-2741402.

closes odoo/enterprise#31290

Related: odoo/odoo#100119
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

62a7d90029a018cde248fc08ac36d02a99eadeaa	62a7d90029a	2022-09-08	Rémy Voet (ryv)	[IMP] voip: improve performance of `_compute_has_call_in_queue`

The domain part generated by `_linked_phone_call_domain`
```
[
    ('activity_id.res_id', 'in', <rec_ids>)
    ('activity_id.res_model_id', '=', <id>)
```
is highly inefficient.
The ORM will convert it into (threat each condition independently):
```
[
    ('activity_id', 'in', env['mail.activity']._search([('res_id', 'in', <rec_ids>)]))
    ('activity_id', 'in', env['mail.activity']._search([('res_model_id', '=', <id>)]))
```
And the `_search` (of `mail.activity`) is override
and doesn't return a Query object but directly the result
(and do extra stuff for security reason).

Because of these, both condition/_search load much more than
necessary and check the access on too many records.
By example, the second condition will fetch every activity id
link to the current model (and check access to each),
no matter the current records.

Performance Improvements:
-------------------------
Only with 15_000 leads and 5_000 activity link to them, to read
`has_call_in_queue` value of 10 records:
It took 72 ms before and it takes 5 ms now.

closes odoo/enterprise#31179

Signed-off-by: Xavier Morel (xmo) <xmo@odoo.com>

5cce6fc9922b92be018c4c3ea90f1024bff6a092	5cce6fc9922	2022-08-08	Antoine (anso)	[IMP] voip : revamp scss

This commit simplifies the component's SCSS improving bootstrap's
integration. Design was improved for consistency.

Part of the overall v16 SCSS optimization/restyle

task-2943593

closes odoo/enterprise#30201

Signed-off-by: Pierre Paridans (app) <app@odoo.com>

29474444f47dc28dd2a677eeb61be7e4acea3a45	29474444f47	2022-08-19	Thibault Delavallée	[PRF] hr_payroll_holidays, documents, voip: improve performance of closing activities

MailActivity model has an ``_action_done`` method that is quite heavily
used and overridden. It notably posts messages, create next activities but
also has some specific behavior depending on category.

Purpose of this commit is to improve code of this method to avoid useless
queries, improve performance, and rethink the computation with batch in
mind.

Task-2883589 (Activity performance and cleaning)

Part-of: odoo/enterprise#28421

0af29de5f445c8c70cd106ea7a7b9230964fce54	0af29de5f44	2022-06-15	Thibault Delavallée	[REF] voip: send activity notifications in batch

No need to send bus notifications one by one, we may use sendmany. Various
activities crud methods send notifications, better group them when possible.

Task-2883589 (Activity performance and cleaning)

Part-of: odoo/enterprise#28421

858c85d5ff96f1c4766d8e5d9270dc66d5c70931	858c85d5ff9	2022-06-15	Thibault Delavallée	[REF] voip: create phonecalls in batch

When scheduling call-based activities, phonecalls can be created in batch
instead of one by one. This improves performance when creating a lot of
activities, through scheduled actions or list action for example.

Task-2883589 (Activity performance and cleaning)

Part-of: odoo/enterprise#28421

cc614564df3cac78f5adce4db6559e579470ef2e	cc614564df3	2022-06-15	Thibault Delavallée	[REF] voip: improve activity creation batch creation

Purpose of this commit is mainly to compute activity / voip info in batch.
Call-based activities compute phone and number for activities to prepare
voip phonecalls creation. However this is currently done in a loop without
any optimization when batching activities creation. However we often create
activities in batch on a given model, allowing to batch the browse, access
rights checks, ...

Instead of computing information record-based, group records by model and
perform information fetch in batch.

Bus notifications are also batched to speedup multiple activities creation.

Task-2883589 (Activity performance and cleaning)

Part-of: odoo/enterprise#28421

dc50ef3ea46fe63167d615a931bb514b0108ce63	dc50ef3ea46	2022-06-15	Thibault Delavallée	[REF] voip: always ensure a phonecall activity type exists

Currently, when calling ``create_call_in_queue`` an heuristic to find the
right activity type is performed. When no phonecall activity type is found
a fallback on Todo or a generic activity type is done. However when creating
activities, no ``voip.phonecall`` records are created when creating activities
under a type that is not phonecall. This leads to an UserError being raised
in ``create_call_in_queue``.

To avoid that issue, we now dynamically create the ``call`` activity type
if it has been removed or wrongly updated. That way voip always works as
intended instead of crashing or simply not working.

Task-2884301 (Voip synchronization simplification)

Part-of: odoo/enterprise#28421

f6fb239bbd9e973314414ab523204a016d2ba67f	f6fb239bbd9	2022-06-15	Thibault Delavallée	[FIX][IMP] mail, voip: ease finding customer of a record

We now have a way to better define how to find a customer on a record using
an inheritable method. See recently added method in ``MailThread`` mixin
class.

Task-2883589 (Activity performance and cleaning)

Part-of: odoo/enterprise#28421

47657b757338977d8458d6df01e7ea1da2e29bc1	47657b75733	2021-12-21	Matthieu Stockbauer	[IMP] *: apply changes after longpolling replacement

*: delivery_iot, documents_spreadsheet, spreadsheet_edition, voip.

closes odoo/enterprise#23184

Related: odoo/odoo#75510
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

a80456b2629c245462d2ca3d140d90941ceced3f	a80456b2629	2022-08-22	Louis Wicket (wil)	[IMP] voip: stop using OnChange constructor in model definitions

closes odoo/enterprise#30631

Related: odoo/odoo#98549
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

ec3f04cd0669ae41828f4a4c25d8e5bcc5f1a94d	ec3f04cd066	2022-08-19	Louis Wicket (wil)	[IMP] voip: small Registerer improvements

In this commit:
+ Make the expiration interval a field and document it
+ Set the initial value of `state` in `_created` hook instead of via a
compute
+ Fix single quotes

closes odoo/enterprise#30602

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

ddbc5e60bb14867030e64af1667854b633460244	ddbc5e60bb1	2022-08-18	Sébastien Theys	[IMP] mail_enterprise, *: remove explicit usage of insert-and-replace

* = approvals, documents, sign, voip

Distinction between "replace" and "insert-and-replace" can be guessed based on
the type of the provided data.

task-2957295

closes odoo/enterprise#30580

Related: odoo/odoo#98404
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

88c0567d28dfa65f2367c5392430aa89aa9d2d4d	88c0567d28d	2022-08-17	Louis Wicket (wil)	[IMP] voip, *: auto add implicit attributes of identifying fields

Task-2955910.
* = approvals, documents, mail_enterprise, sign

closes odoo/enterprise#30511

Related: odoo/odoo#98283
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b6b80fecde9abadfca44da57ae6fc2b58bbc5119	b6b80fecde9	2022-08-16	Sébastien Theys	[IMP] mail, *: introduce identifyingMode and remove identifyingFields

* = approvals, documents, mail_enterprise, sign, voip

This simplifies definition and overrides and opens up new identification
opportunities.

Part of task-2741982

closes odoo/enterprise#30470

Related: odoo/odoo#98166
Signed-off-by: Louis Wicket (wil) <wil@odoo.com>

f4e9d6d25ca3fedf832f301b073f8ffddf6fdd47	f4e9d6d25ca	2022-08-09	tsm-odoo	[MOV] *: move startServer test helper to the bus module

*: account_accountant, account_invoice_extract, approvals, documents,
documents_spreadsheet, voip.

closes odoo/enterprise#30244

Related: odoo/odoo#97771
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

dfbb55a677430d5718f8e6dabcac28b0679b88cb	dfbb55a6774	2022-08-05	Louis Wicket (wil)	[FIX] voip_onsip: don't cast possible FieldCommand to boolean

The default value of areCredentialsSet is false, meaning that if the
compute returns the field command `clear()`, we would expect the value to
be reset to false. However, casting the `clear` command to a boolean
would result in true, which is the opposite of what is expected.

This commit pulls the call to super from the boolean cast so that
possible field commands as return value aren't wrongly converted to
true.

closes odoo/enterprise#30164

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5964206b14232b531476be74ac77a263201a2a4b	5964206b142	2022-08-05	Louis Wicket (wil)	[IMP] voip: rename phonecall_type to direction

Upgrade: odoo/upgrade#3748
Part of task-2946324.

closes odoo/enterprise#30159

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b135636adb2d42ab63e5d353c798f48b00021db9	b135636adb2	2022-08-02	Aaron Bohy	[FIX] voip: PhoneField: do not crash on click

Before this commit, it crashed when the user clicked on the value
of a PhoneField, with voip installed. After this commit, it opens
the voip DialingPanel as expected.

This commit also duplicates and adapts the (small) test suite for
the voip PhoneField, s.t. the new implementation is tested as well.
Before, only the legacy implementation was tested.

closes odoo/enterprise#30064

Signed-off-by: Lucas Perais (lpe) <lpe@odoo.com>

f263e633c4a26054e15bc419aaa488f5114d2647	f263e633c4a	2022-07-25	tsm-odoo	[FIX] *: fix onNotification/offNotification

*: delivery_iot, spreadsheet_edition, voip.

The callback registered by the bus service method onNotification was
not the same unregistered by offNotification. Since those methods
were superfluous, they have been remvoed in favor of
(add/remove)EventListener.

closes odoo/enterprise#29819

Related: odoo/odoo#96684
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

1c3b39273477d57dc1b76ca2c0677d668eade48b	1c3b3927347	2022-07-19	tsm-odoo	[IMP] *: improve multi tab service

*: delivery_iot, iot, voip.

Following @ged-odoo review, the multi tab service has been improved:
    - multi_tab_service.js has been moved to the correct location.
    - _callLocalStorage method has been removed and replaced by
      getItemFromLocalStorage/setItemToLocalStorage.
    - underscore.js calls have been removed.
    - multi_tab_service is now using function closure style  instead of class.
    - multi_tab service is now using its own bus instance.
    - service name is now in snake case as per convention.
    - tests have been added.
    - multi tab service now handles setting/removing/getting values
      common to all the tabs.

closes odoo/enterprise#29694

Related: odoo/odoo#96386
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

8f0ebdaacb2a779fa7c51570fba9bcf79a0a09dd	8f0ebdaacb2	2022-07-12	Sébastien Theys	[IMP] mail_enterprise, voip: adapt chatter container in new form

task-2871070

Part-of: odoo/enterprise#23069

4cfce6fd8b27cb53370f714615f2b76471c7a44f	4cfce6fd8b2	2022-07-19	Lucas Perais	[FIX] voip: improve voip service and adapt PhoneField to OWL

The voip service is now thought of as the center point of voip to
handle the VOIP logic. It can tell if one can call, and one can make
a phonecall with the `call` method.

The phone_field has been adapted consequently and uses that service
to handle calling a number with VOIP.

Part-of: odoo/enterprise#23069

13ac285a3fd40a6fcf9ffaf93057a65477c913b6	13ac285a3fd	2022-07-15	tsm-odoo	[IMP] *: introduce multi tab service

*: delivery_iot, documents_spreadsheet, iot, voip.

In order to ease the PR introducing websockets in Odoo, introduce
the multi service. Indeed, the cross tab bus won't be necessary
anymore but there will still be a need to elect a main tab: some actions
should only be triggered once. To achieve this, the code electing the main
tab has been split with the one handling the longpolling. The crosstab
bus now relies on the multi tab service to known whether or not the
current tab is the main tab.

task-2053917

closes odoo/enterprise#29573

Related: odoo/odoo#96174
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

26c25cf018a4794f178c102f82dfbf5571e9e963	26c25cf018a	2022-07-14	tsm-odoo	[IMP] *: replace on/off by (add/remove)EventListeners

*: delivery_iot, documents_spreadsheet, voip.

on/off are deprecated in favor of  addEventListener/removeEventListener.
Calls to the bus service have been updated to reflect those changes.

task-2053917

closes odoo/enterprise#29501

Related: odoo/odoo#96017
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

b32c20510060d57413396a29c184408df3b4415f	b32c2051006	2022-07-14	Louis Wicket (wil)	[IMP] voip: rename event

so that it matches the name used by Owl without having to rely on a
compatibility layer. It will be important to adapt some code to WOWL.

closes odoo/enterprise#29495

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

f76a95ff91f381798a9c651554952ee020d60c96	f76a95ff91f	2022-06-28	Louis Wicket (wil)	[IMP] voip: introduce Registerer model

Introduce the Registerer model that wraps the Registerer class of the
SIP.js library.

Task-2896691.

closes odoo/enterprise#28996

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b12f1a1e8ce4f72a95c4ce57e7fbb1d41f301f8f	b12f1a1e8ce	2022-06-21	Louis Wicket (wil)	[IMP] voip, *: model PBX configuration in Voip model

* = test_discuss_full_enterprise

Send PBX configuration in init_messaging and store it in the Voip model.
Delete the no longer useful voip.configurator model.

Part of task-2804807.

closes odoo/enterprise#28860

Community: odoo/odoo#94569
Upgrade: odoo/upgrade#3625
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b3357eed1c6c28d5bad56bff33f651c28b8b4f03	b3357eed1c6	2022-06-28	Louis Wicket (wil)	[FIX] voip: fix typo causing voip to crash

Fix typo introduced in commit ad35805dd324124544b7b2c8e762fff8fb8ff0a9.

closes odoo/enterprise#28927

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

389af6fe0b743190823ad0e0bec3285df0213654	389af6fe0b7	2022-06-24	Alexandre Kühn	[IMP] mail_enterprise, *: use mail.assets_messaging bundle

*:
    approvals
    sign
    voip
    voip_onsip
    website_helpdesk_livechat

Task-2894450

closes odoo/enterprise#28913

Related: odoo/odoo#94722
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

ad35805dd324124544b7b2c8e762fff8fb8ff0a9	ad35805dd32	2022-06-27	Louis Wicket (wil)	[IMP] voip: use Device/hasRtcSupport in VoIP

closes odoo/enterprise#28900

Community: https://github.com/odoo/odoo/pull/94683
Related: odoo/odoo#94683
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

644e998a6d7ad7005234b32f3ffa75420b67fe31	644e998a6d7	2022-06-27	Louis Wicket (wil)	[IMP] voip: model ringtones

Task-2804940.

closes odoo/enterprise#28885

Community: odoo/odoo#94632
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

c77f27da626c57e599635ff01230d38948c43efc	c77f27da626	2022-06-24	Louis Wicket (wil)	[IMP] voip_onsip: remove no longer useful code

closes odoo/enterprise#28835

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b3ae89b921ee898d9f9a2d1415f29b198c98b302	b3ae89b921e	2022-06-24	Louis Wicket (wil)	[IMP] voip, voip_onsip: introduce Voip/authorizationUsername

Part-of: odoo/enterprise#28835

9a87bd2bf0a784e7a83262c7491123f6a1066e9c	9a87bd2bf0a	2022-06-21	tsm-odoo	[IMP] mail_enterprise, *: replace createChatterContainer during tests

*: approvals, voip.

The createChatterContainer helper was used during tests to mount
a chatter container and test it. However, this approach is not
very realistic and blocks some waiting PRs. In order to get closer
from the reality, let's mount a webClient and open a form view
containing a chatter.

closes odoo/enterprise#28684

Related: odoo/odoo#94175
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

26b8fffc951a52fd32961dd5a6c3ecc50db4003f	26b8fffc951	2022-06-21	Louis Wicket (wil)	[IMP] voip_onsip, *: move onsip_auth_username to res.users.settings

* = appointment_hr, test_discuss_full_enterprise
In line with task-2821508.

closes odoo/enterprise#28729

Related: odoo/upgrade#3617
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

4f7b1696930eaa58dc4983d2c4a1150ae582b4e5	4f7b1696930	2022-06-21	Louis Wicket (wil)	[IMP] voip_onsip: rename onsip_auth_user -> onsip_auth_username

Part-of: odoo/enterprise#28729

7d0aa8df68b0e0866f7df33df048d931ff4d1aca	7d0aa8df68b	2022-06-22	Louis Wicket (wil)	[IMP] voip_onsip: remove useless neutralize function

Part-of: odoo/enterprise#28729

155d078748d58d0f7d6c3c032316cfc80d56fa8b	155d078748d	2022-06-22	Louis Wicket (wil)	[IMP] voip, voip_crm, voip_onsip: remove encoding definition

Remove useless comments `# -*- coding: utf-8 -*-` from the VoIP
codebase.

closes odoo/enterprise#28724

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

ede559a939d75db19f94336f0c8e690df4131a48	ede559a939d	2022-06-21	Louis Wicket (wil)	[FIX] voip_onsip: rename forgotten parameter

Commit 25db5caf33c6ddfc2895915a99fe296c91ca24ef updated the SIP.js
library, changing the name of some parameters.

This commit renames a parameter that had been forgotten.

closes odoo/enterprise#28686

X-original-commit: 5f579070502ed717ef53410119c6042fb2f26c06
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

40cd5afaf9b7b1b5024c36a8faf3e3b8d1ce5d19	40cd5afaf9b	2022-06-20	Louis Wicket (wil)	[IMP] voip: rewrite voip code to use res.users.settings

Part of task-2804807.

closes odoo/enterprise#28614

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

7b74051d42c027d98135e084578687811c121009	7b74051d42c	2022-06-20	Louis Wicket (wil)	[IMP] voip: change test to wait for the start of messaging service

Part-of: odoo/enterprise#28614

5c7f399ade9c92928b9aa97d307e3e30e3476793	5c7f399ade9	2022-06-17	Louis Wicket (wil)	[IMP] voip: introduce Voip model

closes odoo/enterprise#28547

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

45ec3b8d4ba4531b0224c8d98b5445fb216871f9	45ec3b8d4ba	2022-06-09	Louis Wicket (wil)	[IMP] voip: add voip config to res.users.settings

closes odoo/enterprise#28291

Related: odoo/odoo#93390
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

8ff30e818cf24d57fa8ff612372514fd92ced298	8ff30e818cf	2022-05-16	Florian Charlier	[IMP] appointment,documents_spreadsheet,voip: use _is_internal

`_is_internal` is now used in the codebase where it is clear that
`.has_group('base.group_user')` was called on a single record.

Part of Task-2762102
See odoo/odoo#85703

closes odoo/enterprise#27603

Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>

d60f1cd8c5603cea96ef07e61ae72aa2a766c015	d60f1cd8c56	2022-06-10	Alexandre Kühn	[IMP] voip: adapt from removal of Chatter/_willDelete lifecycle hook

Task-2881075

closes odoo/enterprise#28274

Related: odoo/odoo#93330
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

65ec2d856096aed6b8f048c14d661dd327681ece	65ec2d85609	2022-05-03	Louis Wicket (wil)	[IMP] voip: move VoIP user config from res.users to res.users.settings

Task-2821508.

closes odoo/enterprise#26287

Related: odoo/upgrade#3479
Related: odoo/odoo#90015
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

969eac2e408ba3a034c2773ebea6c5c3745e6f04	969eac2e408	2022-04-20	tsm-odoo	[IMP] mail_enterprise, *: use wowlEnv instead of the legacy one

*: account_followup, account_invoice_extract, approvals, documents,
documents_spreadsheet, hr_appraisal, sign, voip, web_studio,
website_helpdesk_livechat.

task-2582313

closes odoo/enterprise#26493

Related: odoo/odoo#83774
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

4bb6aede820672fd1f8bc19417879a0035e50787	4bb6aede820	2022-05-24	tsm-odoo	[IMP] voip: adapt dialig panel tests for wowl env

This PR prepares the ground for the one introducing the wowlEnv in the discuss app.
Indeed, the start helper won't return widgets anymore. This means we need to adapt those
tests to stop calling widget methods and rely on a more realistic behavior. The voip dialing
panel tests have been adapted to ease the wowlEnv integration.

task-2582313

closes odoo/enterprise#27720

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

2986e2d78d39687252c725ead91e742a0fe20c8a	2986e2d78d3	2022-05-17	Louis Wicket (wil)	[IMP] voip: improve dialing panel title translation

This commit provides translations in more plural forms for the dialing
panel title.

closes odoo/enterprise#27448

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

23d43cc7f215915695910801384790bd0bc11cfe	23d43cc7f21	2022-05-11	tsm-odoo	[IMP] mail_enterprise, *: remove useless widget destroy

*: account_invoice_extract, documents, voip.

Since community#86338, widget destruction is registered in the start method. Thus,
explicit calls to widget.destroy during tests are useless. This PR prepares the ground
for the one introducing the new environment in the discuss app. Indeed, the former PR
will use createWebClient instead of createView/Widget constructor thus, we won't be able
to call destroy on the returned value anymore. In order to reduce the noise in the main PR,
all the calls to widget.destroy have been removed.

task-2582313

closes odoo/enterprise#27192

Related: odoo/odoo#91082
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

4f882d79f5e30a496559ce5ff1a5d982332c9654	4f882d79f5e	2022-03-22	stefanorigano (SRI)	[IMP] voip: apply `odoo-brand` classes, adapt design

Part of the overall v16 SCSS optimization/restyle, task-2704984.

task-2800721

closes odoo/enterprise#25700

Related: odoo/odoo#87448
Signed-off-by: Pierre Paridans (app) <app@odoo.com>

ccc60138237d0f836af31857e5062e477d6fc853	ccc60138237	2022-05-03	Louis Wicket (wil)	[FIX] voip: send browser notifications in master tab

Stop sending browser notifications on incoming call if the current tab
is not the master tab, so that users don't get the notification as many
times as they have open tabs.

Task-2841841

closes odoo/enterprise#26920

X-original-commit: 579998d6fbe322581db28b54766497bf6a8f4642
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

dd28da9ecdeb87952b40a4d1ae2bc95d14b00013	dd28da9ecde	2022-05-03	Damien Bouvy	[FIX] voip: faster searches on incoming calls

When an incoming call event is triggered, the voip 'user agent'
will contact the backend to search for a user or partner matching
the incomgin call's phone number (formatted in different ways).

A 'limit: 1' was added to (presumably) increase performance, but
it may interact badly with indices set on the phone number fields
to increase performance - and indices on the partner table
in general.

Since the client code is already able to process more than one
result, simply remove the limit.

closes odoo/enterprise#26896

X-original-commit: fa643db32d4461e53cf941812ab905f1daf56f9c
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

d84ebc406911603f35a923b5c05349c321ae24a6	d84ebc40691	2022-04-19	Hiral Bhavsar	[IMP] voip: move the handler to chatter instead of activity

Move the handler of 'voip_reload_chatter' to chatter instead of activity because
currently, this will likely trigger as many reload as there are activities

Task-2659932

closes odoo/enterprise#26641

X-original-commit: 19a46145d84d6ecbbfe725312ce4c181d9fd8170
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

0cd0f22c9b8e55a68eaaf086e8fed2d3aee10b82	0cd0f22c9b8	2022-04-14	Alexandre Kühn	[IMP] voip: move component handlers to models (step 7)

This commit moves some handler methods from components to models,
as a step closer to having most of business code in models.

Having business code in models is desirable so that the code is much more maintainable:
easier to change and more robust code.

Task-2579306

closes odoo/enterprise#26379

Related: odoo/odoo#89123
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e1b7bb3506401251ca2f65ec20eaa6719dc30c69	e1b7bb35064	2022-04-14	Alexandre Kühn	[IMP] voip: move component handlers to models (step 5)

This commit moves some handler methods from components to models,
as a step closer to having most of business code in models.

Having business code in models is desirable so that the code is much more maintainable:
easier to change and more robust code.

Task-2579306

closes odoo/enterprise#26277

Related: odoo/odoo#88878
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

debef7f1c1029a0c469f848d095454fd3584428c	debef7f1c10	2022-03-31	tsm-odoo	[IMP] mail_enterprise, *: adapt tests data seeding

*: approvals, voip, website_helpdesk_livechat

task-2792108

closes odoo/enterprise#25883

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

303562867a78330fbc9626db2f4c300f05392d89	303562867a7	2022-03-25	Louis Wicket (wil)	[FIX] voip: don't play ringtone in all open tabs

Only play the incoming call ringtone in the master tab, avoiding to play
several times at once the ringtone when multiple tabs are open.

Task-2803370

closes odoo/enterprise#25636

X-original-commit: 06167a375c62e92f008095d8a9e6f59da77c9710
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

767805948398950fa5303d961428e004968a9792	76780594839	2022-03-23	luvi	[FIX] voip: phone field _onClick triggered twice

This commit is the counterpart of a community fix
in the web module. The click handler is only
triggered once and a phone call will no longer
raise an error.
A test has been added in the voip module to check
that the handler is only called once.

PR community: odoo/odoo#86928

closes odoo/enterprise#25558

X-original-commit: c4b5a2be44050004ea900c81ff6d660d8c974ed5
Related: odoo/odoo#87196
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

503a7eb36dbe543211a9fcfc6e90fa63bdba4e39	503a7eb36db	2022-03-24	Louis Wicket (wil)	[FIX] voip: click on PhoneField only calls once

Current behavior:
Clicking on a FieldPhone in a form view records the call in duplicate.

After this commit:
Only one call is recorded.

Task-2802823

closes odoo/enterprise#25581

X-original-commit: 08fcd73ef9fad9540e361624d88ea1d16524e337
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5e1caf8dae572fb39415b2b321d412cf37ae6f56	5e1caf8dae5	2022-03-23	Louis Wicket (wil)	[MOV] mail_enterprise, *: move test_utils

* : account_invoice_extract, approvals, documents,
    documents_spreadsheet_bundle, voip, web_studio,
    website_helpdesk_livechat

Task-2759586
See https://github.com/odoo/odoo/pull/86791

closes odoo/enterprise#25491

Related: odoo/odoo#86791
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

db121cbe481c9b8ff86d0cbfc84ec35a93352115	db121cbe481	2022-03-18	Louis Wicket (wil)	[MOV] mail_enterprise, *: move tests

* = approvals, voip, website_helpdesk

Move tests files into `static/tests`.
Task-2759560

closes odoo/enterprise#25375

Related: odoo/odoo#86581
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

c08572b9af96b51d4c180f917bcdcdb45a41922a	c08572b9af9	2022-03-16	tsm-odoo	[IMP] mail_enterprise, *: make mail tests stop relying on this

*: approvals, mail_enterprise, voip, website_helpdesk_livechat.

task-2792108

closes odoo/enterprise#25341

Related: odoo/odoo#86559
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5e26761322cf19940554917b799d3c24d1cc9bad	5e26761322c	2022-03-15	Louis Wicket (wil)	[IMP] mail_enterprise, *: move up model files

Move model definition files from `models/thing/thing.js` to
`models/thing.js` and remove the now empty intermediate directory.

Task-2759582
 * = approvals, voip, website_helpdesk_livechat

closes odoo/enterprise#25291

Related: odoo/odoo#86464
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

1f81960f0ed37b68ce7d3b58ef9914a0c07243c7	1f81960f0ed	2022-03-15	tsm-odoo	[IMP] mail_enterprise, *: make start method handle cleanup

*: account_invoice_extract, approvals, documents, documents_spreadsheet_bundle,
mail_enterprise, voip, web_studio, website_helpdesk_livechat.

task-2792108

closes odoo/enterprise#25326

Related: odoo/odoo#86526
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

663108936a9911e00a27f5733886aa00d8f31508	663108936a9	2022-03-09	Louis Wicket (wil)	[FIX] voip: properly escape reason phrases

Reason phrases are escaped using a no longer existing function. This
commit solves the issue by importing the right function.

closes odoo/enterprise#25146

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

14c50215f3d5e11dfdac847568bcd74214b1507b	14c50215f3d	2022-02-17	tsm-odoo	[IMP] mail_enterprise, *: use python model definitions during tests

*: approvals, voip.

task-2767820

closes odoo/enterprise#24486

Related: odoo/odoo#84828
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

a3b1e9ebc3036616a6889ac9d08c1f5dd34d3803	a3b1e9ebc30	2022-03-09	Louis Wicket (wil)	[FIX] voip: move user agent init after listeners

Errors triggered during the initialization of the user agent using
sip_error are not caught since the event listeners have not yet been
added.

This commit solves the issue by moving the instanciation of the
UserAgent after the event listeners have been added.

closes odoo/enterprise#25140

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

4844d6c1008731ed244ef9cceb2325b676023dc8	4844d6c1008	2022-03-04	Louis Wicket (wil)	[IMP] voip: properly start voip service

Part-of: odoo/enterprise#24970

bede4389898104c8b19cccc9948d861d03b3280e	bede4389898	2022-03-04	Louis Wicket (wil)	[IMP] voip: fix broken tests

Part-of: odoo/enterprise#24970

4ee799d4950ad4f8fd2de44dd03503471a008552	4ee799d4950	2022-03-03	Louis Wicket (wil)	[IMP] voip: replace trigger ups with bus events

Replace `trigger_up`s in `user_agent.js` with bus events.
The reason for this change is to remove the dependency of the user agent
on the legacy EventDispatcher to allow it to be rewritten as a model.

Part-of: odoo/enterprise#24970

f4464cb55b9b1fb47ea5fcb587f1236a3d43736f	f4464cb55b9	2022-03-03	Louis Wicket (wil)	[IMP] voip: remove dead code

Part-of: odoo/enterprise#24970

9b8b84ad1846574f3551fac630a298265484456f	9b8b84ad184	2022-02-15	Louis Wicket (wil)	[IMP] voip: adapt transfer to sip.js 0.20

closes odoo/enterprise#24160

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

25db5caf33c6ddfc2895915a99fe296c91ca24ef	25db5caf33c	2022-01-25	Louis Wicket (wil)	[IMP] voip: update sip.js library

This commit updates the SIP.js library from v0.13.8 to v0.20.0.
The new SIP.js API is substantially different from the old one and
introduces many breaking changes, including:

+ Replacing all events with "delegates"
+ No longer providing any interface to catch userMedia events
+ Renaming classes, for example: UA -> UserAgent
+ Renaming/deleting/reorganizing User Agent/SD-handler options
+ Replacing registration methods on UA with a new class Registerer
+ Replacing invitation methods on UA with a new class Inviter
+ Replacing plain text URIs with instances of the new class URI

Reasons to upgrade the library are:
+ Better compliance with the RFC and therefore better compatibility
+ Fewer lines of code
+ Interesting step for further refactorings

Part-of: odoo/enterprise#24160

e0fb715f24ef60ce45c38f915de0123dab1974da	e0fb715f24e	2022-03-01	Louis Wicket (wil)	[IMP] voip: document old attributes

Part-of: odoo/enterprise#24160

a207090d40f0785d60866973b903d1da5766dcac	a207090d40f	2022-02-15	bit-odoo	[FIX] voip: call activity auto-close note contains html

Before this commit:

when scheduling a call activity and making the call with VOIP then end the call,
the activity is resolved, and there is a note left on the chatter, but
currently, it contains HTML.

After this commit:

The note will not contain any HTML content.

Task-2717666

closes odoo/enterprise#24581

X-original-commit: f5750b03b7bc340996a40561ddb203e57b3137b3
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

ea397d1aa1d8afd7ba90631656a20e377959fe5f	ea397d1aa1d	2022-02-17	tsm-odoo	[IMP] mail_enterprise, *: make mail module's beforeEach functions async

*: account_invoice_extract, approvals, documents, voip, web_studio,
website_helpdesk_livechat.

task-2767820

closes odoo/enterprise#24489

Related: odoo/odoo#84845
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

198df7c57009a01d484828b47e9c0f8d70e26ed4	198df7c5700	2022-02-14	Louis Wicket (wil)	[IMP] voip: clean up user agent

This commit cleans up the code in preparation for the update of the
SIP.js library.

+ remove unused import
+ rename _onAccepted -> _onOutgoingCallAccepted
+ reorder functions
+ update documentation
+ remove unnecessary new line
+ add missing new line
+ fix trailing commas

closes odoo/enterprise#24336

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

9f0b83e5b7d6fa6934439661ef53687770959183	9f0b83e5b7d	2022-01-28	stefanorigano (SRI)	[REF] voip, web_* : use odoo icons

This commit is part of v16 overall restyle (task-2704984).

community: https://github.com/odoo/odoo/pull/83501
task-2745275

Part-of: odoo/enterprise#23848

4e0200e81042d354bb375cb5b2e21aa7cdc3a7d4	4e0200e8104	2022-01-25	Sébastien Theys	[IMP] mail, *: batch and avoid duplicate chatter data rpc

* = account_followup, approvals, documents, voip

task-2742754

closes odoo/enterprise#23666

Related: odoo/odoo#83189
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

8ffbbb4971747c3476877fec6570c08402e91997	8ffbbb49717	2022-01-10	Alexandre Kühn	[IMP] voip: remove manual need to bind record methods in _created

Task-2731656

closes odoo/enterprise#23343

Related: odoo/odoo#82444
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

b96b6ad6f7bf24b4d196a8a87f38a01d342590ca	b96b6ad6f7b	2021-12-17	Didier (did)	[IMP] approvals, sign, voip: adapt to the activityView model

part of task-2579306

closes odoo/enterprise#22506

Related: odoo/odoo#79538
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b536a336b1dbe216afea71f3ac7d1d2756ef8d60	b536a336b1d	2021-12-17	Didier (did)	[IMP] approvals, voip: use mock server for activity test

closes odoo/enterprise#22941

Related: odoo/odoo#81502
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

b395a698af65b4d63459aec60a0cfc7816fba8df	b395a698af6	2021-11-29	Louis Wicket (wil)	[IMP] approvals, sign, voip: rename activity model

Rename javascript model 'mail.activity' to 'Activity' in order to
distinguish javascript model from python model.

Part of task-2701674.

closes odoo/enterprise#22593

Related: odoo/odoo#80555
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5d1aea37a63864e09cde9e22693f96586a5a8882	5d1aea37a63	2021-10-26	Louis Wicket (wil)	[IMP] mail_enterprise,*: change model declaration syntax

 * = approvals, voip, website_helpdesk_livechat

This commit will change the declaration of the models with the aim of
getting closer to a plain JSON-object. It allows us to eliminate a wide
portion of boilerplate code, making the declaration shorter, more
declarative, and less redundant, but mainly, it prepares the ground for
further changes.

Task-2695223

closes odoo/enterprise#22042

Related: odoo/odoo#79259
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

9aee11894b81cc55cd72f3000a4e328cb4d63875	9aee11894b8	2021-10-05	std-odoo	[IMP] voip: hide the VOIP settings for a portal user

Purpose
=======
Hide the VOIP for a portal user because it makes no sense for him
(it makes sense only for internal users).

Task-2508521

closes odoo/enterprise#21420

Related: odoo/upgrade#2890
Related: odoo/odoo#77766
Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>
Co-authored-by: nounoubensebia <neb@odoo.com>

ed7df3c525a91dcefbde33919cf5af167170633a	ed7df3c525a	2021-10-28	Didier (did)	[IMP] mail_enterprise, *: improve longpolling bus notification format

* = delivery_iot, documents_spreadsheet, snailmail_account_followup, voip,
    website_helpdesk_livechat

The aim of this PR is to improve/fix various flaws and limitation of the current
API, to make it easier to use and more efficient.

Notification are now defined with 3 distinct parts:

- the channel determines which client(s) should receive it
- the type determines how it should be handled
- the payload determines any extra information helpful for handling it

Channel
=======

Business code
-------------

- Record channel is introduced for ease of subscribing to and sending
  notifications to specific partners, channels, documents, ...
- String channel is still supported (but it is converted internally to the tuple
  channel).
- Tuple channel is still supported without any change (but should be avoided
  whenever possible due to its complex syntax).

The channel is no longer sent to the client. When the channel was used for
business purpose, the information it contained has been moved into either the
new type, or the payload itself.

Technical note
--------------

All channels are now internally converted to the tuple (db, ...) channel, which
is necessary for the platform code (saas/sh).

Internally, the bus.bus table is not changed, type and payload are grouped
together into what was (and still is) called message.

Type
====

Type is introduced to uniformize the way notifications are sent and handled.
All existing notifications already had some kind of manually-built type in them.
This is now officially supported at the bus API.

In client code this will allow (to be done in future commits) to register one
handler per specific type, instead of having to iterate and to filter all
received notifications on every handler.

Payload
=======

Payload (ex message) did not change, it can still be anything depending on
business needs.

Few adaptations:
- When the type was included on the payload, the type has been moved to the new
  type parameter.
- When the channel was used in business code, its data has been copied into the
  payload.

task-1891151

closes odoo/enterprise#21998

X-original-commit: 044d7e7c45f10d97143b5e8a25855cd185bc7229
Related: odoo/odoo#79201
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

77ee0b0b21bda08074ac329e845ca23c9b59acc3	77ee0b0b21b	2021-09-27	Thibault Delavallée	[IMP] voip: improve wording when failing to create a phonecall from activities and add tests

Purpose is to be a bit nicer to the user. We also add a few functional tests
to begin improving testing of activities in submodules.

Task-2657021

Part-of: odoo/enterprise#21200

5988ed14797dd8dc8516d09b1594360311be1e4d	5988ed14797	2021-09-27	Thibault Delavallée	[IMP] test_mail_enterprise: include voip and check its impact

We add voip dependency in test_mail_enterprise in order to test features and
additional workload linked to VOIP management in activities. Notably query
counters are updated and added to check a bit current performance state.

Task-2657021

Part-of: odoo/enterprise#21200

61d4b329ecf51633f5a54de0fc8f6031f496d03d	61d4b329ecf	2021-10-19	Pierre Paridans	[FIX] voip: click on PhoneField value should trigger native call handler

When VOIP module is installed, this commit ensures click event on a
PhoneField's value is only prevented when Odoo's VOIP should handle the
call.

Steps to reproduce:
- ensure "voip" and "contacts" apps are installed
- ensure voip's settings are set to "prod" without proper credentials
- open a partner in Contacts app
- click on the phone/mobile number
=> native call handler (SIP softphone, mobile phone app...) should open
but doesn't!

opw-2654620

closes odoo/enterprise#21866

X-original-commit: 3aefabc7c3093873d854ce44e4f5189aa6f6a160
Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>
Signed-off-by: Pierre Paridans (app) <app@odoo.com>

f1e55be7c7495bc69851555d2239b4ce15f9170c	f1e55be7c74	2021-09-16	Sébastien Theys	[IMP] mail_enterprise, *: adapt test utils and identifying fields

* = approvals, voip, website_helpdesk_livechat

closes odoo/enterprise#20964

closes odoo/enterprise#21426

Related: odoo/odoo#76718
Related: odoo/odoo#77779
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

125b067b29520aacb44acfe997f515db1a415575	125b067b295	2021-06-18	qmo-odoo	[MOV] voip: move phonecall category selection in mail module

In order to ease the mail.activity meetings management, we move the 'phonecall'
category into the base 'mail' module.

Check community commit for more details.

Task-2486126
COM PR odoo/odoo#75530
UPG PR odoo/upgrade#2775

closes odoo/enterprise#20431

Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>
Co-authored-by: Aurélien Warnon <awa@odoo.com>

a0380d6e85c916ee5e6fac6de0ab25838bb31ab5	a0380d6e85c	2021-09-01	Louis Wicket (wil)	[IMP] mail_enterprise, *: add support for guest users

* = approvals, documents, social_instagram, voip, website_helpdesk_livechat

task-2494829

closes odoo/enterprise#20417

Related: odoo/odoo#75496
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

7a5ccb73402ef9ab35001da0de67e1067ed8cf16	7a5ccb73402	2021-08-24	Zelong Lin	[REF] *: convert JS files to ES6 modules

* = hr, hr_holidays, sms, snailmail, website_livechat, account_invoice_extract,
approvals, documents, mail_enterprise, calendar, crm, mrp, note, website_slides,
crm_enterprise, sign, social, voip

task-2510656

closes odoo/enterprise#19241

Related: odoo/odoo#72712
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

ff5c4e1f5352c268c68693d1e6ca3553b4ba3d2e	ff5c4e1f535	2021-08-19	Sébastien Theys	[IMP] mail_enterprise, *: access messaging and models without env

* = account_followup, approvals, hr_appraisal, sign, voip

Part of task-2582313

closes odoo/enterprise#20343

Related: odoo/odoo#75286
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

0a0ed15249e0855f5058e7dc181f7e50ebe92034	0a0ed15249e	2021-08-17	Samuel Degueldre	[REF] *: adapt usage of messaging components

*: approvals, documents, mail_enterprise, sign, voip, web_studio

community PR: odoo/odoo#74982

closes odoo/enterprise#20304

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

b18bb819754a5afdbcee378baedde382f6c8205f	b18bb819754	2021-06-30	Xavier Morel	[REM] voip, sign: overrides to removed mail templates
9632f5362abd4415bd3c5bbe1bc372178b19cdd2	9632f5362ab	2021-05-27	Qiuyu (QHO)	[IMP] voip: call activity should also use mobile number

Currently call activity only uses phone number of the related partner.
After this commit, mobile number will be used if phone number is not existing,
or both mobile and phone number will be presented if they are both existing.

task id: 2528865

closes odoo/enterprise#18562

Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

fc5de53d589de65762ad6226bffb1a310768a919	fc5de53d589	2021-06-29	Aaron Bohy	[FIX] voip: display notification when making a call

Before this commit, it crashed when you clicked on a phone number
in a form view, with voip installed. A call to the notification
service was still using the former api.

closes odoo/enterprise#19332

Signed-off-by: Géry Debongnie (ged) <ged@openerp.com>

696c0697bbade71c1c6c5d23edbf7f04280ccc97	696c0697bba	2021-06-15	Xavier Morel	[FIX] voip: warnings during tests

During voip tests, multiple warnings pertaining to hanging up on calls
with no id (voip/static/src/js/phone_call.js::PhoneCall#hangUp) are
emitted.

These warnings are caused by the RPC handler always returning empty
arrays rather than sensible mock data for the call being intercepted.

The specifically problematic are the various `create_` calls, which
should return something with an id in both "autocall flow" and "call
from recent tab + keypad".

While at it, update the mockRPC callback to be less weird e.g. switch
the huge sequences of if/if/if to a single switch, don't return
anything from `hangUp`, update the manual Array#find, and re-enable
the final `hangup_call` in "call from recent tab + keypad" as it now
works properly instead of triggering a warning.
e5159c2e9039e86f73d2a1b296471bd0b4d72ba1	e5159c2e903	2021-06-25	Didier (did)	[IMP] mail_enterprise, *: use explicit export instead of default

* = approvals, documents, sign, voip, web_studio

Exporting directly on the line of the class or variable definition is less lines
of code and less repetition (and risk or mistake).

Exporting with a name instead of default allows to catch typos more easily when
importing and ensures the same name is used for consistency (and ease of grep).

closes odoo/enterprise#19224

Related: odoo/odoo#72597
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

4f31cd886798c1ddacf2433ecfdaad488ab4d590	4f31cd88679	2021-06-23	William Braeckman	[FIX] voip: changing res_users view

Change below introduced a new group on the res.users form view which
unwantedly changed how the view looks (removing the label from the
signature field), the group doesn't seem to be necessary or user
anywhere else.

See https://github.com/odoo/enterprise/pull/9246/files#diff-975b2fe2510bf8daaaaf6a1fd28ff4ae710d892a1e3a6895d08b49e035cbdfcbR30-R32

Task ID: 2580167

closes odoo/enterprise#19197

Signed-off-by: Yannick Tivisse (yti) <yti@odoo.com>

f09023bd6b910166c7f16f52bd4158b561c4d4c9	f09023bd6b9	2021-06-16	Bruno Boi	[REF] voip: pass bus in props of systray item and dialing panel

... instead of exposing it in the voip service API (it is an
internal bus).

fb3af4537ea337a993283926abd4b5f565c0b43e	fb3af4537ea	2021-06-14	Louis Wicket (wil)	[FIX] voip: remove limit to fix internal transfer

The minimum length of a phone number being set to 10, it wasn't
possible to internally transfer a call (internal numbers being shorter).
This commit removes the minimum characters constraint so that we can
transfer a call to a number as short as an internal number.

closes odoo/enterprise#19008

X-original-commit: 3b3c5f8490b5dfb1e30f3b91f9b82e23c8159ae6
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e88c76525a2aa3f62535cd83179d330b6d6c4187	e88c76525a2	2021-05-26	Louis Wicket (wil)	[FIX] voip: don't display error on hangup

- No longer display an error when the user hangs up on their own before the
session is established. This error was confusing enough that some people
reported it as a bug.
- Add '600 Busy Everywhere' to recognized status codes.

closes odoo/enterprise#18553

X-original-commit: 1de46af06d541d1c6a2a27e4fbeeacb32d08c1d0
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

90b4b4d528b4ed456a897d7ec714d478de09c4ab	90b4b4d528b	2021-03-25	Romain Estievenart	[FIX] voip: Avoid double dialing panel display on mobile devices

When opened on a mobile device (smartphone or tablet), both the native
Dialing Panel and the virtual one opens when composing a phone number.

This commit sets the DialingPanel Widget's flag to detect such
environment and properly hides the virtual dialing panel when the native
one is available.

Steps to reproduce:

1. Open VOIP panel
2. Click on dialing panel to compose a phone number
3. Both dialing panels are displayed => bug

Task ID: 2495658

closes odoo/enterprise#17430

X-original-commit: 4c0a14f932bdc3c6acf311d5d959529f665cbef7
Signed-off-by: Pierre Paridans <pparidans@users.noreply.github.com>
Signed-off-by: res-odoo <res-odoo@users.noreply.github.com>

27be4770ed37ed42d94a86983bad68710157cd02	27be4770ed3	2021-03-12	Qiuyu (QHO)	[IMP] approvals, voip: replace `[]` commands by FieldCommands

closes odoo/enterprise#17036

Task-id: 2453408
Related: odoo/odoo#67643
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

fd3ed79cd0eefbeeb1b3821774d7463158549588	fd3ed79cd0e	2021-02-22	bit-odoo	[FIX] voip: delete call in queue

Before this commit:

Method delete_call_in_queue is sending on the bus res.partner but it is sending
the user id instead of the partner id.

After this commit:

Method delete_call_in_queue is sending on the bus res.partner with the the
partner id.

Task-2464546

closes odoo/enterprise#16689

X-original-commit: b55547ed2bc0fa4fb1faff25b7542494224a4b88
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

7d28b65599efef70d3f92d05c9b780b4f60720fd	7d28b65599e	2021-02-15	Ipsita Borisagar	[FIX] voip: traceback when hanging up the call

Before this commit:

An activity "call" is already marked as "done" in chatter, after that user
schedule an activity "call" again and actually make that call and hang up the
call, traceback will be occured. And another issue is when page will be
refreshed, this activity will be marked as "done" and appears in chatter.

After this commit:

Hangs up the call for the second time, the activity will be marked as
"done", and appear in the chatter with the original notes ( in "Today"
activities section ) without any traceback.

Links

PR https://github.com/odoo/enterprise/pull/16464
Task- 2457219

closes odoo/enterprise#16683

X-original-commit: 56944bad19d771e8c9d6a9d668042f150cefcd50
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

1dbc514e9bc480056e0eccbe51d44611a52380ea	1dbc514e9bc	2021-01-15	ijas ahammed	[IMP] voip: adapt the tests related to phone widget

This commit adapts the test cases related to changes made in
phone widget with PR https://github.com/odoo/odoo/pull/63735.

closes odoo/enterprise#15777

Task-id: 2345974
Related: odoo/odoo#63735
Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>

2f6f98ce1d62c0618fca473385e6360eba32dba3	2f6f98ce1d6	2020-12-24	Pierre Paridans	[FIX] voip: avoid permanent override of the back button

The commit odoo/enterprise@b9c50fd28f162f4cba01c07c05bdc5bced1aeb78
enabled the back-button support for VoIP's DialingPanel.

Sadly when the `voip` module is installed, the DialingPanel is
immediately instantiated by the WebClient and appended to the DOM at
launch.

Once attached to the DOM, the `BackButtonEventMixin` overrides the
default back-button behavior... but in this case, this override should
happen only when the DialingPanel is displayed, not just attached to
the DOM.

In practice, when the `voip` module is installed, the back-button
behavior is overridden all the time by the DialingPanel widget.

This commit fixes it by only enabling/disabling the back-button override
when the widget is actually displayed (independently of its presence in
the DOM).

Task ID 2148384

closes odoo/enterprise#15594

X-original-commit: 19903365dc0562b95570aa4e8ed5fe8e607b166c
Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>

715374e490114d24b77c1b84fb192da668a74257	715374e4901	2020-11-25	Krina Oza	[IMP] various: Updated App icons for various modules

In this commit icons of the following modules are updated:

-account_auto_transfer
-account_bank_statement_import_ofx
-account_bank_statement_import_qif
-helpdesk_account
-helpdesk_fsm
-helpdesk_repair
-helpdesk_sale_coupon
-helpdesk_stock
-helpdesk_timesheet
-hr_expense_extract
-website_helpdesk_livechat
-website_helpdesk_slides
-website_helpdesk_forum
-voip_onsip
-timer
-project_forecast
-payment_sepa_direct_debit
-industry_fsm_stock
-industry_fsm_sale

TaskID:2378861

closes odoo/enterprise#14958

Related: odoo/odoo#62291
Signed-off-by: Yannick Tivisse (yti) <yti@odoo.com>

a06c3b1dd93eb7204ebc432b0836d46d05b4d671	a06c3b1dd93	2020-10-30	Emilien Durieu (edu)	[FIX] voip: close widget on click partner

Clicking partner did not have the same behavior as the other button, namely the widget
would not fold.

task-2326328

closes odoo/enterprise#15007

X-original-commit: 1c293dd81c97f6cd77e1e1573fc5bf2af7ee4658
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e9c57d22e75df467b6735ff0d297f632a597a63d	e9c57d22e75	2020-10-30	Emilien Durieu (edu)	[FIX] voip: fix traceback on missed call edge case

There's an edge case when the widget is open and someone calls then hangs up immediately
where the softphone of the receiver still thinks the call is ongoing.
When trying to reject or accept the call, the lib crashes.
This is a not so great fix that checks for that state of affairs and prevents the
acception/rejection from happening.

task-2326328

X-original-commit: d718ba35232063b06f3897ea4b0175063165b424
9b5421d5ce1900a2377a4dc04f02bcf3108c2b1a	9b5421d5ce1	2020-10-30	Emilien Durieu (edu)	[FIX] voip: button disappeared on mobile with long call history

Buttons in the bottom of the widget disappeared because the history was taking full size.
It also prevented the history from loading completely since additional lines were loaded on scroll, which didn't happen because no scroll bar would appear.

task-2326328

X-original-commit: 1e2386ce34ead1e3ee5e4bafcde75592c0c56538
d22de08172b2df3671b463b6cf82bf01e356086a	d22de08172b	2020-10-09	Emilien Durieu (edu)	[FIX] voip: mobile app crashing when missed calls

`_toggleFold` was calling `_onToggleDisplay` which was calling
`_toggleDisplay` which in turn was calling `_toggleFold`, calling rpc
procedure in the meantime, thus crashing both the server and the client.

task-2326328

X-original-commit: 97c41b9f96ce2a83db7eebab061ba73e5f42ea59
ea3cde7efc0895ed202179b985f7b733159d3bbe	ea3cde7efc0	2020-10-09	Emilien Durieu (edu)	[FIX] voip: framework was complaining about empty fields

Now the fields are added to the context only if they have a value.

task-2326328

X-original-commit: 8a07b2bd761829b011ed8df2e45e765bc5426dea
2cffa257e8de66d459ca63756556715f6ba721e9	2cffa257e8d	2020-10-07	Emilien Durieu (edu)	[FIX] voip: open links in modal instead of main screen

X-original-commit: a099977789b225b125609e84d049cd5124d0ce15
df32d171ab10824d7106f3e8f3569f03a23e9386	df32d171ab1	2020-11-17	Goffin Simon	[FIX] voip: Safari traceback with incoming calls

Steps to reproduce the bug:

- Log as user on Safari
- Make an incoming call to your voip number

Bug:

A traceback was raised:

Error: undefined is not an object (evaluating 'window.Notification.requestPermission().then')
https://www.odoo.com/web/content/27161571-49b7377/web.assets_backend.js:10771:353
asyncFunctionResume@[native code]
[native code]
promiseReactionJob@[native code]

Ref: https://stackoverflow.com/questions/38114266/notification-requestpermission-throws-an-error-in-mac-versions-of-safari

opw:2377360

closes odoo/enterprise#14860

X-original-commit: ee15b276d4c62861414292f1bab8a0d74c08858e
Signed-off-by: Simon Goffin (sig) <sig@openerp.com>

a93e0da9edb626102112f35c563338cdeb316110	a93e0da9edb	2020-10-27	Krina Oza	[IMP] various: Update the app icons

Purpose of the task is to update the icon of the various modules.

So in this commitn updated App icons of the following modules:

-helpdesk_account
-helpdesk_fsm
-helpdesk_repair
-helpdesk_sale_coupon
-helpdesk_stock
-helpdesk_timesheet
-hr_expense_extract
-industry_fsm_sale
-industry_fsm_stock
-project_forecast
-timer
-voip_onsip
-website_helpdesk_forum
-website_helpdesk_livechat
-website_helpdesk_slides

Related PR: https://github.com/odoo/odoo/pull/60817

closes odoo/enterprise#14408

Taskid: 2369682
Related: odoo/odoo#60817
Signed-off-by: Yannick Tivisse (yti) <yti@odoo.com>

12c8f17d0906c382a29dcbc2cf644d68ec80e07d	12c8f17d090	2020-10-21	Nathan de Pryck	[FIX] voip: reject call properly

This fix solves 2 encountered issues when
a call is rejected. First of all, if you call
someone which is already in an active call, the
denied answer was not correctly interpreted on the
"caller" side as the session was not cancelled. Now
a message telling that the "callee" is not available
is displayed and the session is cancelled. The second
issue appears when the sip_ignore_incomming fields was
activated. In this case, the call was always rejected.
The problem is that the call may be redirected elsewhere,
on a desk phone for e.g.. The previous solution does not
allows this case.

see: https://tools.ietf.org/html/rfc3261#section-21.6.2 for
status code

closes odoo/enterprise#14341

X-original-commit: 1481ae0dee16bdb426eed1bfbd928b94e59c2163
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

febf478db4e9a6532378b4217a95c16a96f5b094	febf478db4e	2020-10-05	Sébastien Theys	[FIX] documents, voip, web_studio: clean up relations chatter/thread

This will prevent various flicker when using previous/next.

task-2243518

closes odoo/enterprise#13885

X-original-commit: 2ef4a784f7bb0423338c138c5cdf1750ea703556
Related: odoo/odoo#59411
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

105fb1d80618a36099528ce6bce0d696742ab789	105fb1d8061	2020-08-18	Kamesh Patel	[FIX] voip: fix traceback when click on contact icon

Before this commit:

Currently, traceback occurring while going to click on the contact icon once
the call connected (new number)

This is happening because of context value is undefined for email and it fails
while evaluating at val.constructor as 'val' is undefined here

After this commit:

Hence, pass email to context only if partner have an email and now
While going to click on the contact icon once the call connected (new number)
it will be redirected to the specific contacts view without any traceback

LINKS

task-2321014

closes odoo/enterprise#13640

X-original-commit: 9147a4ae28b37170277cade69f73c7583076e47f
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

5e6639fed97a54dc201ccafb28e31cc39b6f2e68	5e6639fed97	2020-09-21	Richard Mathot	[FIX] voip: faster installation on large res.partner tables

This fix allows to install voip in a database that contains
approximately 400K res.partner records.

Before the fix => timeout or MemoryError

After the fix => installation runs in ~6 min

opw-2328605

closes odoo/enterprise#13473

X-original-commit: 99ef99405b03b9e990601614af9df4a85428b867
Signed-off-by: Richard Mathot (rim) <rim@openerp.com>

b3cba1480345c316319c73259f64a3f60581e6a6	b3cba148034	2020-09-23	Sébastien Theys	[FIX] voip: remove unnecessary partnerDisplayName in test

The test does not make use of it and the field was made "read-only" in
task-2322135

closes odoo/enterprise#13478

X-original-commit: 116b078af2d1a4d63315ee1795e2b86c17bf38b9
Related: odoo/odoo#58374
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

6eb44a2eb2d740b9bb3e091a8c14e671769531ef	6eb44a2eb2d	2020-09-21	Sébastien Theys	[FIX] voip: properly use test utils

closes odoo/enterprise#13393

X-original-commit: 387eba0074e5d4373b38b52d0f6a8c4b96906d94
Related: odoo/odoo#58167
Signed-off-by: Sébastien Theys (seb) <seb@odoo.com>

8920f86ca306c07c0b29fc81d334fbd8c38244fc	8920f86ca30	2020-08-20	jbm-odoo	[FIX] voip: Refuse incoming call

Before this commit:
In voip, if we try to refuse an incoming call, the call stops but
starts again one second after. If we refuse a second time this call,
the call stops. So to refuse an incoming call, we must click twice
on cancel button.

After this commit:
Click once on the cancel button is enough to refuse an incoming call.
Technically, when rejecting the call, we send status code 603
(‘Decline’) instead of 480 (‘Temporarily Unavailable’).
More details: https://tools.ietf.org/html/rfc3261#section-21.6.2

TaskID 2309518

closes odoo/enterprise#12974

X-original-commit: e93b65f20088cd3e80f8cdc906043ba0b066a9ac
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
Signed-off-by: jbm-odoo <jbm-odoo@users.noreply.github.com>

9eeb7dcc000e3444a610dc80378c8be08c2d3695	9eeb7dcc000	2020-08-11	Hiral Bhavsar	[FIX] voip: activity details updated after having edited it

Before this commit:

Activity details not updated in the chatter after having edited it from VOIP

After this commit:

Activity details will be updated in the chatter after having edited it from VOIP

LINKS

PR https://github.com/odoo/enterprise/pull/12428
Task-2282592

closes odoo/enterprise#12904

X-original-commit: dc585a75903e9db9135a600886b876d253b46465
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

8b5db609e94c028c8ea080ba2cf2ec9173f1ca4a	8b5db609e94	2020-08-13	Denis Ledoux	[FIX] voip_phonecall: index mail_message_id

Indexing `mail_message_id` on `voip.phonecall`
really helps the performances to delete mail messages
when there is a lot of phonecalls in database.

During a version upgrade, mail messages can be deleted when a model is being deleted.
e.g. deleting `procurement.order` deletes the mail messages related to procurement orders.

```sql
SELECT count(*) FROM voip_phonecall;
 count
-------
 80664

SELECT count(*) FROM mail_message;
  count
---------
 8022420

EXPLAIN ANALYZE DELETE FROM mail_message WHERE id in (SELECT id FROM mail_message WHERE model = 'procurement.order' limit 1000);
BEGIN
                                                                                            QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    Delete on mail_message  (cost=233.19..2877.65 rows=1000 width=34) (actual time=18.263..18.263 rows=0 loops=1)
    ->  Nested Loop  (cost=233.19..2877.65 rows=1000 width=34) (actual time=3.585..14.200 rows=1000 loops=1)
            ->  HashAggregate  (cost=232.75..242.75 rows=1000 width=32) (actual time=3.528..3.915 rows=1000 loops=1)
                Group Key: "ANY_subquery".id
                ->  Subquery Scan on "ANY_subquery"  (cost=0.56..230.25 rows=1000 width=32) (actual time=0.057..3.003 rows=1000 loops=1)
                        ->  Limit  (cost=0.56..220.25 rows=1000 width=4) (actual time=0.051..2.570 rows=1000 loops=1)
                            ->  Index Scan using mail_message_model_index on mail_message mail_message_1  (cost=0.56..615555.95 rows=2801913 width=4) (actual time=0.050..2.410 rows=1000 loops=1)
                                    Index Cond: ((model)::text = 'procurement.order'::text)
            ->  Index Scan using mail_message_pkey on mail_message  (cost=0.43..2.63 rows=1 width=10) (actual time=0.010..0.010 rows=1 loops=1000)
                Index Cond: (id = "ANY_subquery".id)
    Planning Time: 0.396 ms
    Trigger for constraint mail_channel_partner_seen_message_id_fkey: time=51.775 calls=1000
    Trigger for constraint mail_compose_message_parent_id_fkey: time=29.725 calls=1000
    Trigger for constraint mail_mail_mail_message_id_fkey: time=12.991 calls=1000
    Trigger for constraint mail_message_mail_channel_rel_mail_message_id_fkey: time=9.910 calls=1000
    Trigger for constraint mail_message_parent_id_fkey: time=134.675 calls=1000
    Trigger for constraint mail_message_res_partner_needaction_rel_mail_message_id_fkey: time=12.822 calls=1000
    Trigger for constraint mail_message_res_partner_rel_mail_message_id_fkey: time=11.092 calls=1000
    Trigger for constraint mail_message_res_partner_starred_rel_mail_message_id_fkey: time=12.034 calls=1000
    Trigger for constraint mail_tracking_value_mail_message_id_fkey: time=13.142 calls=1000
    Trigger for constraint message_attachment_rel_message_id_fkey: time=11.479 calls=1000
    Trigger for constraint rating_rating_message_id_fkey: time=18.046 calls=1000
    Trigger for constraint res_partner_mail_message_rel_message_id_fkey: time=8.843 calls=1000
    Trigger for constraint voip_phonecall_mail_message_id_fkey: time=41620.315 calls=1000
    Execution Time: 41967.798 ms
(25 rows)
```

Upgrade request 52582
M120914764-zcaevxmq

closes odoo/enterprise#12412

X-original-commit: eef6086d7023d87316a0947ebbb2a21aa45384d3
Signed-off-by: Denis Ledoux (dle) <dle@odoo.com>

767e9123fe627313c75f8eb2c324ea9d8e6e09f6	767e9123fe6	2020-02-27	jbm-odoo	[IMP] voip: improve general usability (back2basic)

Purpose
=======

Improve the usability of VOIP. The main issues we have are the following:
- The matching between a phone number and a contact is poor
- Users completely miss the configuration available in their Profile
- No reporting for VOIP
- Incoming calls can be completely missed if the user doesn't have notifications allowed
- The keypad and the call buttons basically do the same thing
- The usability isn't great

Specification
=============

Lot of small points. But mainly:

- Add a popover to manage transfer call (instead of wizard).
- Improve views.

Check the task pad for a complete description.

closes odoo/enterprise#9351

Taskid: 2008564
Related: odoo/upgrade#1541
Signed-off-by: Yannick Tivisse (yti) <yti@odoo.com>

fd26dc2b04be98d07bc2204f095f78e9a2bb4ed6	fd26dc2b04b	2020-07-14	Xavier Dubuc	[FIX] voip: fix activity override to show phone number

odoo/odoo#54454
task-2296875

closes odoo/enterprise#11904

X-original-commit: af323b3f807e36c8c66df9dc6ad2d5bc0bed86c1
Related: odoo/odoo#54600
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e702cc742dd32745bade67891a5b3171961826b0	e702cc742dd	2020-06-22	Nasreddin (bon)	[FIX] voip: Alter phone sanitizing format

Issue

	Incomming caller ID isn't identified due to '-' inside
	sanitized phone number.

	Sample no match:
	Incomming caller number : 972584082887
	Sanitized number in db: +972 58-408-2887

Solution

	Replace sanitizing format, INTERNATIONAL by E164; it will
	remove all spaces and '-' like the incomimg number.

Voip incomming number must also be in E164 format:
https://github.com/odoo/enterprise/blob/cf19dea77c6a6cff4956e5553ff608da1be9137f/voip/static/lib/sip.js#L10587-L10590

opw-2273126

closes odoo/enterprise#11408

X-original-commit: 48be050ce072f36e4a9e08f10450a13fce75753b
Signed-off-by: Nicolas Lempereur (nle) <nle@odoo.com>
Signed-off-by: bon-odoo <nboulif@users.noreply.github.com>

b9c50fd28f162f4cba01c07c05bdc5bced1aeb78	b9c50fd28f1	2020-01-17	Romain Estievenart	[IMP] voip: Enable VoIP on mobile devices

This commit enable VoIP on the mobile application.
You are now able to choice between a phone call or
a VoIP call when you click on a phone link.

Task ID: 1896607

closes odoo/enterprise#9246

Related: odoo/upgrade#945
Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>

40b6b930a33e8cb9a0c4120e4bf0a1a2e05a2a00	40b6b930a33	2020-01-02	Shreya Thakrar	[IMP] web_enterprise, voip: call queue icon visbility

This commit makes 'Call queue' icon always visible
for small devices which was not the case before.

Steps to reproduce:
1) Open CRM
2) Check the icon on the kanban card of 'crm.lead'

Task ID - 2152124

closes odoo/enterprise#8436

Signed-off-by: Adrien Dieudonné (adr) <adr@odoo.com>

5726cfb96f3b2d397c5f01419849e4f5c114dabb	5726cfb96f3	2020-05-15	Jorge Pinna Puissant	[FIX] voip: no contact shown on incoming call

Since 8c03446f57999ed23d9ee9e77797b22af9606063, to find the contact of
an incoming call, a sanitized process is done to add the international
code if is missing. This relay in the inviteSession.remoteIdentity.uri.type
parameter, which is not always set.

Now a fallback is done, it checks if the last 6 digits of the phone
number corresponds to the last 6 digits of a phone number in the
contact. Like this we can find the contact without having the
international code.

opw-2254068

closes odoo/enterprise#10635

X-original-commit: 1cae30a425161da0dba7e0ea94abf8b6cc23e38c
Signed-off-by: Jorge Pinna Puissant (jpp) <jpp@odoo.com>

5fb6540bdeb434c33955a37a3aaf5b12620dbf44	5fb6540bdeb	2020-05-04	Jorge Pinna Puissant	[FIX] voip: no contact shown on incoming call

Before this commit, for an incoming call, only the phone number was
shown, even if the contact is registered as a contact.

The phone number used to search the contact, has the standard USA
formatting domestic numbers convention '1 (are code) extension', without
international call prefix. The numbers in the contact uses '+' as
international call prefix. For example: 12686152726 call and a contact
using this phone number is searched instead of +12686152726 (which is
the value stored in the db).

Fine-tunning of aabdb279e24be696bcd48d3b79703bdfb2c6c56f

opw-2244047

closes odoo/enterprise#10363

X-original-commit: 8051470d88a803229567d7644cce07379c7c38a8
Signed-off-by: Jorge Pinna Puissant (jpp) <jpp@odoo.com>

278d70039fd4fe65c338dbf831db384ace719b08	278d70039fd	2020-03-18	jbm-odoo	[FIX] voip: Open right partner in a phone call

Before this commit:
When we have a phone call without a partner (If we dial a number for
example), by default, we put the number in this.phone and we won't
have a mobile number. If we click on partner icon, we must jump
to the partner card, and if no partner matches this number, we must
have a new empty partner. But to search the existing partner, we will
match partner that has this phone number or partner that has no
mobile phone. So even we have no partner that has this number,
we will have the first contact that have no mobile phone.

After this commit:
When we click on partner icon, we will have the right partner
(if it exists with this phone number) or a new empty partner form.

closes odoo/enterprise#9396

X-original-commit: 23c20a9798911b6252fca3b46ce7ea9fcac1049c
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

e2a9c1b1f1407547ac6d83b363280f39bc4ea982	e2a9c1b1f14	2020-03-18	Jorge Pinna Puissant	[FIX] voip: no contact shown on incoming call

Before this commit, for an incoming call, only the phone number was
shown, even if the contact is registered as a contact.

The phone number used to search the contact, has the standard for an
international call prefix (double zero), and the numbers in the contact
uses the '+' as international call prefix.
For e.g : 0032412345678 call and a contact using this phone number is
searched instead of +32412345678 (which is the value stored in the db).

Fine-tunning of 8c03446f57999ed23d9ee9e77797b22af9606063

OPW-2187771

closes odoo/enterprise#9347

X-original-commit: aabdb279e24be696bcd48d3b79703bdfb2c6c56f
Signed-off-by: Nicolas Lempereur (nle) <nle@odoo.com>
Signed-off-by: Jorge Pinna Puissant (jpp) <jpp@odoo.com>

f3d00bd38371c1de80086f04d858e24d8efa3aaa	f3d00bd3837	2020-03-16	jbm-odoo	[FIX] voip_crm: Typo with auto_install in manifest

Task ID 2008564

closes odoo/enterprise#9311

X-original-commit: c2c8a0c3fb2dfb42babd16bfd2cfd65dc057008f
Signed-off-by: Yannick Tivisse (yti) <yti@odoo.com>
Signed-off-by: jbm-odoo <jbm-odoo@users.noreply.github.com>

5acd337a20a0923d5bf938d420b7e335dd23d21e	5acd337a20a	2020-01-20	Hiral Bhavsar	[FIX] voip: no dial number when hitting Enter

Before this commit, during a call, when dialing number with click and
then pressing Enter, it was dialing the latest number again. So if we
wrote 12 and press Enter, it will add a 2 and output 122.

This happened because the focus was kept on dial number button, so
pressing Enter still triggered a click on this dial number button.

This commit fixes the issue by setting the focus on to keypad input
after click on dial number. That way, pressing Enter should behave
as expected.

Task-Id 2071310

closes https://github.com/odoo/enterprise/pull/6934

closes odoo/enterprise#6934

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

2822f583c859f2c215bb0347aaa4e04568e47b2f	2822f583c85	2019-11-04	Hiral Bhavsar	[IMP] voip: allow access to the dialpad during a call

This commit allow the access to the dialpad during a call.

Task-Id 2071310

closes https://github.com/odoo/enterprise/pull/6934
d501fd7a8acddc67c10fa2da55132d380e0d5ed3	d501fd7a8ac	2020-02-24	Loan (lse)	[FIX] VOIP: no contact shown on incoming call

closes odoo/enterprise#8979

X-original-commit: 8c03446f57999ed23d9ee9e77797b22af9606063
Signed-off-by: Jorge Pinna Puissant (jpp) <jpp@odoo.com>

6a90b7f9ef85eda5146e06557f565f3b5b5016d1	6a90b7f9ef8	2020-02-07	Romain Estievenart	[FIX] voip: Click on number call the contact

Step to reproduce:

- Open VoIP
- Open the contact tab
- Select a contact
- Click on the phone number => crash

Task ID: 1896607

closes odoo/enterprise#8359

X-original-commit: a45d489508999f9d4f50f15d6633af533a029df9
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

8bd4030ea93f95b57ef7e8e0356f828c164b1175	8bd4030ea93	2020-02-04	Romain Estievenart	[FIX] voip: Display the right contact when clicking on it on Contacts tabs

Step to reproduce:

1. Open VoIP
2. Select the contacts tabs
3. Select one contact (not the first)
4. the first contact is open instead of the previous one clicked

Task ID: 1896607

X-original-commit: a79d3818d2df56e6a56185f9ca91e43123c0d90d
8d866e72ac5143816ecbf6b888718862726d2aeb	8d866e72ac5	2020-02-04	Romain Estievenart	[FIX] voip: Display the right tab content when an user cancel a call at connecting state

Task ID: 1896607

X-original-commit: ee21074eadd6f954666e66e072258400aa6ede0c
2fd3867760c668ce806010b722fadd53f51ae83c	2fd3867760c	2020-02-04	Romain Estievenart	[FIX] voip: Add missing catch when trying an audio play

This is the next part of catching error when we trying to play audio.

The first part was made on this commit: 46d9d6757504f15269d908ef3b2b4e8306d61c92

Task ID: 1896607

X-original-commit: 3258b71767ba32483806afc4ab530e2ae60f3464
56bd37d84ec2c50e279357c8d1972428c44f8647	56bd37d84ec	2020-02-04	Romain Estievenart	[FIX] voip: Check of the WebRTC compatibility support

The WebRTC protocol (used to made a call with VoIP) need a browser support of these 3 web APIs:

- RTCPeerConnection: https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection
- MediaStream: https://developer.mozilla.org/en-US/docs/Web/API/MediaStream
- mediaDevices: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices

With this commit in the goal to avoid some browser crash, we now check if these 3 APIs are
implemented by the user browser.

Task ID: 1896607

X-original-commit: a7192d93c8cd12d694a84a8bc5180d3337c28150
91e35e64e60c7a1bde2da894b1d9fa17703bef09	91e35e64e60	2020-01-28	Romain Estievenart	[FIX] voip: window.Notification could not exist in some case browser

Task ID: 1896607

X-original-commit: 66cd716540a8d2ef1c1f9b6ba269a8330989bea3
e59f987818ffaf83ddff04761dd56e9c764dc07b	e59f987818f	2020-01-30	Romain Estievenart	[FIX] voip: Display the right button when an anwser an call

Step to reproduce:

1. Made a call with a voip devices to another voip device
2. Accept with the dialog the call
3. The button bar still display the accept / reject button
4. So you can easily send and accept / reject SIP command for
the existing current call and made an error on the SIP server.

Task ID: 1896607

X-original-commit: 260b60846e40ace9ae225810c480c8d87c3c0397
82be4a6835bc6a661c07e5d215605d47363fe35c	82be4a6835b	2020-01-15	Martin Trigaux	[ADD] *: add ir.model.access on all transient models

snailmail_account_followup: adapt rule based on the one in the view
l10n_be_reports,sale_ebay: add missing rules
hr_appraisal: allow group_user
timesheet.validation: approver only can access
hr_referral: referral users can use wizard
crm_helpdesk: saleman creates a ticket
	      create done in sudo
delivery_easypost: delivery manager can modify carriers
documents: document users can request documents
helpdesk_fsm: create a task from the wizard
helpdesk_sale_coupon: replace hardcoded checks by ACL
hr_contract_salary: contract manager can generate links
hr_contract_sign: any employee can sign a document
hr_payroll: payroll manager can create payslip and contract manager can modify contracts
hr_payroll_account_sepa: same rule as hr.payslip
industry_stock_fsm: remove hardcoded group by dynamic ACL
iot: only admin as modiy ir.config_parameters
l10n_be_hr_payroll: same rights as hr.payslip
marketing_automation: same rights as source model marketing.campaign
mrp_mps: same as source mps model
mrp_workorder: allow for group user
planning: only manager can create planning records
sale_renting: salesman can create rental orders
sale_renting_sign: sign user can request signature, ACL are checks in python
sale_subscription: only a sale manager can modify subscriptions
		   only a subscription manager can close a subscription
sign: sign user can request signatures
stock_barcode: stock user can create lot

closes odoo/enterprise#7737

Voip: any employee can forward calls
Related: odoo/odoo#43306
Signed-off-by: Martin Trigaux (mat) <mat@odoo.com>

299652a87bc8f8b7639b4f7c9b64c31ddfe9b36a	299652a87bc	2020-01-30	alt-odoo	[FIX] voip: allow install if no country code set on partner

Country code of the user installing voip module can be empty, leading
to an AttributeError. We should not prevent installation of the App.

closes odoo/enterprise#8052

X-original-commit: 592ddff4ae1e38e6345ebb8cee532297329485d5
Signed-off-by: Alex Tuyls <alt-odoo@users.noreply.github.com>

5c14802d97d3ad1b93893b08c78fcea4cb4e8622	5c14802d97d	2019-11-14	Lucas Perais (lpe)	[IMP] voip, payment_sepa_direct_debit, adapt phone widget

Task 2123526

Adapt some views and test to the new feature:
option to send sms is enabled by default on phone widget

closes odoo/enterprise#6706

Related: odoo/odoo#40266
Signed-off-by: Aaron Bohy (aab) <aab@odoo.com>

dc1199bb32b91d3ef15d93bd90f0746a3250bdaf	dc1199bb32b	2020-01-24	Pierre Paridans	[FIX] account,voip: fake notebook misses tabs container

Since commit odoo/odoo@43db60dffa9cc2d99ef59ad384c2f21006ba593e `<notebook>` elements
have also a wrapper element (with class `o_notebook_headers` around
their tabs.

Since VOIP and account modules reuse the markup and styling of the
`<notebook>` but without using the tag itself (cf. done by hand) the
dial-up's and reconciliation line's tabs style were broken.

This commit adds the missing wrapper element and moves the
margin-{left,right} reset to the correct element.

closes odoo/enterprise#7941

X-original-commit: 922cac0cc34df29d8003403edf79e92a6499578c
Related: odoo/odoo#43959
Signed-off-by: Pierre Paridans <pparidans@users.noreply.github.com>

533a7dfe6d390e380c80ed02158147cad851ad85	533a7dfe6d3	2020-01-20	Alexandre Kühn	[FIX] voip: stop ringtones during call

Revision on https://github.com/odoo/enterprise/commit/46d9d6757504f15269d908ef3b2b4e8306d61c92

Commit above introduced an issue where ringtone before call was still
ringing during call, which this commit fixes.

Closes #7800

closes odoo/enterprise#7811

X-original-commit: 77ac65710f23fa1397572d7b1ae2a268df29f393
Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

9c01ea262e2a1b98d70ede10dc26262009571690	9c01ea262e2	2020-01-20	Alexandre Kühn	[FIX] voip: fix "rejecting RTCSession" on making call

Revision on https://github.com/odoo/enterprise/commit/46d9d6757504f15269d908ef3b2b4e8306d61c92

Commit above made significant changes to client-side code of VOIP.
However, it made a slight unintended change in the handling of the
SIP signal INVITE, which in consequences rejected the call session
immediately, resulting in an "rejecting RTCSession" on RINGING.

Closes #7800

X-original-commit: 3c983cac1a5bf93c54c02b85b0eec5e278715ebe
f07318b3985c5028c89ac888f59b0e33af760200	f07318b3985	2019-12-03	Ipsita Borisagar	[IMP] voip: ENTER key should start the call

This commit improves keyboard navigation to start the call when
pressing ENTER after entering the phone number with the dialpad.

Task-Id 2124341

closes odoo/enterprise#7171

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

d09673bc7a189b82f76425e1998a52f2f5e9b3e5	d09673bc7a1	2019-10-29	Thibault Delavallée	[IMP] voip: put phonecalls menu into Phone / SMS technical menu

Purpose is to clean a bit technical menu, notably separating Discuss,
Emails, Mass Mailing and Phone menu entries. Indeed there are quite a lot
of menu entries and finding something is sometimes difficult.

Task 2118599
Community PR odoo/odoo#39460
PR #6539

Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>

41bb70c57dd6010ecb45b5b31407f94a484ed18b	41bb70c57dd	2019-10-08	Nicolas Martinelli	[FIX] voip: consistent variable name

The variable `_currentPhoneCallId` is sometimes called
`_currentPhonecallId`, which leads to crashes when calling from the
activity widget.

We make the variable name consistent accross the files.

closes odoo/enterprise#5968

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

a056a62887645e94555a197bec26c4c08c5f9172	a056a628876	2019-09-20	Alexandre Kühn	[FIX] voip: prevent audio play in tests

This was caused by Chome Autoplay Policy.

Task-Id 2075089

closes odoo/enterprise#5395

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>

b1c4faea8d2a179ea86b096e6d10741c6e7bec7c	b1c4faea8d2	2019-09-03	Alexandre Kühn	[FIX] voip: several fixes

1. search was not working
2. style of active tab header did not change properly
3. phone call with not ID no longer make a crash
4. redirect to partner was creating a record
5. error on call did not give reason from SIP lib
6. making a call crashed (`cannot read 'pause' of 'undefined'`)
7. could not select text (e.g. 'Document') on phone call details

Note that for issue 3, this commit prevents the crash but it does
not the underlying problem. This change aligns the behaviour since
version 11.

Task-Id 2058517
8ec8e93fc343e47d1a147c598804fd43b75b8fe4	8ec8e93fc34	2019-08-20	Alexandre Kühn	[FIX] *, web: Edge does not support obj spread operator

*: account_reports, documents, mail_enterprise, voip

As of August 20 2019, Microsoft Edge partially supports ECMA2018.
For instance, `Promise.prototype.finally()` can be used, but the
spread operator does not work on objects.

Task-ID 2056070

closes odoo/enterprise#5254

Signed-off-by: Pierre Paridans <pparidans@users.noreply.github.com>
acc4fc3a057a40a75f0eccff96b5178081ac5c1e	acc4fc3a057	2019-08-22	Ravi Singh	[FIX] voip: showing name of contact on call

in this commit, we have set the correct attribute(variable's name) to fix
showing the name of the contact on VOIP call panel

task-2056427

closes odoo/enterprise#5232

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
46d9d6757504f15269d908ef3b2b4e8306d61c92	46d9d675750	2019-06-19	Florent Lejoly	[IMP] voip: improvements

Improvements:

- New ringtone to notify user when connection is establishing;
- Rounded corners to VOIP window;
- Improved style of folded VOIP window;
- Removed email button in non-partner calls;
- Can now close VOIP even when configs are invalid or widget is
blocked;
- New "connecting..." screen when connection is establishing;
- Automatically display unfold VOIP window on incoming call;
- Temporarily block VOIP while microphone access is denied and trying
to either call or receive a call;
- New distinction between answered/missed/rejected calls;
- Update sip.js lib to v0.13.8;
- Code cleaning.

Known issues:

- When microphone permission is denied, it displays a crash error
instead of blocking UI temporarily and requesting user to activate
microphone. This is caused by conflict between unhandledrejection
polyfill and sip.js lib
(see https://github.com/odoo/odoo/commit/3b133f6f2c54ac8fb0a2ca415761eb6e872ac474)

Contributions:

- New features and Python code cleaning by Florent Lejoly <fle@odoo.com>
- Javascript code cleaning by Alexandre Kühn <aku@odoo.com>

Task-Id: 1913470

Co-Authored-By: Alexandre Kühn <aku@odoo.com>

closes odoo/enterprise#3562

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
8033614d52346705a5ce4570fdfc3ed26c47527a	8033614d523	2019-07-17	Julien Castiaux	[IMP] voip: show partner name instead of number

Set a phone number on a partner, make that partner call Odoo, his phone
number is shown instead of his name.

Task-ID 2034004

closes odoo/enterprise#4937

Signed-off-by: Pierre Rousseau (pro) <pro@odoo.com>
e49106adf98c0cbf71b28f3c55f05790496ab1cb	e49106adf98	2019-06-24	Pierre Rousseau	[FIX] voip: unable to accept call on chrome

Before this commit, we were not able to accept a call on chrome if the user doesn't click on the page, because the play function requires some user interaction beforehand.

closes odoo/enterprise#4637

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
9b9dc9e1123d4e8db3dd1ea6b047667d7b44dbe3	9b9dc9e1123	2019-06-14	Nathan de Pryck	[FIX] voip_onsip: fix the login to onsip

Previously, it was not possible to login to
onsip. The connection was always forbidden
because it does not collect all the configuration
arguments. In order to fix it we override the
method to gather all the config parameter from the
voip user agent.

opw-2008473

closes odoo/enterprise#4579

Signed-off-by: Pierre Rousseau (pro) <pro@odoo.com>
6890e797e5bb5a57fa0a74d4e853fe007fc116a4	6890e797e5b	2019-06-13	Pierre Rousseau	[FIX] voip: do not work on sip session in demo mode

Steps to reproduces:
* Install VoIP
* Make a call (in demo mode)
* Mute or send a DTML
=> Traceback

This behavior was due to function calls on a sip session, which does not exist when VoIP is in demo mode.
This commit fix this by adding a check on all the concerned functions.

Task-ID: 2009502

closes odoo/enterprise#4571

Signed-off-by: Rémi Rahir (rar) <rar@odoo.com>
00872278c8673b9697ecb9f4855a24c91f3c648f	00872278c86	2019-06-27	Thibault Delavallée	[MOV] voip: move JS code related to fields in its own file

Otherwise it is quite lost in a big JS file. Purpose is to prepare future
modification of phone widget and voip integration inside it.

Related to task 1922163
Linked to community PR odoo/odoo#34516
Linked to PR #4707

Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>
94970b3b12bc98623612fa918a5379f819526b83	94970b3b12b	2019-06-06	Florent Lejoly	[FIX] voip: uncatched promises

Before this commit it was impossible to make a call from the recent tab due to some uncatched promises.
This commit fix the issue and add tests in order to avoid this in the future.

closes odoo/enterprise#4265

Signed-off-by: Pierre Rousseau (pro) <pro@odoo.com>
3003e7dcd13591ab1b357329849519ddcc28a6f0	3003e7dcd13	2019-06-05	Toufik Ben Jaa	[FIX] voip: keypad button on phone widget hidden

- In certain circumstances the bottom button to access
the VOIP keypad was hidden.

This happens when you have a lot of recents call, activities that then
hid the buttons.

closes odoo/enterprise#4514

Signed-off-by: Quentin Smetz (qsm) <qsm@odoo.com>
acdc96b4d856f5c966ae9ca24f8fd12c59740b59	acdc96b4d85	2019-06-03	Olivier Dony	[FIX] voip: fix typo in c21f9ac54b23b57fd3a6193497a7aebeb3f923b7

This enumeration is meant to be done on `messages`, as indicated by the
name of the enum variables. There is a 1-to-1 mapping between `messages`
and `self` after calling super(), because each activity results in a new
message. Additionally, after super() the activities in `self` are
deleted and should not be used.

Related to odoo/enterprise#3441 and Task-1915004

b1fd737fcbcf572e61fa57539e4f1fed4766402e	b1fd737fcbc	2019-04-25	Sapan Zaveri	[IMP] account_reports: phone should be clickable on follow-up reports

Purpose of this task is, on the follow-up reports,
the phone and mobile numbers of the contact are indicated.
the user can now directly call those numbers by clicking on them
So I made the phone number clickable on follow-up reports.

here we need to check for the voip  so added name on voip and if voip
installed then do the direct calling from voip.

Task- 1965862

closes odoo/enterprise#4077

Signed-off-by: Alexandre Kühn (aku) <aku@odoo.com>
12b3c8d1cdfda64bbe13528f08c0cb11bcbfb466	12b3c8d1cdf	2019-02-26	Prakash Prajapati	[IMP] voip: allow to access VoIP tab behind modal

When a modal is opened, there's no way to hang up on VoIP
as the VoIP tab is behind the modal.

This commit improves the behavior by making VoIP tab
accessible even when a modal is opened.

task-1911276

closes odoo/enterprise#3725

Signed-off-by: pimodoo <pimodoo@users.noreply.github.com>
43c51311e02e03a48921554eb5875d38ef410cf2	43c51311e02	2019-04-01	Pierre Rousseau	[FIX] voip: discard bad incoming SIP message

Before this commit, if a malformated incoming SIP message is received by the UA, a traceback occured.
Now, a warning is logged, as SIP.JS do in the new version:
https://github.com/onsip/SIP.js/blob/88f356a9063b575de5732dbb68a791724fb9728d/src/UA.ts#L640

closes odoo/enterprise#4036

Signed-off-by: pimodoo <pimodoo@users.noreply.github.com>
bf7458d8af52017c5ee430cfcf7201728aaf99d6	bf7458d8af5	2019-02-25	Toufik Ben Jaa	[FIX] voip: forwardport fail, missing comma

closes odoo/enterprise#3717
6767c63e2d4a6c738c8a98cc1f7587fc538985e2	6767c63e2d4	2019-03-06	Vincent Schippefilt	[REF] voip: adapt code after jQuery update

Part of task 1896658

Co-authored-by: Aaron Bohy <aab@odoo.com>
Co-authored-by: Christophe Matthieu <chm@odoo.com>
Co-authored-by: Mathieu Duckerts-Antoine <dam@odoo.com>
Co-authored-by: David Monjoie <dmo@odoo.com>
Co-authored-by: Martin Geubelle <mge@odoo.com>
Co-authored-by: svs-odoo <svs@odoo.com>
Co-authored-by: Vincent Schippefilt <vsc@odoo.com>
2c7cf81836ddc1b9b9a46292243d19c877c68c5c	2c7cf81836d	2019-02-19	Rémi Rahir	[FIX] voip: fallback on keypad when no phonecall found

Since last refactoring, users could only use the searchbar to filter
existing phonecalls and not to dial a phonenumber anymore. This was done
on purpose to trigger specific events for every tab.

This commits allows a fallback behaviour; when the search term does not
return any result, the user can hit the 'call' button and will be
redirected to the keypad where he can dial any number.

closes odoo/enterprise#3677
5d5c2449cbfb5c6afb0585ebf9b9e0ee4e5063cd	5d5c2449cbf	2019-02-18	Rémi Rahir	[FIX] voip: don't use static values for height

Backport of commit 1b7feef4da284a38e69bfe181e1c273cecf21a21

closes odoo/enterprise#3671
ccd195e2b6ada4ec9aff67d783819259b0b49358	ccd195e2b6a	2019-02-18	Rémi Rahir	[FIX] voip: search any description in next activities tab

The code that filters the next activities uses the search term as a
regular expression which mean that any search beginning with '+', '*'
will crash at the creation of the RegExp object.

This commit escapes the specific symbols proper to regexpressions since
we don't actually need them.
e472e137a9e72a3357c9f42cff18c385f544724d	e472e137a9e	2019-02-20	Pierre Rousseau	[FIX] voip: allow debug mode

Since 58365ad9d529a924c84fd43d942a04d9f6c5d135, there is a check to enable or disable the logging in console.
However, the param 'debug' was never sent to the client.

closes odoo/enterprise#3686
1b7feef4da284a38e69bfe181e1c273cecf21a21	1b7feef4da2	2019-02-18	Rémi Rahir	[FIX] voip: don't use static values for height

The fix proposed in 67d59a5903d01245d592542ec40d32f444134ac5 had weird
behaviours in mobile view because in said views, the dial panel takes
the whole screen. The 420px height limit meant that only 420px out of
1080 (for an hd screen) would be used by that class, leaving 660 for the
bottom dial buttons which broke the layout completely.

closes odoo/enterprise#3664
6d5f817616f744e6348c3318012acb52eda3aebc	6d5f817616f	2019-02-13	Rémi Rahir	[FIX] voip: toggle on inexistant variable

Small typo on variable name introduced when improving the interface in
b1c0b95530786d8043a19801d9a11fe6375649fc.

closes odoo/enterprise#3631
87ee58d570bfbfb3d590f64a6589ebe3aeec9e5e	87ee58d570b	2019-02-05	Nicolas Seinlet	[IMP] voip: has_call_in_queue

Avoid to search in a loop.
As the res_id is on a M2O, a read_group is not usable,
and I guess there not millions of phone calls.

closes odoo/enterprise#3591
ad142a9fb17eb9d3c076fb4f14d0fb85f018e431	ad142a9fb17	2019-02-14	Jorge Pinna Puissant	[FIX] voip: click phone number voip parameter missing

When a VOIP is configured for the company, and a user don't use VOIP
(he didn't configure username and password in the user settings).
When the user click in a phone number:

Before this commit, the pop-up of the VOIP widget is open, a yellow
message telling that the user is calling the number appears, and a
traceback is raised.

Now, the default configuration of the browser is called.

opw-1937924

closes odoo/enterprise#3640
67d59a5903d01245d592542ec40d32f444134ac5	67d59a5903d	2019-02-01	fleodoo	[FIX] voip: chrome issue

-Some buttons where not displayed in the new version of chrome

closes odoo/enterprise#3563
5f7fa74d413f46a9dec067de90558fbda8dace57	5f7fa74d413	2019-01-30	XavierDo	[FIX] voip: inform user when call activity type is wrongly configured

`create_call_in_queue` highly relies on the fact that activity type
`mail_activity_data_call` has 'phonecall' as category. It isn't always the case
since activity type can be edited by users.

In this case, it is possible that a user receives a 'record may have no phonecall'
error message when it is actually linked to activity_type configuration.

This commit adds a better error message in this case,
(and hopefully prevents support team to waste time on related tickets)

closes odoo/enterprise#3546
bc90fa4153b2a89ce9ff6ab27a418b95aa3a7ade	bc90fa4153b	2019-01-24	Pierre Rousseau	[FIX] voip: cancel and reject failed

This commit completes f27626607b0e4d372a3cd943940617b9cd6d9568 when the call is rejected by closing the dialog.

This commit also fix the case when a call already finished is cancelled. An error is thrown by the lib:
https://github.com/odoo/enterprise/blob/d1d79944cd3d9a76450184b42949e9bd4d2351d1/voip/static/lib/sip.js#L6863

But the error is not relevant for the end user. So the issue is catched and logged.

opw-1929582

closes odoo/enterprise#3500
95eb8508cf5e9e9cdd802047e5c892a79de7e6c7	95eb8508cf5	2019-01-24	fleodoo	[FIX] voip: Unblock voip if connected

Before this commit, if SIP fails to connect to the websocket at the first try, the phone widget was blocked without the possibility to unblock it.
In addition, the overlay blocked all the widget, including the close icon.

Now, the phone is blocked by default, and unblock as soon as the websocket is connected.

OPW-1931725

closes odoo/enterprise#3495
98a1eec82878a30e98a8534065f16e8eb99b550f	98a1eec8287	2018-12-11	Julien (juc) Castiaux	[FIX] voip: access a partner using his phone number

When clicking on the "customer" button on an ongoing call, a form
to create a new parted was open even if the mobile phone was
already known. This PR search for existing partner for the given
phone number before opening the new partner form.

opw-1913815

closes odoo/enterprise#3260
1aa3afebb1e153fd2d153f8f2bc0911277395373	1aa3afebb1e	2019-01-18	jem-odoo	[IMP] voip: upload document to mark activity as done

This commit only contains adaptation to the new community
feature "upload a document to mark an activity as done"
Indeed, the 'category' field on activity should now be
always visible, as we got 2 entries in mail modules.

Task-1915004

closes odoo/enterprise#3441
c21f9ac54b23b57fd3a6193497a7aebeb3f923b7	c21f9ac54b2	2018-12-18	jem-odoo	[REF] voip: adaptation to new _action_done method

This commit uniformize the "mark as done" method for
activity. The change is done in comminuty edition,
so adaptations are required here.
No functionnal change should be observed as this is
purely technical.

Task-1915004
b1c0b95530786d8043a19801d9a11fe6375649fc	b1c0b955307	2018-10-30	XavierDo	[IMP] voip: improve voip interface and manage autocall

This commit improves a little the voip pannel layout and add the
support for autocall in activities: When calling from activity
tab, each time a call is ended, the next one in the list is displayed.

Since the active call will be set has done once finished, a new option
exists in autocall mode to "postpone" the call, meaning that the activity
won't be set has done. A js counter will register witch call was already
tried in order select next one wisely and keep the already tried one
for the end.
Of course, this information will be lost if refreshing the page.

This commit also contains some cleaning and renaming, like log_note that wasn't used
and get_info() that was called multiple time, when the only information
needed was the id.

Some work should still be done to move the different behaviour to the correct place.

Task: 1892475
f804104dc2581c94384111ef47646a856363ab1d	f804104dc25	2018-10-30	XavierDo	[FIX] voip: sync activity and phonecall date_deadline

Previously, when updating an activity date deadline,
the corresponding phone call was not updated.

Now, writting date_deadline on activities will automatically
update the corresponding phonecalls.

In this case, we also need to notify voip for refresh to
update the displayed phonecall list.

Task: 1892475
3cf575334e53854feaa0118e786c599fba131c2c	3cf575334e5	2018-10-30	XavierDo	[ADD] voip, voip_crm: add call queue widget and mixin

Before previous voip refactoring it was possible to add a lead
to the phonecall list. This commit retore this functionnality
and add a server action to be able to add multiple records
in the next activities phonecall list. Since phonecalls are
linked to activity, it is done by creating a "Call" activity
on each record. To avoid missing anything, a UserError
will be raised if any of the record don't have a phone number.
This server action has been added on partner and leads.

The choice of making a mixin is maybe a little overkill but
will allow to easily add this behaviour on any model later.

The voip mail_activity create has been decorate by model_create_multi,
mainly to be able to create multiple record at the same time but to
send only one refresh_voip notification.

Task: 1892475
1d060d999e46b42e0003302bbf21f81a7c689767	1d060d999e4	2018-11-22	Toufik Ben Jaa	[FIX] voip: correctly display phone call date

- The phone call date were not displayed correctly. They were offset by
  a month (november was displayed as december).

closes odoo/enterprise#3130
4ebf3ab5766319c54cdb6421045240f11065cb10	4ebf3ab5766	2018-11-20	Goffin Simon	[FIX] voip: Uninstalling VOIP lead to traceback

Steps to reproduce the bug:

- Install CRM and VOIP
- Uninstall VOIP
- Schedule a call on a lead

Bug:

A traceback was raised because the value 'phonecall' didn't exist
for the selection field category on model 'mail.activity.type'

opw:1908724

closes odoo/enterprise#3108
f7ea5671667460d4edd4e5ecc78f1184463bc236	f7ea5671667	2018-10-04	mreficent	[REF] voip: rename voip.phonecall type field to phonecall_type

Purpose of this commit is to rename type column to something matching the
the real business use of the field. That way it is easier to find and grep
in the code. It also lessens potential conflicts with type build-in python
function. It also lessens conflicts when using the field in JS as type
is a build-in attribute.

Renaming type column is a long-living issue. We choose to do it at the
beginning of the v13 development to catch errors as soon as possible.

This commit is linked to task ID 1896245. It is also a subpart of community
PR #2807.
58365ad9d529a924c84fd43d942a04d9f6c5d135	58365ad9d52	2018-08-08	Pierre Rousseau	[FIX] voip: SIP.JS 0.11.3

Upgrade the SIP.JS lib to 0.11.3 to avoid all the connections errors
with latest browsers.

Task-1834182
opw-1885216

c692e1a6de6f30364598c4c971179b0cd4cc3297	c692e1a6de6	2018-09-11	qsm-odoo	[FIX] voip: BS4, do not use flex mixins anymore

78eafe8e757a9ed0a43c8626ed4a93987a297147	78eafe8e757	2018-08-16	Prakash Prajapati	[FIX] voip: horizontally align bottom icons in voip windows

Task-ID 1865328

a5ecd8716bdf280e2bc87c7065ef88049ac7a4da	a5ecd8716bd	2018-08-08	Christophe Matthieu	[IMP] voip/project_timesheet_synchro: adapt code for bus_service refactoring

13edfe502bb12c2c2a1eeeb6a4ab392ced42d7de	13edfe502bb	2018-07-12	qsm-odoo	[FIX] voip: restore icons' style in voip widget

Those were broken with https://github.com/odoo/enterprise/commit/3d6c7b95b94f23c6e0e0b088e3291e9bf323fc4a

a965ca0dbe0efddddc113a73d67709892455bfc6	a965ca0dbe0	2018-05-04	Alexandre Kühn	[REF] *: Adapt from JS mail refactoring

*: mail_enterprise, voip, web_studio

Adapt from changes in community (1):

    1. renamed 'chat_manager' to 'chat_service'
    2. renaming 'thread' to '_threadWidget'
    3. mail.Chatter.Buttons template with camelCased parameters
    4. renamed "chat" to "thread" at several places
    5. mailTestUtils.getMailServices() for services in tests

(1) [REF] mail: JS mail refactoring
    commit: https://github.com/odoo/odoo/commit/cd34f6de727d5b3858420cff3c9d3c5995c4e75c

bca3d65834f3faa749138394c67d0f11005734d4	bca3d65834f	2018-04-05	Nicolas Martinelli	[FIX] voip: keep mail_message_id

Properly keep `mail_message_id` when updating the phonecall.

63e9e23d57324e2458ffc00be19da56c96868f98	63e9e23d573	2018-03-30	Nicolas Martinelli	[FIX] voip: mark activity as done

When a phonecall activity is marked as done, an error occurs since we
try to write through a record which has been deleted.

opw-1827682
opw-1824648

8d011f0a263eb6aa22cdd43586b0447b5e3577f6	8d011f0a263	2018-03-19	Pierre Rousseau	[FIX] voip: remove video permission for incomming calls

Before this commit, the permission for camera was asked for incomming call, which resulted in an error if there was no camera connected.

OPW-1817655

f27626607b0e4d372a3cd943940617b9cd6d9568	f27626607b0	2018-09-27	Nicolas Martinelli	[FIX] voip: rejection failed

- Set-up callflow configurated to ring on two devices
- Receive a call, a pop-up 'Incoming call from:' is shown on both
  devices
- Answer on device 1
- Cancel on device 2

A JS traceback arises.

This traceback is done on purpose at
https://github.com/odoo/enterprise/blob/d1d79944cd3d9a76450184b42949e9bd4d2351d1/voip/static/lib/sip.js#L5788

However, the end user is not expecting such an error. Therefore, we
catch and log it.

opw-1887056

closes odoo/enterprise#2740
cf19dea77c6a6cff4956e5553ff608da1be9137f	cf19dea77c6	2018-09-24	Nicolas Martinelli	[FIX] voip: createObjectURL and MediaStream

As of Firefox 62, the URL.createObjectURL static method no longer
accepts a MediaStream object as the argument. According to the current
specs, only a Blob or MediaSource object can be accepted.

The stream argument support has been deprecated since Firefox 54.
Safari has already made the change, and Chrome may also follow soon.

Whenever you want to set a MediaStream object on a <video> or <audio>
element, the HTMLMediaElement.prototype.srcObject property should be
used instead as below:

// This no longer works
video.src = URL.createObjectURL(stream);
// Instead, do this
video.srcObject = stream;

Source:
https://www.fxsitecompat.com/en-CA/docs/2018/url-createobjecturl-no-longer-accepts-mediastream-as-argument/
https://www.chromestatus.com/features/5618491470118912

opw-1885216

closes odoo/enterprise#2706
27ca5bdcf81a32f4944b700c27e7dcbca444d02f	27ca5bdcf81	2018-03-01	Aaron Bohy	[FIX] voip: adapt code and tests

... according to community commit odoo/odoo@6be9fa396.

Related to task #30369

0056b1cd22d754f027976f24b5de7c39463a5c0f	0056b1cd22d	2017-12-21	Thibault Delavallée	[FIX] voip: feedback method should work in batch

voip inherits from mail.activity model to implement behavior linked
to phonecall activities. It inherits from the action_feedback method.
Original method has been written to allow working in batch. Override
does not respect that behavior. This commit fixes the inherit to
effectively work in batch.

This is a manual backport of a saas 11.2 commit see 8bcd90c165cabfa10e7db5b383df5ab880d6f513 .
It is backported even if it is not a real fix because it causes issues
with server action and automated actions. Those could have been done
on activities working in batch which is not the case when voip is
installed.

Done after feedback from internal migration.

78d8b0e91e9a10bdfbb9d3eef8274b4dbeae98bb	78d8b0e91e9	2017-12-21	Aaron Bohy	[REF] voip: adapt to mail js refactoring

Adapt some enterprise code from a commit in community.

Related commit: https://github.com/odoo/odoo/commit/02ec09cb1c3e2d7bc7968f40c18f2208d7f3f498

0affaa3bd0dc3a6bb3d889c605d9fa5bfa317221	0affaa3bd0d	2018-01-26	Yenthe V.G	[IMP] VOIP: remove trailing comma

Not really harmful but not needed

Closes #1724
Fixes odoo/odoo#19648
95575cc4ab1617ce84b65504cc801f7d9497d40f	95575cc4ab1	2017-11-27	Alexandre Kühn	[IMP] core: menu tip ux/ui improvement

We would like to make the "no item found" screens more appealing.

Before this commit, it shows a small help tip in the top-left
corner of the screen, just below the "Create" button.

With this commit, these help tips have been replaced by onboarding
screens, which consist of a picture and some text below, both of which
are horizontally centered.

The texts have been slightly changed, so that they are shorter and clearer.

Considered modules:

(A)
    account_batch_deposit,
    account_deferred_revenue,
    account_online_sync,
    account_reports,
    account_sepa_direct_debit
(H)
    helpdesk,
    hr_appraisal,
    hr_contract_salary
(L)
    l10n_mx_edi
(M)
    marketing_automation,
    mrp_plm,
    mrp_workorder
(P)
    pos_loyalty
(Q)
    quality,
    quality_control,
    quality_mrp
(S)
    sale_coupon,
    sale_subscription
(V)
    voip
(W)
    web_enterprise,
    web_grid,
    web_studio,
    website_calendar,
    website_crm_score,
    website_sign

43d9a0644d1f079bafb5b72cd22981a6b74a2e92	43d9a0644d1	2018-01-17	Richard Mathot	[FIX] sale_ebay,voip: disambiguate labels in settings

fcf07e83928103a459c1503efe779ab9bddc1518	fcf07e83928	2018-01-10	Rémi Rahir	[FIX] voip: refactoring hiccups

During the refactoring, sanitized version of the numbers were introduced but unused in the calls.
With the addition of a faulty parameter in res.company introduced in phone_validation this would lead
to a wrong number called.

This commit ensures that the right sanitized number is used.

--------

Also on v11, incoming calls trigger a dialog. Before this commit the behaviour would be to reject the call
when closing the dialog, whether the user chose to accept or reject the call.

This commit ensures that the reject call will only happen if the session is not 'onCall'.

aae0ddec6d490dc1c19dd2dd402d26357a1f8a87	aae0ddec6d4	2017-11-29	Thibault Delavallée	[REF] voip: use category activity type instead of new field

voip introduces a new field in order to tag some activity types as
being phonecalls. However a field is already present on the activity
type model to implement some custom behavior on activity types.

This commit fixes the voip code to use the category field instead of a
custom one. This should have been done directly when merging voip as it
was part of the original technical spec. However code review was not
performed completely, meaning this modification is done only now.

8bcd90c165cabfa10e7db5b383df5ab880d6f513	8bcd90c165c	2017-12-21	Thibault Delavallée	[FIX] voip: feedback method should work in batch

voip inherits from mail.activity model to implement behavior linked
to phonecall activities. It inherits from the action_feedback method.
Original method has been written to allow working in batch. Override
does not respect that behavior. This commit fixes the inherit to
effectively work in batch.

b6cc7d23530c314410c5efa6af13290ef9304b04	b6cc7d23530	2017-10-20	Thibault Delavallée	[REF] voip: update module to images now being in static/img

See commit https://github.com/odoo/odoo/commit/f132c8862fb3416cb53c559be32acd880c3a1c7d .

23a5dbb94b0dc88db222f8807e68b209133ad5bc	23a5dbb94b0	2017-11-16	fwi-odoo	[FIX] voip: various fixes

* Don't intercept the progress event anymore since it's handled differently from
  PBX to PBX. Instead, assume that we are in call as soon as a sip_session is
  created.
* Better handling of the display of the call/hangup buttons due to the previous
  modification.
* Alert the user when he tried to make a call and he's already in a call.

565a52a19a468a595f01a184377f235b970d6142	565a52a19a4	2017-11-14	fwi-odoo	[FIX] voip: don't assume external_phone set

86a2cb8929d18b2197af191eecdc7623851e0e8b	86a2cb8929d	2017-11-13	fwi-odoo	[FIX] voip: correctly catch onProgress events for OnSip servers

OnSip servers doesn't send anymore the reason_phrase 'Trying' or 'Ringing'.
The tests done were not necessary anymore since we only support Asterisk and
OnSip and they send only the progress event when the call reached the called
end.

6ae7caa1fbed0e357a2fe93cdf750d7a710fbe7c	6ae7caa1fbe	2017-10-18	fwi-odoo	[FIX] voip: remove soft hyphen before sending number to PBX

Soft hypen is an invisible character that need to be stripped before
sending the number to the PBX.

c2764b3a0be127c6d2c3f78659963ef68db0d2a8	c2764b3a0be	2017-10-09	fwi-odoo	[FIX] voip: format the number to be compatible with more PBX

This commit formats the number sent to the PBX since some PBX don't allow to
number with spaces or special characters.

03b03224e5deca807716af7b770b72a34f1e2439	03b03224e5d	2017-10-09	fwi-odoo	[FIX] voip: avoid phonecall duplication

Before this commit, some events create two phonecalls instead of one.

e7156aef691c73c1fd008ab43b0060650da85e19	e7156aef691	2017-10-04	fwi-odoo	[FIX] voip: correct wrong call to self.phone

cfff536c4ba60cfe9d77fae6488fdd51a707255a	cfff536c4ba	2017-09-29	fwi-odoo	[FIX] voip: refresh phonecall details even if panel closed

The previous code made the assumption that the panel was open. Then when it was
not the case, the phonecall details was not updated with the new one.

aa257ea7a98d0e3a22777e2725ea044824f9a2bb	aa257ea7a98	2017-09-25	fwi-odoo	[FIX] voip: avoid double incoming calls

This commit hangups the current call before accepting a new incoming one.

e2754325d463eb405309902cbbb54ebd78a1a4d4	e2754325d46	2017-09-13	dbh	[FIX] voip: Fix traceback on schedule activity for call

05da8d763dd7e0faa79c28605ce1910224bcb9b6	05da8d763dd	2017-09-18	fwi-odoo	[IMP] voip: open the panel when click to dial

5f5342d219b9ffbf86c47b341d8aa829be4f374b	5f5342d219b	2017-09-15	fwi-odoo	[IMP] voip: reload chatter when call activity is logged

21bf2022ab6f681df58d4210e9c20f72686cede8	21bf2022ab6	2017-09-15	fwi-odoo	[IMP] web_enterprise: add withelist class to display element in app switcher

This commit introduces a class 'o_in_appswitcher' which will whitelist the
element and let this element displayed in the app switcher.
This commit adds this class to the voip panel as well.

Fix in communiy done with the commit odoo/odoo@43e412ccabef7a04c9513d74da5436a57d7ff2ca.

0d5140df60ce76f1fe11c1009456ff598e23d4f3	0d5140df60c	2017-09-15	rde	[FIX] voip, account_batch_deposit: fix test

These 2 tests was never executed due to a bad filename.

Now voip is activated and account_batch_deposit_template commented while we
rewrite the test.

78f77882afabd0bcbcc454930cf58e053f674617	78f77882afa	2017-09-14	Xavier Morel	[FIX] voip: crap

d6f4c07f64a525096ac7b4e5ba4df7b973e9e1a7	d6f4c07f64a	2017-05-30	fwi-odoo	[IMP] voip: complete refactoring

* Delete crm_voip to only have one module voip
* Add features (tabs, mute, don't disturb mode,...)
* Use the next activities to create voip_phonecall
* Allow to click to dial from any model
* Design improvements made by CFA

b81bb97aed8712fa613e9dcdf42aaf113134dffb	b81bb97aed8	2017-03-29	fwi-odoo	[ADD] voip_onsip

New module that allow a connection to OnSIP PBX server from Odoo.

f21f66c9d2079a30170d1507cb9f8a280471d543	f21f66c9d20	2017-08-01	Josse Colpaert	[FIX] voip: not working on standard user accounts

When a user, like most normal users, does not have access to the
Settings menu, it has no access to the ir config parameters of
the voip, so he will not be able to dial (in production mode).

That is why we add a sudo in the function that gets these parameters.
That function returns those values to the web client however, so we need
to check  that the user is not a portal user.  (has the group
base.group_user)

opw-751585

4139f67445c17b642a7134f37ea8401549aab990	4139f67445c	2017-07-06	Denis Vermylen	[FIX] voip: handle appswitcher while calling

Clicking the appswitcher with VOIP removes the call-box and the <audio>
tag that plays what your correspondant says. Upon entering another app
the <audio> tag gets re-appended to the body but is no longer linked to
the audio stream.

By appending it to the <html> tag instead of the <body> it survives the
removal of the appswitcher, fixing the problem.

ca7f9ddaf22e0c75f422e6b367c3b456bc14420b	ca7f9ddaf22	2017-04-24	fwi-odoo	[FIX] voip: Monkey patch the sipjs lib due to chrome update

Since Chrome 57, the voip app was broken (more information
https://medium.com/@nimbleape/webrtc-asterisk-and-chrome-57-a706fde33780).
To fix this in stable without a lib update, we monkey patch the lib to reproduce
the commit https://github.com/onsip/SIP.js/commit/bae28258a4b705eb10239b00094985dc4baa314a

b4329abe7a0584c86853812a099db81fdeb4e0de	b4329abe7a0	2017-04-13	Nicolas Lempereur	[FIX] voip: possible error notification iphone 7

On safari iphone 7 (and possibly other browsers) we could have an error
by referencing to an undeclared Notification variable.

opw-726084

466db49a7085330d0fc08a6e36100b76da544e93	466db49a708	2017-03-07	Géry Debongnie	[REF] voip: correctly import mixins

The mixins key was removed from web.core, it is now better to directly
import web.mixins

900e55182cfa8a7c62875aa1c301de6bec947c8d	900e55182cf	2017-03-01	Aaron Bohy	[FIX] voip: this.performModelRPC not available

8d0599df2c25ffec0a87154403e1c6f634e59047	8d0599df2c2	2017-02-22	Aaron Bohy	[FIX] voip: remove useless imports

It also allows this module to be loaded in the test environment,
where the module 'web.web_client' is missing.

Also fixes some linting warnings.

07918c5096f598df365de8609208ebfa52e4f21d	07918c5096f	2017-01-05	fwi-odoo	[FIX] voip: better desktop notifications management

* When the incoming call is hanged up by the client before answering,
we need to close the desktop notification.
* Check to see if we are on the master bus was unecessary and
was disabling the desktop notification on incoming call.

035b4dafffdddfe9f3fe04d2a83ee3f1e91b6a1f	035b4dafffd	2017-01-03	fwi-odoo	[IMP] voip: use only one websocket to test the websocket validity

2b14c2129dc99cdc682d43c558f0989370368505	2b14c2129dc	2016-12-26	fwi-odoo	[FIX] voip: correctly closing the websocket after testing the parameter.

Some configurations have a limited number of websockets avalaible.
In order to avoid an unecessary websocket,
we close the websocket used to know if the parameter is correct or not.

770f39a05f4f4d91a2e4d74963a0cd4b3edb8f97	770f39a05f4	2016-12-05	fwi-odoo	[IMP] voip: avoid log in the browser console

b5b9c878fa74159a0dbd31b2bdd273cc6572c183	b5b9c878fa7	2016-08-17	Martin Trigaux	[FIX] voip: update outdate voip.pot file

Follow changes made at c8331c41

c8331c41dfd3bc12c5646818c6efe93030ec699d	c8331c41dfd	2016-08-12	fwi-odoo	[FIX] crm_voip: change fields display names and avoid 0 as ring_number

82add144fa0d25816b45a23acf0f1bc600e5adec	82add144fa0	2016-08-09	fwi-odoo	[FIX] crm_voip: settings display layout

565b539cb183a0b8521717265d9994d066b04153	565b539cb18	2016-08-09	fwi-odoo	[FIX] crm_voip: add groups on field/ICP and allow user to edit sip preferences

16960e9a2df83d2fc28f8f857bbade7d91264628	16960e9a2df	2016-07-27	fwi-odoo	[REM] voip: remove dead code

de53faf01b7f61aee70f9dff55179078b26cf1cd	de53faf01b7	2016-07-27	fwi-odoo	[MIG] voip: migrate to new api

2a549c30a9233aa705b9fa574d1b4cbc25751fac	2a549c30a92	2016-07-27	fwi-odoo	[MOV] voip: split models in multiple files

1b55fba73ecb8c9552b9b6d9390ac5217a54b88a	1b55fba73ec	2016-07-27	fwi-odoo	[MOV] voip: reorganize files

5cd6e089f2d0367de3d29402ce7bf23381406328	5cd6e089f2d	2016-06-02	fwi-odoo	[ADD] voip: keypad for direct dialing, send dtmf and incoming call notif

1bef6857a57b7233cc60b0f05bd11536bd2046d0	1bef6857a57	2016-06-09	fwi-odoo	[FIX] voip: avoid the websocket connection when in demo mode

218a1fe0f2373a42e86ae77ffc85fed2ece65b06	218a1fe0f23	2016-06-06	Yannick Tivisse	[IMP] base,sales_team: Move res_groups and menuitems to sales_team

Purpose:
Having the res_group defined in base and sales_team auto installed
with mail doens't make sense.

- Move the empty res_config class and the related view from
  base_setup to sales_team (base_setup only contains the 'General Settings'
  model and views
- Move the 'sale' related content from product to sale module (Access rights,
  menuitems,...)
- Set sales_team at autoinstall False. The module is installed when needed by
  crm or sale for example
- Set sales_team as a dependency of voip. (Access rights defined for configuration
  purpose)
- Set sales_team ad a dependency of subscription (Access rights issue too)

Rename xmlids accordingly. Example: 'base.group_sale_manager' becomes
sales_team.group_sale_manager.

870718433769140df52b814ca2d82e28c24b6a19	87071843376	2016-05-19	fwi-odoo	[FIX] voip: call options for inbound call

0f51098a78761d496b18a27b425b39c693ce02cf	0f51098a787	2016-03-10	fwi-odoo	[FIX] voip: change of remote option in the lib for reuse mediastream

73a78672dacf5d7fc47b4ef9190aa123cf68a1cf	73a78672dac	2016-01-29	fwi-odoo	[FIX] voip: update the sipjs lib to fix issues with the new Asterisk, Chrome and Firefox versions

forward port of 1d692b7d10d9ebfc8051ae11ebdf7998ff460474
New versions of Chrome and Firefox introduced a new way of managing the media
streams, which doesn't work with older version of Asterisk.
We keep the old lib to allow customers to still use it they are still using
the old versions of Asterisk, Chrome and Firefox, and they don't upgrade voip.

164e5b08436533fa98409cc7015a5c5d627dcade	164e5b08436	2015-10-07	Richard Mathot	[REM] (crm_)voip: remove modelines

b3ce056e84c20d0dbcbe52141589180efd1be56c	b3ce056e84c	2015-09-14	fwi-odoo	[FIX] crm_voip: Fix demo mode

7aeebaad0a4689b1cd9dca9f4d203fe4dff740f4	7aeebaad0a4	2015-09-02	fwi-odoo	[FIX] crm_voip: adapt to master

09d502af9f4e3842d7bd6bb0ac08f7af221b1c76	09d502af9f4	2015-08-06	Olivier Dony	[ADD] crm_voip, voip: direct port of v8 version

Only a few field and model names or inheriting views had
to be adapted to make it installable.

Completely untested otherwise.

